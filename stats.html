<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OSF 2026 – Standings</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    :root{
      --primary:#004b8d;
      --accent:#d62828;
      --bg:#f3f4f6;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top left,#e0f2fe 0,#f9fafb 45%,#e5e7eb 100%);
      color:var(--text);
    }
    .page{
      max-width:1100px;
      margin:0 auto;
      padding:24px 12px 40px;
    }
    h1{
      margin:0 0 4px;
      font-size:26px;
      letter-spacing:0.04em;
    }
    .subtitle{
      margin:0 0 12px;
      font-size:13px;
      color:var(--muted);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(37,99,235,0.08);
      color:#1d4ed8;
      font-size:12px;
      font-weight:600;
      margin-bottom:6px;
    }

    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:14px;
    }
    .tab-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
      background:rgba(15,23,42,0.02);
      padding:7px 13px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:#374151;
    }
    .tab-btn.active{
      background:#111827;
      color:#fff;
      border-color:#0f172a;
    }

    .card{
      background:var(--card);
      border-radius:16px;
      box-shadow:0 18px 40px rgba(15,23,42,0.18);
      border:1px solid rgba(148,163,184,0.4);
      padding:14px 12px 14px;
      margin-bottom:16px;
    }
    .card-header{
      font-size:14px;
      font-weight:600;
      margin-bottom:4px;
    }
    .card-sub{
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
    }

    .division-title{
      font-size:14px;
      font-weight:600;
      margin:8px 0 4px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 10px 24px rgba(15,23,42,0.08);
    }
    th,td{
      padding:6px 8px;
      border:1px solid #e5e7eb;
      text-align:right;
    }
    th{
      background:#f3f4f6;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:#6b7280;
    }
    th:first-child, td:first-child{
      text-align:left;
    }
    .pool-header{
      margin-top:10px;
      margin-bottom:4px;
      font-size:13px;
      font-weight:600;
    }
    .team-name-cell{
      display:flex;
      flex-direction:column;
    }
    .team-sub{
      font-size:10px;
      color:#6b7280;
    }

    .empty-note{
      font-size:12px;
      color:#9ca3af;
      padding:6px 2px;
    }

    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:2px;
    }
    .chip{
      border-radius:999px;
      padding:1px 6px;
      font-size:10px;
      font-weight:600;
      border:1px solid rgba(148,163,184,0.7);
      background:#f9fafb;
      color:#374151;
    }
    .chip-cross{
      border-color:#fed7aa;
      background:#fffbeb;
      color:#b45309;
    }
  </style>
</head>
<body>
<div class="page">
  <div class="badge">OSF 2026 • Standings</div>
  <h1>Pool Standings</h1>
  <p class="subtitle">
    Points are calculated from all pool-play games (including cross-pool). Each team’s points stay with their original pool.
  </p>

  <div class="tabs">
    <button class="tab-btn active" data-div="ALL">All Divisions</button>
    <button class="tab-btn" data-div="10UB">10U Boys</button>
    <button class="tab-btn" data-div="10UG">10U Girls</button>
    <button class="tab-btn" data-div="12UB">12U Boys</button>
    <button class="tab-btn" data-div="12UG">12U Girls</button>
    <button class="tab-btn" data-div="14UB">14U Boys</button>
    <button class="tab-btn" data-div="14UG">14U Girls</button>
  </div>

  <div id="statsWrapper"></div>
</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxTgz1zRnrtYvzsJraQeDKIdw5DY6-YFgs2FI87toZE7liLc1JXRgQbYcpIcmlhVczd/exec';

  const DIVISION_LABELS = {
    '10UB':'10U Boys',
    '10UG':'10U Girls',
    '12UB':'12U Boys',
    '12UG':'12U Girls',
    '14UB':'14U Boys',
    '14UG':'14U Girls'
  };

  const tabs = document.querySelectorAll('.tab-btn');
  const statsWrapper = document.getElementById('statsWrapper');

  let allTeams = [];
  let adminState = {
    manualTeams: [],
    pools: [],
    schedules: [],
    scores: {},
    dayConfigs: {}
  };

  function normalizeState(state){
    if (!state || typeof state !== 'object') state = {};
    state.manualTeams = Array.isArray(state.manualTeams) ? state.manualTeams : [];
    state.pools = Array.isArray(state.pools) ? state.pools : [];
    state.schedules = Array.isArray(state.schedules) ? state.schedules : [];
    state.scores = state.scores && typeof state.scores === 'object' ? state.scores : {};
    state.dayConfigs = state.dayConfigs && typeof state.dayConfigs === 'object' ? state.dayConfigs : {};
    return state;
  }

  function divisionLabel(code){
    return DIVISION_LABELS[code] || code || '';
  }

  function getAllTeamsCombined(){
    const manual = (adminState.manualTeams || []).map(m => Object.assign({manual:true}, m));
    return allTeams.concat(manual);
  }

  function getTeamById(id){
    if (!id && id !== 0) return null;
    id = String(id);
    return getAllTeamsCombined().find(t => String(t.id) === id) || null;
  }

  // Map teamId -> poolId (first pool wins if somehow duplicated)
  function buildTeamPoolMap(){
    const map = {};
    (adminState.pools || []).forEach(pool => {
      (pool.teamIds || []).forEach(tid => {
        const idStr = String(tid);
        if (!map[idStr]) map[idStr] = pool.id;
      });
    });
    return map;
  }

  function getScheduleForDivision(division){
    if (!Array.isArray(adminState.schedules)) return null;
    return adminState.schedules.find(s => s.division === division) || null;
  }

  // Collect only POOL-PLAY games (stage 'pool') for a division
  function collectPoolGames(division){
    const sched = getScheduleForDivision(division);
    if (!sched) return [];
    return (sched.games || []).filter(g => (g.stage || 'pool') === 'pool');
  }

  // Calculate standings for one division, grouped by pool
  function computeStandingsForDivision(division){
    const teamPoolMap = buildTeamPoolMap();
    const games = collectPoolGames(division);
    const scores = adminState.scores || {};
    const teamsCombined = getAllTeamsCombined();

    const teamStats = {}; // teamId -> stats object

    function ensureTeamStat(teamId){
      const idStr = String(teamId);
      if (!teamStats[idStr]){
        const team = getTeamById(idStr) || { teamName: 'Team', regionNumber:'', coachName:'' };
        const poolId = teamPoolMap[idStr] || null;
        teamStats[idStr] = {
          id: idStr,
          poolId,
          division,
          name: team.teamName || 'Team',
          region: team.regionNumber || '',
          coach: team.coachName || '',
          games: 0,
          wins: 0,
          draws: 0,
          losses: 0,
          goalsFor: 0,
          goalsAgainst: 0,
          goalDiff: 0,
          points: 0,
          shutouts: 0,
          bonusGoals: 0
        };
      }
      return teamStats[idStr];
    }

    games.forEach(g => {
      const s = scores[g.id];
      if (!s || (s.home == null && s.away == null)) return;

      const homeGoals = (s.home == null ? null : Number(s.home));
      const awayGoals = (s.away == null ? null : Number(s.away));
      if (homeGoals == null || awayGoals == null) return;

      const homeTeam = ensureTeamStat(g.homeId);
      const awayTeam = ensureTeamStat(g.awayId);

      // Update basic stats
      homeTeam.games++;
      awayTeam.games++;
      homeTeam.goalsFor += homeGoals;
      homeTeam.goalsAgainst += awayGoals;
      awayTeam.goalsFor += awayGoals;
      awayTeam.goalsAgainst += homeGoals;

      // Results & points
      function applyPoints(team, gf, ga){
        if (gf > ga){
          team.wins++;
          team.points += 6;
        } else if (gf === ga){
          team.draws++;
          team.points += 3;
        } else {
          team.losses++;
          // 0 points
        }
        const bonus = Math.min(gf, 3);
        team.bonusGoals += bonus;
        team.points += bonus;

        if (ga === 0 && gf > 0){
          team.shutouts++;
          team.points += 1;
        }
      }

      applyPoints(homeTeam, homeGoals, awayGoals);
      applyPoints(awayTeam, awayGoals, homeGoals);
    });

    // Finalize goal diff
    Object.values(teamStats).forEach(ts => {
      ts.goalDiff = ts.goalsFor - ts.goalsAgainst;
    });

    // Group by poolId
    const poolsById = {};
    (adminState.pools || []).forEach(p => { poolsById[p.id] = p; });

    const byPool = {};
    Object.values(teamStats).forEach(ts => {
      const pId = ts.poolId || 'UNASSIGNED';
      if (!byPool[pId]) byPool[pId] = [];
      byPool[pId].push(ts);
    });

    // Sort teams within each pool
    Object.keys(byPool).forEach(poolId => {
      byPool[poolId].sort((a,b)=>{
        if (b.points !== a.points) return b.points - a.points;
        if (b.goalDiff !== a.goalDiff) return b.goalDiff - a.goalDiff;
        if (b.goalsFor !== a.goalsFor) return b.goalsFor - a.goalsFor;
        return a.name.localeCompare(b.name);
      });
    });

    return { byPool, poolsById };
  }

  function renderDivisionStandings(division){
    statsWrapper.innerHTML = '';

    const divisionsToShow = division === 'ALL'
      ? (adminState.schedules || []).map(s => s.division)
      : [division];

    const uniqueDivs = Array.from(new Set(divisionsToShow));

    if (!uniqueDivs.length){
      statsWrapper.innerHTML = '<div class="card"><div class="empty-note">No standings available yet.</div></div>';
      return;
    }

    uniqueDivs.forEach(div => {
      const { byPool, poolsById } = computeStandingsForDivision(div);
      const poolIds = Object.keys(byPool);
      const hasStats = poolIds.some(pid => byPool[pid].length);

      const card = document.createElement('div');
      card.className = 'card';

      const header = document.createElement('div');
      header.className = 'card-header';
      header.textContent = divisionLabel(div);
      card.appendChild(header);

      if (!hasStats){
        const empty = document.createElement('div');
        empty.className = 'empty-note';
        empty.textContent = 'No scored pool-play games yet for this division.';
        card.appendChild(empty);
        statsWrapper.appendChild(card);
        return;
      }

      poolIds.forEach(poolId => {
        const teams = byPool[poolId];
        if (!teams.length) return;

        const pool = poolsById[poolId];
        const poolName = pool ? pool.name : 'Unassigned';

        const poolHeader = document.createElement('div');
        poolHeader.className = 'pool-header';
        poolHeader.textContent = poolName;
        card.appendChild(poolHeader);

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const hr = document.createElement('tr');
        ['Team','GP','W','D','L','GF','GA','GD','Pts'].forEach(h=>{
          const th = document.createElement('th');
          th.textContent = h;
          hr.appendChild(th);
        });
        thead.appendChild(hr);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        teams.forEach((ts, idx)=>{
          const tr = document.createElement('tr');

          const tdName = document.createElement('td');
          const nameWrap = document.createElement('div');
          nameWrap.className = 'team-name-cell';
          const strong = document.createElement('span');
          strong.textContent = `${idx+1}. ${ts.name}`;
          const sub = document.createElement('span');
          sub.className = 'team-sub';
          const region = ts.region ? `Region ${ts.region}` : 'Region TBD';
          const coach = ts.coach ? `Coach: ${ts.coach}` : 'Coach: TBD';
          sub.textContent = `${region} • ${coach}`;
          nameWrap.appendChild(strong);
          nameWrap.appendChild(sub);
          tdName.appendChild(nameWrap);
          tr.appendChild(tdName);

          const cols = [
            ts.games,
            ts.wins,
            ts.draws,
            ts.losses,
            ts.goalsFor,
            ts.goalsAgainst,
            ts.goalDiff,
            ts.points
          ];
          cols.forEach(val=>{
            const td=document.createElement('td');
            td.textContent = val;
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        card.appendChild(table);
      });

      statsWrapper.appendChild(card);
    });
  }

  function renderTab(div){
    tabs.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.div === div);
    });
    renderDivisionStandings(div);
  }

  async function loadData(){
    try{
      const [teamsRes,stateRes] = await Promise.all([
        fetch(API_URL),
        fetch(API_URL + '?entity=state')
      ]);
      allTeams  = await teamsRes.json();
      adminState = normalizeState(await stateRes.json());
      renderTab('ALL');
    }catch(err){
      console.error(err);
      statsWrapper.innerHTML = '<div class="card"><div class="empty-note">Unable to load standings.</div></div>';
    }
  }

  tabs.forEach(btn=>{
    btn.addEventListener('click',()=>renderTab(btn.dataset.div));
  });

  loadData();
</script>
</body>
</html>
