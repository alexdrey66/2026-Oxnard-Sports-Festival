<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OSF 2026 – Standings & Stats</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    :root{
      --primary:#004b8d;
      --accent:#d62828;
      --bg:#f3f4f6;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:#f3f4f6;
      color:var(--text);
    }
    .page{
      max-width:1100px;
      margin:0 auto;
      padding:20px 12px 40px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(37,99,235,0.08);
      color:#1d4ed8;
      font-size:11px;
      font-weight:600;
      margin-bottom:4px;
    }
    h1{
      margin:0 0 4px;
      font-size:24px;
      letter-spacing:0.03em;
    }
    .subtitle{
      margin:0 0 12px;
      font-size:13px;
      color:var(--muted);
    }

    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:12px;
    }
    .tab-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
      background:#f9fafb;
      padding:6px 13px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:#374151;
    }
    .tab-btn span.small{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:#6b7280;
    }
    .tab-btn.active{
      background:#111827;
      color:#fff;
      border-color:#0f172a;
    }

    .card{
      background:var(--card);
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.45);
      box-shadow:0 14px 30px rgba(15,23,42,0.18);
      padding:12px 12px 16px;
      margin-bottom:16px;
    }

    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:8px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .section-title{
      font-size:16px;
      font-weight:700;
      letter-spacing:0.04em;
      text-transform:uppercase;
    }
    .section-sub{
      font-size:12px;
      color:var(--muted);
    }
    .summary-tag{
      font-size:11px;
      color:#6b7280;
      text-align:right;
    }

    .pool-header{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:8px;
      margin-bottom:4px;
    }
    .pool-title{
      font-size:14px;
      font-weight:700;
      letter-spacing:0.04em;
      text-transform:uppercase;
    }
    .pool-meta{
      font-size:11px;
      color:#6b7280;
    }

    .standings-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .standings-table th,
    .standings-table td{
      border:1px solid #d1d5db;
      padding:4px 5px;
      text-align:center;
    }
    .standings-table th{
      background:#f3f4f6;
      text-transform:uppercase;
      letter-spacing:0.05em;
      font-size:10px;
      color:#6b7280;
    }
    .standings-table th.team-col,
    .standings-table td.team-col{
      text-align:left;
      padding-left:6px;
    }
    .standings-table tr:nth-child(even) td{
      background:#f9fafb;
    }
    .team-name-main{
      font-weight:600;
    }
    .team-name-sub{
      display:block;
      font-size:10px;
      color:#6b7280;
    }

    .empty{
      font-size:12px;
      color:#9ca3af;
      padding:4px 2px;
    }
    .loading{
      font-size:13px;
      color:#6b7280;
    }
    .error{
      font-size:13px;
      color:#b91c1c;
    }

    .note{
      font-size:11px;
      color:#6b7280;
      margin-top:4px;
    }
    .badge-mini{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 6px;
      border-radius:999px;
      font-size:10px;
      background:#eff6ff;
      color:#1d4ed8;
      margin-right:4px;
    }
  </style>
</head>
<body>
<div class="page">
  <div class="badge">OSF 2026 • Standings</div>
  <h1>Pool Standings & Stats</h1>
  <p class="subtitle">
    Live standings based on scores entered by tournament staff. Updated whenever the admin portal saves.
  </p>

  <!-- Division Tabs -->
  <div class="tabs" id="divisionTabs">
    <button class="tab-btn active" data-div="all">
      All Divisions
      <span class="small">overview</span>
    </button>
    <button class="tab-btn" data-div="10UB">10U Boys</button>
    <button class="tab-btn" data-div="10UG">10U Girls</button>
    <button class="tab-btn" data-div="12UB">12U Boys</button>
    <button class="tab-btn" data-div="12UG">12U Girls</button>
    <button class="tab-btn" data-div="14UB">14U Boys</button>
    <button class="tab-btn" data-div="14UG">14U Girls</button>
  </div>

  <div id="summaryLine" class="note"></div>

  <div id="statsContent">
    <div class="card">
      <div class="loading">Loading standings…</div>
    </div>
  </div>
</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxTgz1zRnrtYvzsJraQeDKIdw5DY6-YFgs2FI87toZE7liLc1JXRgQbYcpIcmlhVczd/exec';

  const DIVISION_LABELS = {
    '10UB':'10U Boys',
    '10UG':'10U Girls',
    '12UB':'12U Boys',
    '12UG':'12U Girls',
    '14UB':'14U Boys',
    '14UG':'14U Girls'
  };

  let teams = [];
  let adminState = { pools: [], schedules: [], scores: {}, manualTeams: [] };
  let activeDivision = 'all';

  const statsContent = document.getElementById('statsContent');
  const summaryLine = document.getElementById('summaryLine');

  /* ===== Helpers ===== */
  function normalizeState(state){
    if(!state || typeof state !== 'object') state = {};
    state.pools = Array.isArray(state.pools) ? state.pools : [];
    state.schedules = Array.isArray(state.schedules) ? state.schedules : [];
    state.scores = state.scores && typeof state.scores === 'object' ? state.scores : {};
    state.manualTeams = Array.isArray(state.manualTeams) ? state.manualTeams : [];
    return state;
  }

  function getTeamMap(){
    const map = {};
    teams.forEach(t=>{
      if(t && t.id) map[String(t.id)] = t;
    });
    adminState.manualTeams.forEach(m=>{
      if(m && m.id) map[String(m.id)] = m;
    });
    return map;
  }

  function getScheduleForDivision(div){
    const s = adminState.schedules.find(x=>x.division === div);
    if(!s) return {division:div,games:[],knockouts:[]};
    return {
      division:div,
      games:Array.isArray(s.games)?s.games:[],
      knockouts:Array.isArray(s.knockouts)?s.knockouts:[]
    };
  }

  function getPoolMap(){
    const map = {};
    adminState.pools.forEach(p=>{
      if(p && p.id) map[p.id] = p;
    });
    return map;
  }

  function formatTeamLabel(team){
    if(!team) return 'TBD';
    const name = team.teamName || 'Team';
    const region = team.regionNumber ? `Region ${team.regionNumber}` : '';
    const city = team.city || '';
    const state = team.state || '';
    let sub = [region, city && state ? `${city}, ${state}` : (city || state)].filter(Boolean).join(' • ');
    return {name, sub};
  }

  /* ===== Points calculation ===== */
  function addGameToStandings(standings, game, score, division){
    if(!score || score.home == null || score.away == null) return;

    const homeId = String(game.homeId);
    const awayId = String(game.awayId);
    const poolId = game.poolId || 'UNASSIGNED';

    if(!standings[poolId]) standings[poolId] = {};
    if(!standings[poolId][homeId]){
      standings[poolId][homeId] = {
        teamId: homeId,
        division,
        gp:0,w:0,l:0,t:0,
        gf:0,ga:0,gd:0,
        shutouts:0,
        pts:0
      };
    }
    if(!standings[poolId][awayId]){
      standings[poolId][awayId] = {
        teamId: awayId,
        division,
        gp:0,w:0,l:0,t:0,
        gf:0,ga:0,gd:0,
        shutouts:0,
        pts:0
      };
    }

    const home = standings[poolId][homeId];
    const away = standings[poolId][awayId];

    const hGoals = Number(score.home);
    const aGoals = Number(score.away);

    home.gp++; away.gp++;
    home.gf += hGoals; home.ga += aGoals;
    away.gf += aGoals; away.ga += hGoals;

    home.gd = home.gf - home.ga;
    away.gd = away.gf - away.ga;

    // Win/loss/tie base
    if(hGoals > aGoals){
      home.w++; away.l++;
      home.pts += 6;
    }else if(hGoals < aGoals){
      away.w++; home.l++;
      away.pts += 6;
    }else{
      home.t++; away.t++;
      home.pts += 3;
      away.pts += 3;
    }

    // Goals points (max 3)
    home.pts += Math.min(hGoals,3);
    away.pts += Math.min(aGoals,3);

    // Shutout bonus: winner gets +1 when opponent scores 0
    if(hGoals > aGoals && aGoals === 0){
      home.shutouts++;
      home.pts += 1;
    }else if(aGoals > hGoals && hGoals === 0){
      away.shutouts++;
      away.pts += 1;
    }

    // Optional deductions (if you ever store these)
    const homeDeduct = Number(score.homeDeduct || 0);
    const awayDeduct = Number(score.awayDeduct || score.deduct || 0); // flexible
    if(homeDeduct) home.pts -= homeDeduct;
    if(awayDeduct) away.pts -= awayDeduct;
  }

  /* ===== Build standings for a single division ===== */
  function buildStandingsForDivision(division){
    const standings = {}; // poolId -> teamId -> stats
    const sched = getScheduleForDivision(division);
    const games = (sched.games || []).filter(g=>!g.stage || g.stage === 'pool');
    games.forEach(g=>{
      const score = adminState.scores[g.id];
      addGameToStandings(standings, g, score, division);
    });
    return standings;
  }

  /* ===== Render helpers ===== */
  function renderPoolCard(division, poolId, teamStats, teamMap, poolMap){
    const pool = poolMap[poolId];
    const poolName = pool ? pool.name : 'Unassigned';
    const divisionLabel = DIVISION_LABELS[division] || division;

    const rows = Object.values(teamStats);
    if(!rows.length) return '';

    rows.sort((a,b)=>{
      if(b.pts !== a.pts) return b.pts - a.pts;
      if(b.gd !== a.gd) return b.gd - a.gd;
      if(b.gf !== a.gf) return b.gf - a.gf;
      const tA = teamMap[a.teamId];
      const tB = teamMap[b.teamId];
      const nA = (tA && tA.teamName) || '';
      const nB = (tB && tB.teamName) || '';
      return nA.localeCompare(nB);
    });

    let html = '<div class="card">';
    html += '<div class="pool-header">';
    html += `<div class="pool-title">Pool ${poolName}</div>`;
    html += `<div class="pool-meta">${divisionLabel}</div>`;
    html += '</div>';

    html += '<table class="standings-table">';
    html += '<thead><tr>';
    html += '<th class="team-col">Team</th>';
    html += '<th>GP</th><th>W</th><th>L</th><th>T</th>';
    html += '<th>GF</th><th>GA</th><th>GD</th>';
    html += '<th>SO</th><th>Pts</th>';
    html += '</tr></thead><tbody>';

    rows.forEach(row=>{
      const team = teamMap[row.teamId];
      const label = formatTeamLabel(team);
      html += '<tr>';
      html += `<td class="team-col"><span class="team-name-main">${label.name}</span>`;
      if(label.sub){
        html += `<span class="team-name-sub">${label.sub}</span>`;
      }
      html += '</td>';
      html += `<td>${row.gp}</td>`;
      html += `<td>${row.w}</td>`;
      html += `<td>${row.l}</td>`;
      html += `<td>${row.t}</td>`;
      html += `<td>${row.gf}</td>`;
      html += `<td>${row.ga}</td>`;
      html += `<td>${row.gd}</td>`;
      html += `<td>${row.shutouts}</td>`;
      html += `<td>${row.pts}</td>`;
      html += '</tr>';
    });

    html += '</tbody></table>';
    html += '</div>';
    return html;
  }

  /* ===== Render a single division view ===== */
  function renderDivisionView(division){
    const standings = buildStandingsForDivision(division);
    const teamMap = getTeamMap();
    const poolMap = getPoolMap();

    const poolIds = Object.keys(standings);
    if(!poolIds.length){
      statsContent.innerHTML = `
        <div class="card">
          <div class="section-header">
            <div>
              <div class="section-title">${DIVISION_LABELS[division] || division}</div>
              <div class="section-sub">Standings will appear after scores are entered.</div>
            </div>
          </div>
          <div class="empty">No completed games recorded yet for this division.</div>
        </div>`;
      summaryLine.textContent = '';
      return;
    }

    let totalGames = 0;
    Object.values(adminState.scores || {}).forEach(s=>{
      if(s && s.home != null && s.away != null) totalGames++;
    });

    let html = '';
    html += '<div class="card">';
    html += '<div class="section-header">';
    html += `<div><div class="section-title">${DIVISION_LABELS[division] || division}</div>`;
    html += '<div class="section-sub">Pool standings based on games with scores.</div></div>';
    html += `<div class="summary-tag">${poolIds.length} pool${poolIds.length===1?'':'s'}</div>`;
    html += '</div>';
    html += '</div>';

    poolIds.forEach(pid=>{
      html += renderPoolCard(division, pid, standings[pid], teamMap, poolMap);
    });

    statsContent.innerHTML = html;
    summaryLine.innerHTML =
      `<span class="badge-mini">Scoring:</span> Win = 6 pts, Tie = 3 pts, Goals = 1 pt/goal (max 3), Shutout bonus = 1 pt.`;
  }

  /* ===== Render All Divisions overview ===== */
  function renderCombinedView(){
    const teamMap = getTeamMap();
    const poolMap = getPoolMap();
    const divs = Object.keys(DIVISION_LABELS);

    let anyData = false;
    let html = '';

    divs.forEach(div=>{
      const standings = buildStandingsForDivision(div);
      const poolIds = Object.keys(standings);
      if(!poolIds.length) return;

      anyData = true;
      html += '<div class="card">';
      html += '<div class="section-header">';
      html += `<div><div class="section-title">${DIVISION_LABELS[div] || div}</div>`;
      html += '<div class="section-sub">Current pool rankings for this division.</div></div>';
      html += `<div class="summary-tag">${poolIds.length} pool${poolIds.length===1?'':'s'}</div>`;
      html += '</div>';
      html += '</div>';

      poolIds.forEach(pid=>{
        html += renderPoolCard(div, pid, standings[pid], teamMap, poolMap);
      });
    });

    if(!anyData){
      statsContent.innerHTML = `
        <div class="card">
          <div class="section-header">
            <div>
              <div class="section-title">All Divisions</div>
              <div class="section-sub">Standings will show here once scores are entered.</div>
            </div>
          </div>
          <div class="empty">No games with scores have been recorded yet.</div>
        </div>`;
      summaryLine.textContent = '';
      return;
    }

    statsContent.innerHTML = html;
    summaryLine.innerHTML =
      `<span class="badge-mini">Scoring:</span> Win = 6 pts, Tie = 3 pts, Goals = 1 pt/goal (max 3), Shutout bonus = 1 pt.`;
  }

  /* ===== Tabs / switching ===== */
  function setActiveDivision(div){
    activeDivision = div;
    document.querySelectorAll('#divisionTabs .tab-btn').forEach(btn=>{
      const d = btn.getAttribute('data-div');
      btn.classList.toggle('active', d === div);
    });
    if(div === 'all'){
      renderCombinedView();
    }else{
      renderDivisionView(div);
    }
  }

  document.querySelectorAll('#divisionTabs .tab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const d = btn.getAttribute('data-div');
      setActiveDivision(d);
    });
  });

  /* ===== Load from Apps Script ===== */
  async function loadData(){
    try{
      const [teamsRes, stateRes] = await Promise.all([
        fetch(API_URL),
        fetch(API_URL + '?entity=state')
      ]);
      teams = await teamsRes.json();
      adminState = normalizeState(await stateRes.json());
      setActiveDivision('all');
    }catch(err){
      console.error(err);
      statsContent.innerHTML = `
        <div class="card">
          <div class="error">Unable to load standings. Please try again later.</div>
        </div>`;
    }
  }

  document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
