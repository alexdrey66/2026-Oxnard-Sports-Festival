<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Game Schedules</title>

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #124175 0%, #1a5a8a 100%);
      color: #ffffff;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2.5rem 1.5rem 3rem;
      min-height: 100%;
    }

    .hero {
      border-radius: 24px;
      border: 3px solid #faca3d;
      padding: 3rem 2rem;
      text-align: center;
      margin-bottom: 2rem;
      position: relative;
    }

    .hero::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      border-radius: 28px;
      background: linear-gradient(45deg, #faca3d, #124175, #faca3d);
      opacity: 0.12;
      z-index: -1;
    }

    .hero-title {
      font-size: 3rem;
      font-weight: 900;
      margin: 0 0 .5rem;
      text-shadow: 0 3px 6px rgba(0,0,0,.4);
    }

    .hero-sub {
      margin: 0;
      font-size: 1rem;
      opacity: .9;
    }

    .tabs-shell {
      border-radius: 20px;
      border: 3px solid #faca3d;
      padding: 1.25rem 1.5rem;
      margin-bottom: 2rem;
      background: rgba(5,42,92,.9);
      box-shadow:
        0 15px 40px rgba(0,0,0,.35),
        0 4px 10px rgba(0,0,0,.4);
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
      justify-content: flex-start;
    }

    .tab {
      padding: .6rem 1.4rem;
      border-radius: 999px;
      border: 2px solid #e5e7eb;
      background: #ffffff;
      color: #124175;
      font-size: .9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all .18s ease;
      box-shadow: 0 3px 10px rgba(0,0,0,.25);
    }

    .tab:hover {
      border-color: #faca3d;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(250,202,61,.35);
    }

    .tab.active {
      background: #faca3d;
      color: #124175;
      border-color: #124175;
      box-shadow:
        0 8px 18px rgba(250,202,61,.5),
        0 2px 6px rgba(0,0,0,.4);
    }

    .tab[data-division=""] {
      background: linear-gradient(135deg,#faca3d,#f59e0b);
      color: #124175;
      border-color: #facc15;
    }

    .container-card {
      border-radius: 20px;
      border: 3px solid #faca3d;
      padding: 1.75rem 1.75rem 2rem;
      background: rgba(5,42,92,.96);
      box-shadow:
        0 18px 50px rgba(0,0,0,.5),
        0 6px 16px rgba(0,0,0,.4);
    }

    .loading-title {
      font-size: 1.4rem;
      font-weight: 800;
      margin: 0 0 .4rem;
      display: flex;
      align-items: center;
      gap: .6rem;
    }

    .loading-title::before {
      content: '';
      width: 4px;
      height: 24px;
      border-radius: 999px;
      background: #faca3d;
    }

    .help-text {
      margin: 0;
      font-size: .9rem;
      color: #e5e7eb;
      opacity: .8;
    }

    .block {
      background: #124175;
      border: 3px solid #faca3d;
      border-radius: 18px;
      padding: 1.75rem 1.5rem 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow:
        0 14px 36px rgba(0,0,0,.45),
        0 4px 12px rgba(0,0,0,.4);
      position: relative;
      overflow: hidden;
    }

    .block::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg,#faca3d,#f59e0b,#faca3d);
    }

    .block-title {
      margin: 0 0 .4rem;
      font-size: 1.3rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: .6rem;
    }

    .block-title span.tag {
      font-size: .75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .09em;
      padding: .15rem .55rem;
      border-radius: 999px;
      background: rgba(15,23,42,.6);
      border: 1px solid rgba(248,250,252,.3);
    }

    .block-sub {
      margin: 0 0 1rem;
      font-size: .85rem;
      color: #e5e7eb;
      opacity: .9;
    }

    /* Table style for each division */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: .4rem;
      background: #f9fafb;
      border-radius: 16px;
      overflow: hidden;
    }

    thead {
      background: linear-gradient(135deg,#faca3d,#f59e0b);
    }

    th, td {
      padding: .6rem .7rem;
      font-size: .85rem;
      text-align: left;
    }

    th {
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: .75rem;
      font-weight: 800;
      color: #124175;
      border-bottom: 1px solid rgba(148,163,184,.35);
    }

    tbody tr:nth-child(even) td {
      background: #f3f4f6;
    }

    tbody tr:nth-child(odd) td {
      background: #ffffff;
    }

    tbody tr:hover td {
      background: #e0f2fe;
    }

    .col-time { width: 18%; }
    .col-field { width: 12%; }
    .col-match { width: 45%; }
    .col-pool  { width: 25%; }

    .match-text {
      font-weight: 600;
      color: #111827;
    }

    .meta-pill {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      padding: .15rem .45rem;
      border-radius: 999px;
      font-size: .7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .08em;
      background: #eef2ff;
      color: #3730a3;
      border: 1px solid #c7d2fe;
    }

    .meta-pill.ko {
      background: #fef3c7;
      color: #92400e;
      border-color: #fed7aa;
    }

    .empty-msg {
      font-size: .9rem;
      color: #e5e7eb;
      opacity: .85;
    }

    @media (max-width: 768px) {
      .page { padding: 1.5rem 1rem 2rem; }
      .hero { padding: 2.25rem 1.5rem; }
      .hero-title { font-size: 2.1rem; }
      .tabs-shell { padding: 1rem 1.1rem; }
      th, td { font-size: .78rem; padding: .5rem .45rem; }
      .col-time { width: 24%; }
      .col-field { width: 18%; }
      .col-pool { width: 30%; }
    }

    @media (max-width: 520px) {
      .hero-title { font-size: 1.9rem; }
      .tabs { gap: .5rem; }
      .tab { font-size: .8rem; padding: .45rem 1.1rem; }
      .block { padding: 1.25rem 1rem 1.1rem; }
      table { font-size: .75rem; }
    }
  </style>
</head>
<body>
  <div class="page">
    <section class="hero">
      <h1 class="hero-title">Game Schedules</h1>
      <p class="hero-sub">Schedules are subject to change.</p>
    </section>

    <section class="tabs-shell">
      <div id="scheduleTabs" class="tabs">
        <button class="tab active" data-division="">All Divisions</button>
        <button class="tab" data-division="10UB">10U Boys</button>
        <button class="tab" data-division="10UG">10U Girls</button>
        <button class="tab" data-division="12UB">12U Boys</button>
        <button class="tab" data-division="12UG">12U Girls</button>
        <button class="tab" data-division="14UB">14U Boys</button>
        <button class="tab" data-division="14UG">14U Girls</button>
      </div>
    </section>

    <section id="scheduleContainer" class="container-card">
      <h2 class="loading-title">Loading schedule...</h2>
      <p class="help-text">
        If this doesn’t update, check that the admin portal and spreadsheet are published correctly.
      </p>
    </section>
  </div>

  <script>
    // Same endpoint you’re using for Admin + Stats
    const API_URL = 'https://script.google.com/macros/s/AKfycbxTgz1zRnrtYvzsJraQeDKIdw5DY6-YFgs2FI87toZE7liLc1JXRgQbYcpIcmlhVczd/exec';

    const DIVISION_LABELS = {
      "10UB": "10U Boys",
      "10UG": "10U Girls",
      "12UB": "12U Boys",
      "12UG": "12U Girls",
      "14UB": "14U Boys",
      "14UG": "14U Girls"
    };

    let allTeams = [];
    let adminState = {
      manualTeams: [],
      pools: [],
      schedules: [],
      scores: {},
      dayConfigs: {}
    };

    function normalizeState(state) {
      if (!state || typeof state !== 'object') state = {};
      state.manualTeams = Array.isArray(state.manualTeams) ? state.manualTeams : [];
      state.pools       = Array.isArray(state.pools)       ? state.pools       : [];
      state.schedules   = Array.isArray(state.schedules)   ? state.schedules   : [];
      state.scores      = state.scores && typeof state.scores === 'object' ? state.scores : {};
      state.dayConfigs  = state.dayConfigs && typeof state.dayConfigs === 'object' ? state.dayConfigs : {};
      return state;
    }

    function getAllTeamsCombined() {
      const manual = (adminState.manualTeams || []).map(m => Object.assign({ manual: true }, m));
      return (allTeams || []).concat(manual);
    }

    function getTeamById(id) {
      id = String(id);
      return getAllTeamsCombined().find(t => String(t.id) === id) || null;
    }

    function getScheduleForDivision(division) {
      const list = adminState.schedules || [];
      let sched = list.find(s => s.division === division);
      if (!sched) {
        sched = { division, games: [], knockouts: [] };
        list.push(sched);
      }
      sched.games     = Array.isArray(sched.games)     ? sched.games     : [];
      sched.knockouts = Array.isArray(sched.knockouts) ? sched.knockouts : [];
      return sched;
    }

    function stageLabel(game) {
      if (game.stage === 'pool' || !game.stage) return 'Pool Play';
      if (game.type) return game.type;
      return 'Knockout';
    }

    function poolNameForGame(game) {
      const pools = adminState.pools || [];
      const pool = pools.find(p => p.id === game.poolId);
      if (pool && pool.name) return pool.name;
      if (game.type) return game.type;
      if (game.crossPool) return 'Cross-Pool';
      return 'Unassigned';
    }

    function buildGamesForDivision(division) {
      const sched = getScheduleForDivision(division);
      const all = []
        .concat(sched.games || [])
        .concat(sched.knockouts || []);

      if (!all.length) return [];

      // Map to a consistent view model
      return all.map(g => {
        const home = getTeamById(g.homeId);
        const away = getTeamById(g.awayId);
        return {
          id: g.id,
          date: g.date || '',
          time: g.time || '',
          field: g.field || '',
          homeName: home ? (home.teamName || 'TBD') : 'TBD',
          awayName: away ? (away.teamName || 'TBD') : 'TBD',
          stage: stageLabel(g),
          pool: poolNameForGame(g)
        };
      }).sort((a, b) => {
        // Light sort: by date text, then time text, then field
        if (a.date !== b.date) return a.date.localeCompare(b.date);
        if (a.time !== b.time) return a.time.localeCompare(b.time);
        return a.field.localeCompare(b.field);
      });
    }

    function renderSchedule(divisionFilter) {
      const container = document.getElementById('scheduleContainer');
      container.innerHTML = '';

      // Find which divisions actually have schedules
      const divsInUse = new Set();
      (adminState.schedules || []).forEach(s => {
        if (s.division) divsInUse.add(s.division);
      });

      const divisions = divisionFilter
        ? [divisionFilter]
        : Array.from(divsInUse);

      if (!divisions.length) {
        container.innerHTML = `
          <h2 class="loading-title">No schedule available yet</h2>
          <p class="help-text">
            Once pool-play and knockout games are generated in the admin portal, they will appear here.
          </p>
        `;
        return;
      }

      let anyGames = false;

      divisions.forEach(div => {
        const games = buildGamesForDivision(div);
        if (!games.length) return;

        anyGames = true;

        const block = document.createElement('div');
        block.className = 'block';

        const title = document.createElement('h3');
        title.className = 'block-title';
        const label = DIVISION_LABELS[div] || div;
        title.innerHTML = `${label} <span class="tag">Game Schedule</span>`;
        block.appendChild(title);

        const sub = document.createElement('p');
        sub.className = 'block-sub';
        sub.textContent = 'Pool play and knockout games. Times and fields may change.';
        block.appendChild(sub);

        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th class="col-time">Time</th>
              <th class="col-field">Field</th>
              <th class="col-match">Match</th>
              <th class="col-pool">Pool / Round</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');

        games.forEach(g => {
          const tr = document.createElement('tr');
          const isKO = g.stage !== 'Pool Play';

          tr.innerHTML = `
            <td class="col-time">${g.date ? `${g.date} • ${g.time}` : g.time || '-'}</td>
            <td class="col-field">${g.field || '-'}</td>
            <td class="col-match">
              <span class="match-text">${g.homeName} vs ${g.awayName}</span>
            </td>
            <td class="col-pool">
              <span class="meta-pill ${isKO ? 'ko' : ''}">
                ${isKO ? g.stage : 'Pool ' + g.pool}
              </span>
            </td>
          `;
          tbody.appendChild(tr);
        });

        block.appendChild(table);
        container.appendChild(block);
      });

      if (!anyGames) {
        container.innerHTML = `
          <h2 class="loading-title">No games posted yet</h2>
          <p class="help-text">
            Games will appear here after schedules are generated and saved in the admin portal.
          </p>
        `;
      }
    }

    async function loadData() {
      const container = document.getElementById('scheduleContainer');
      try {
        const [teamsRes, stateRes] = await Promise.all([
          fetch(API_URL),
          fetch(API_URL + '?entity=state')
        ]);
        allTeams = await teamsRes.json();
        adminState = normalizeState(await stateRes.json());

        renderSchedule('');
      } catch (err) {
        console.error(err);
        container.innerHTML = `
          <h2 class="loading-title">Unable to load schedule</h2>
          <p class="help-text">
            Please refresh the page. If the problem persists, ask tournament staff to verify the admin portal and Apps Script deployment.
          </p>
        `;
      }
    }

    // Tabs wiring
    document.querySelectorAll('#scheduleTabs .tab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#scheduleTabs .tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const div = btn.getAttribute('data-division') || '';
        renderSchedule(div);
      });
    });

    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>
