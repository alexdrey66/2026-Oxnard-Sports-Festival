<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OSF 2026 – Game Schedule</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    :root{
      --primary:#004b8d;
      --accent:#d62828;
      --bg:#f3f4f6;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:#f3f4f6;
      color:var(--text);
    }
    .page{
      max-width:1100px;
      margin:0 auto;
      padding:20px 12px 40px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(37,99,235,0.08);
      color:#1d4ed8;
      font-size:11px;
      font-weight:600;
      margin-bottom:4px;
    }
    h1{
      margin:0 0 4px;
      font-size:24px;
      letter-spacing:0.03em;
    }
    .subtitle{
      margin:0 0 12px;
      font-size:13px;
      color:var(--muted);
    }

    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:12px;
    }
    .tab-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
      background:#f9fafb;
      padding:6px 13px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:#374151;
    }
    .tab-btn span.small{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:#6b7280;
    }
    .tab-btn.active{
      background:#111827;
      color:#fff;
      border-color:#0f172a;
    }

    .card{
      background:var(--card);
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.45);
      box-shadow:0 14px 30px rgba(15,23,42,0.18);
      padding:12px 12px 14px;
    }

    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:8px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .section-title{
      font-size:15px;
      font-weight:600;
    }
    .section-sub{
      font-size:12px;
      color:var(--muted);
    }

    .day-block{
      margin-bottom:14px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      overflow:hidden;
    }
    .day-header{
      padding:6px 8px;
      background:#e5f0ff;
      border-bottom:1px solid #d1d5db;
      font-size:13px;
      font-weight:600;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .day-header span.sub{
      font-size:11px;
      color:#4b5563;
      font-weight:400;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{
      padding:5px 6px;
      text-align:left;
      border-bottom:1px solid #e5e7eb;
    }
    th{
      background:#f3f4f6;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color:#6b7280;
    }
    tr:nth-child(even) td{
      background:#f9fafb;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      padding:2px 7px;
      border-radius:999px;
      background:#e5e7eb;
      font-size:11px;
      margin-right:4px;
    }
    .tag.blue{
      background:#dbeafe;
      color:#1d4ed8;
    }
    .tag.red{
      background:#fee2e2;
      color:#b91c1c;
    }

    .empty{
      font-size:12px;
      color:#9ca3af;
      padding:4px 2px;
    }

    .loading{
      font-size:13px;
      color:#6b7280;
    }

    .error{
      font-size:13px;
      color:#b91c1c;
    }
  </style>
</head>
<body>
<div class="page">
  <div class="badge">OSF 2026 • Game Schedule</div>
  <h1>Field Schedule</h1>
  <p class="subtitle">
    View by division or see all games across all fields and divisions.
  </p>

  <!-- Division Tabs -->
  <div class="tabs" id="divisionTabs">
    <button class="tab-btn active" data-div="all">
      All Divisions
      <span class="small">By field &amp; time</span>
    </button>
    <button class="tab-btn" data-div="10UB">10U Boys</button>
    <button class="tab-btn" data-div="10UG">10U Girls</button>
    <button class="tab-btn" data-div="12UB">12U Boys</button>
    <button class="tab-btn" data-div="12UG">12U Girls</button>
    <button class="tab-btn" data-div="14UB">14U Boys</button>
    <button class="tab-btn" data-div="14UG">14U Girls</button>
  </div>

  <div class="card" id="scheduleCard">
    <div class="section-header">
      <div>
        <div class="section-title" id="viewTitle">All Divisions • By Field & Time</div>
        <div class="section-sub" id="viewSubtitle">
          Includes pool-play and knockout games for every division.
        </div>
      </div>
      <div id="summaryTag" style="font-size:11px;color:#6b7280;"></div>
    </div>

    <div id="scheduleContent" class="schedule-content">
      <div class="loading">Loading schedule...</div>
    </div>
  </div>
</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxTgz1zRnrtYvzsJraQeDKIdw5DY6-YFgs2FI87toZE7liLc1JXRgQbYcpIcmlhVczd/exec';

  const DIVISION_LABELS = {
    '10UB':'10U Boys',
    '10UG':'10U Girls',
    '12UB':'12U Boys',
    '12UG':'12U Girls',
    '14UB':'14U Boys',
    '14UG':'14U Girls'
  };

  let teams = [];
  let adminState = { pools: [], schedules: [] };
  let dayOrder = [];
  let activeDivision = 'all';

  const scheduleContent = document.getElementById('scheduleContent');
  const viewTitle = document.getElementById('viewTitle');
  const viewSubtitle = document.getElementById('viewSubtitle');
  const summaryTag = document.getElementById('summaryTag');

  /* ===== Helpers ===== */

  function normalizeState(state) {
    if (!state || typeof state !== 'object') state = {};
    state.pools = Array.isArray(state.pools) ? state.pools : [];
    state.schedules = Array.isArray(state.schedules) ? state.schedules : [];
    return state;
  }

  function buildDayOrder() {
    const seen = new Set();
    const order = [];
    adminState.schedules.forEach(s => {
      const allGames = []
        .concat(s.games || [])
        .concat(s.knockouts || []);
      allGames.forEach(g => {
        if (g.date && !seen.has(g.date)) {
          seen.add(g.date);
          order.push(g.date);
        }
      });
    });
    dayOrder = order;
  }

  function dayIndex(dateLabel) {
    const idx = dayOrder.indexOf(dateLabel);
    return idx === -1 ? 999 : idx;
  }

  function timeToMinutes(t) {
    if (!t) return 9999;
    const s = String(t).trim().toLowerCase();
    const m = s.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/);
    if (!m) return 9999;
    let hour = parseInt(m[1], 10);
    let min = m[2] ? parseInt(m[2], 10) : 0;
    const ampm = m[3];
    if (ampm === 'pm' && hour < 12) hour += 12;
    if (ampm === 'am' && hour === 12) hour = 0;
    return hour * 60 + min;
  }

  function getTeamMap() {
    const map = {};
    teams.forEach(t => {
      if (t && t.id) map[String(t.id)] = t;
    });
    if (adminState.manualTeams && Array.isArray(adminState.manualTeams)) {
      adminState.manualTeams.forEach(m => {
        if (m && m.id) map[String(m.id)] = m;
      });
    }
    return map;
  }

  function getPoolMap() {
    const map = {};
    adminState.pools.forEach(p => {
      if (p && p.id) map[p.id] = p;
    });
    return map;
  }

  function getScheduleForDivision(div) {
    const found = adminState.schedules.find(s => s.division === div);
    if (!found) return { division: div, games: [], knockouts: [] };
    return {
      division: div,
      games: Array.isArray(found.games) ? found.games : [],
      knockouts: Array.isArray(found.knockouts) ? found.knockouts : []
    };
  }

  function formatTeamName(team) {
    if (!team) return 'TBD';
    return team.teamName || 'Team';
  }

  /* ===== Rendering: Division View ===== */

  function renderDivisionView(division) {
    const sched = getScheduleForDivision(division);
    const teamMap = getTeamMap();
    const poolMap = getPoolMap();

    const games = (sched.games || []).slice();
    const knockouts = (sched.knockouts || []).slice();

    if (!games.length && !knockouts.length) {
      scheduleContent.innerHTML =
        '<div class="empty">No games have been scheduled yet for this division.</div>';
      viewTitle.textContent = `${DIVISION_LABELS[division] || division}`;
      viewSubtitle.textContent = 'Pool-play and knockout games will appear here once scheduled.';
      summaryTag.textContent = '';
      return;
    }

    // sort pool games by day, time, field
    games.sort((a,b) => {
      const da = dayIndex(a.date || ''), db = dayIndex(b.date || '');
      if (da !== db) return da - db;
      const ta = timeToMinutes(a.time), tb = timeToMinutes(b.time);
      if (ta !== tb) return ta - tb;
      return (a.field || '').localeCompare(b.field || '');
    });

    // sort knockouts similarly
    knockouts.sort((a,b) => {
      const da = dayIndex(a.date || ''), db = dayIndex(b.date || '');
      if (da !== db) return da - db;
      const ta = timeToMinutes(a.time), tb = timeToMinutes(b.time);
      if (ta !== tb) return ta - tb;
      return (a.field || '').localeCompare(b.field || '');
    });

    // group by day
    const byDayPool = {};
    games.forEach(g => {
      const d = g.date || 'TBD';
      if (!byDayPool[d]) byDayPool[d] = [];
      byDayPool[d].push(g);
    });
    const byDayKO = {};
    knockouts.forEach(k => {
      const d = k.date || 'TBD';
      if (!byDayKO[d]) byDayKO[d] = [];
      byDayKO[d].push(k);
    });

    const allDays = new Set([
      ...Object.keys(byDayPool),
      ...Object.keys(byDayKO)
    ]);
    const dayArray = Array.from(allDays)
      .sort((a,b) => dayIndex(a) - dayIndex(b));

    let html = '';

    dayArray.forEach(day => {
      const poolGames = byDayPool[day] || [];
      const koGames = byDayKO[day] || [];
      const totalForDay = poolGames.length + koGames.length;

      html += `
        <div class="day-block">
          <div class="day-header">
            <div>${day}</div>
            <span class="sub">${totalForDay} game${totalForDay===1?'':'s'}</span>
          </div>
      `;

      if (poolGames.length) {
        html += `
          <table>
            <thead>
              <tr>
                <th style="width:80px;">Time</th>
                <th style="width:80px;">Field</th>
                <th style="width:80px;">Pool</th>
                <th>Home</th>
                <th>Away</th>
              </tr>
            </thead>
            <tbody>
        `;
        poolGames.forEach(g => {
          const poolName = poolMap[g.poolId]?.name || '';
          const home = teamMap[g.homeId];
          const away = teamMap[g.awayId];
          html += `
            <tr>
              <td>${g.time || ''}</td>
              <td>${g.field || ''}</td>
              <td>${poolName || '-'}</td>
              <td>${formatTeamName(home)}</td>
              <td>${formatTeamName(away)}</td>
            </tr>
          `;
        });
        html += `</tbody></table>`;
      }

      if (koGames.length) {
        html += `
          <table>
            <thead>
              <tr>
                <th style="width:80px;">Time</th>
                <th style="width:80px;">Field</th>
                <th style="width:120px;">Match</th>
                <th>Home</th>
                <th>Away</th>
              </tr>
            </thead>
            <tbody>
        `;
        koGames.forEach(k => {
          const home = teamMap[k.homeId];
          const away = teamMap[k.awayId];
          html += `
            <tr>
              <td>${k.time || ''}</td>
              <td>${k.field || ''}</td>
              <td>${k.type || 'Knockout'}</td>
              <td>${formatTeamName(home)}</td>
              <td>${formatTeamName(away)}</td>
            </tr>
          `;
        });
        html += `</tbody></table>`;
      }

      html += `</div>`;
    });

    scheduleContent.innerHTML = html;
    viewTitle.textContent = `${DIVISION_LABELS[division] || division}`;
    viewSubtitle.textContent = 'Pool-play and knockout games for this division.';
    const totalGames = games.length + knockouts.length;
    summaryTag.textContent = `${totalGames} total game${totalGames===1?'':'s'}`;
  }

  /* ===== Rendering: All Divisions Combined ===== */

  function renderCombinedView() {
    const teamMap = getTeamMap();
    const poolMap = getPoolMap();

    // Build one big list of games: pool + knockout across all divisions
    const allGames = [];

    adminState.schedules.forEach(s => {
      const division = s.division;
      (s.games || []).forEach(g => {
        allGames.push({
          kind: 'pool',
          division,
          id: g.id,
          date: g.date,
          time: g.time,
          field: g.field,
          poolId: g.poolId,
          homeId: g.homeId,
          awayId: g.awayId
        });
      });
      (s.knockouts || []).forEach(k => {
        allGames.push({
          kind: 'ko',
          division,
          id: k.id,
          date: k.date,
          time: k.time,
          field: k.field,
          type: k.type || 'Knockout',
          homeId: k.homeId,
          awayId: k.awayId
        });
      });
    });

    if (!allGames.length) {
      scheduleContent.innerHTML =
        '<div class="empty">No games have been scheduled yet.</div>';
      viewTitle.textContent = 'All Divisions • By Field & Time';
      viewSubtitle.textContent = 'Once schedules are published, all divisions will appear here.';
      summaryTag.textContent = '';
      return;
    }

    allGames.sort((a,b) => {
      const da = dayIndex(a.date || ''), db = dayIndex(b.date || '');
      if (da !== db) return da - db;
      const ta = timeToMinutes(a.time), tb = timeToMinutes(b.time);
      if (ta !== tb) return ta - tb;
      const fa = (a.field || '').toLowerCase();
      const fb = (b.field || '').toLowerCase();
      if (fa !== fb) return fa.localeCompare(fb);
      return (a.division || '').localeCompare(b.division || '');
    });

    // Group by day
    const byDay = {};
    allGames.forEach(g => {
      const d = g.date || 'TBD';
      if (!byDay[d]) byDay[d] = [];
      byDay[d].push(g);
    });

    const dayArray = Object.keys(byDay)
      .sort((a,b) => dayIndex(a) - dayIndex(b));

    let html = '';
    dayArray.forEach(day => {
      const gamesForDay = byDay[day];

      html += `
        <div class="day-block">
          <div class="day-header">
            <div>${day}</div>
            <span class="sub">${gamesForDay.length} game${gamesForDay.length===1?'':'s'}</span>
          </div>
          <table>
            <thead>
              <tr>
                <th style="width:80px;">Time</th>
                <th style="width:80px;">Field</th>
                <th style="width:80px;">Division</th>
                <th style="width:110px;">Stage</th>
                <th>Home</th>
                <th>Away</th>
                <th style="width:80px;">Pool</th>
              </tr>
            </thead>
            <tbody>
      `;

      gamesForDay.forEach(g => {
        const divisionLabel = DIVISION_LABELS[g.division] || g.division || '';
        const home = teamMap[g.homeId];
        const away = teamMap[g.awayId];
        const stageLabel = g.kind === 'pool' ? 'Pool Play' : (g.type || 'Knockout');
        const poolName = (g.kind === 'pool' && poolMap[g.poolId]) ? poolMap[g.poolId].name : '';

        html += `
          <tr>
            <td>${g.time || ''}</td>
            <td>${g.field || ''}</td>
            <td>${divisionLabel}</td>
            <td>${stageLabel}</td>
            <td>${formatTeamName(home)}</td>
            <td>${formatTeamName(away)}</td>
            <td>${poolName || '-'}</td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;
    });

    scheduleContent.innerHTML = html;
    viewTitle.textContent = 'All Divisions • By Field & Time';
    viewSubtitle.textContent = 'Pool-play and knockout games across every division.';
    summaryTag.textContent = `${allGames.length} total games`;
  }

  /* ===== Tabs / Switching Views ===== */

  function setActiveDivision(div) {
    activeDivision = div;
    document.querySelectorAll('#divisionTabs .tab-btn').forEach(btn => {
      const d = btn.getAttribute('data-div');
      btn.classList.toggle('active', d === div);
    });

    if (div === 'all') {
      renderCombinedView();
    } else {
      renderDivisionView(div);
    }
  }

  document.querySelectorAll('#divisionTabs .tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const d = btn.getAttribute('data-div');
      setActiveDivision(d);
    });
  });

  /* ===== Load data from Apps Script ===== */

  async function loadData() {
    try {
      const [teamsRes, stateRes] = await Promise.all([
        fetch(API_URL),
        fetch(API_URL + '?entity=state')
      ]);
      teams = await teamsRes.json();
      adminState = normalizeState(await stateRes.json());
      buildDayOrder();
      setActiveDivision('all'); // default view
    } catch (err) {
      console.error(err);
      scheduleContent.innerHTML =
        '<div class="error">Unable to load schedule. Please try again later.</div>';
    }
  }

  document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
