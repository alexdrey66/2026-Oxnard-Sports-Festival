<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OSF 2026 – Game Schedule</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    :root{
      --primary:#004b8d;
      --accent:#d62828;
      --bg:#f3f4f6;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --grid-border:#111827;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:#f3f4f6;
      color:var(--text);
    }
    .page{
      max-width:1100px;
      margin:0 auto;
      padding:20px 12px 40px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(37,99,235,0.08);
      color:#1d4ed8;
      font-size:11px;
      font-weight:600;
      margin-bottom:4px;
    }
    h1{
      margin:0 0 4px;
      font-size:24px;
      letter-spacing:0.03em;
    }
    .subtitle{
      margin:0 0 12px;
      font-size:13px;
      color:var(--muted);
    }

    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:12px;
    }
    .tab-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
      background:#f9fafb;
      padding:6px 13px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:#374151;
    }
    .tab-btn span.small{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:#6b7280;
    }
    .tab-btn.active{
      background:#111827;
      color:#fff;
      border-color:#0f172a;
    }

    .card{
      background:var(--card);
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.45);
      box-shadow:0 14px 30px rgba(15,23,42,0.18);
      padding:12px 12px 14px;
    }

    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:8px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .section-title{
      font-size:16px;
      font-weight:700;
      letter-spacing:0.04em;
      text-transform:uppercase;
    }
    .section-sub{
      font-size:12px;
      color:var(--muted);
    }

    .summary-tag{
      font-size:11px;
      color:#6b7280;
    }

    .grid-block{
      border:3px solid var(--grid-border);
      border-radius:6px;
      margin-bottom:16px;
      background:#fff;
      overflow:hidden;
    }

    .grid-header-main{
      padding:6px 10px;
      border-bottom:3px solid var(--grid-border);
      text-align:center;
      font-size:18px;
      font-weight:700;
      text-transform:uppercase;
    }

    .grid-sub-row{
      display:flex;
      border-bottom:2px solid var(--grid-border);
      font-size:13px;
      font-weight:600;
      text-align:center;
    }
    .grid-sub-cell{
      flex:1;
      padding:4px 6px;
      border-right:2px solid var(--grid-border);
    }
    .grid-sub-cell:last-child{
      border-right:none;
    }

    .day-label{
      font-weight:700;
    }

    .time-field-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .time-field-table th,
    .time-field-table td{
      border:2px solid var(--grid-border);
      padding:4px 6px;
      text-align:center;
    }
    .time-field-table th{
      background:#f3f4f6;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.05em;
    }
    .time-col{
      width:72px;
      font-weight:600;
    }

    .slot{
      font-weight:600;
    }
    .slot small{
      display:block;
      font-size:10px;
      font-weight:500;
      color:#4b5563;
      margin-top:2px;
    }

    .row-alt td{
      background:#e5e7eb;
    }
    .highlight td{
      background:#fff9c2;
    }

    .empty{
      font-size:12px;
      color:#9ca3af;
      padding:4px 2px;
    }
    .loading{
      font-size:13px;
      color:#6b7280;
    }
    .error{
      font-size:13px;
      color:#b91c1c;
    }

    .pool-summary{
      margin-bottom:10px;
      font-size:12px;
    }
    .pool-table{
      border-collapse:collapse;
      width:100%;
      margin-top:4px;
      font-size:12px;
    }
    .pool-table th,
    .pool-table td{
      border:1px solid #d1d5db;
      padding:3px 4px;
      text-align:left;
    }
    .pool-table th{
      background:#f3f4f6;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:#6b7280;
    }
  </style>
</head>
<body>
<div class="page">
  <div class="badge">OSF 2026 • Game Schedule</div>
  <h1>Game Schedule</h1>
  <p class="subtitle">
    View by division in a field/time grid, or see all divisions combined.
  </p>

  <!-- Division Tabs -->
  <div class="tabs" id="divisionTabs">
    <button class="tab-btn active" data-div="all">
      All Divisions
      <span class="small">Field &amp; time</span>
    </button>
    <button class="tab-btn" data-div="10UB">10U Boys</button>
    <button class="tab-btn" data-div="10UG">10U Girls</button>
    <button class="tab-btn" data-div="12UB">12U Boys</button>
    <button class="tab-btn" data-div="12UG">12U Girls</button>
    <button class="tab-btn" data-div="14UB">14U Boys</button>
    <button class="tab-btn" data-div="14UG">14U Girls</button>
  </div>

  <div class="card">
    <div class="section-header">
      <div>
        <div id="viewTitle" class="section-title">All Divisions</div>
        <div id="viewSubtitle" class="section-sub">
          All pool play & knockout games, grouped by day with a field/time grid.
        </div>
      </div>
      <div id="summaryTag" class="summary-tag"></div>
    </div>

    <div id="scheduleContent">
      <div class="loading">Loading schedule…</div>
    </div>
  </div>
</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxTgz1zRnrtYvzsJraQeDKIdw5DY6-YFgs2FI87toZE7liLc1JXRgQbYcpIcmlhVczd/exec';

  const DIVISION_LABELS = {
    '10UB':'10U Boys',
    '10UG':'10U Girls',
    '12UB':'12U Boys',
    '12UG':'12U Girls',
    '14UB':'14U Boys',
    '14UG':'14U Girls'
  };

  let teams = [];
  let adminState = { pools: [], schedules: [], manualTeams: [] };
  let dayOrder = [];
  let activeDivision = 'all';

  const scheduleContent = document.getElementById('scheduleContent');
  const viewTitle = document.getElementById('viewTitle');
  const viewSubtitle = document.getElementById('viewSubtitle');
  const summaryTag = document.getElementById('summaryTag');

  /* ========== Helpers ========== */

  function normalizeState(state){
    if(!state || typeof state !== 'object') state = {};
    state.pools = Array.isArray(state.pools) ? state.pools : [];
    state.schedules = Array.isArray(state.schedules) ? state.schedules : [];
    state.manualTeams = Array.isArray(state.manualTeams) ? state.manualTeams : [];
    return state;
  }

  function buildDayOrder(){
    const seen = new Set();
    const order = [];
    adminState.schedules.forEach(s=>{
      const games = []
        .concat(s.games || [])
        .concat(s.knockouts || []);
      games.forEach(g=>{
        if(g.date && !seen.has(g.date)){
          seen.add(g.date);
          order.push(g.date);
        }
      });
    });
    dayOrder = order;
  }
  function dayIndex(label){
    const idx = dayOrder.indexOf(label);
    return idx === -1 ? 999 : idx;
  }

  function timeToMinutes(t){
    if(!t) return 9999;
    const s = String(t).trim().toLowerCase();
    const m = s.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/);
    if(!m) return 9999;
    let hour = parseInt(m[1],10);
    let min  = m[2] ? parseInt(m[2],10) : 0;
    const ampm = m[3];
    if(ampm === 'pm' && hour < 12) hour += 12;
    if(ampm === 'am' && hour === 12) hour = 0;
    return hour*60 + min;
  }

  function getTeamMap(){
    const map = {};
    teams.forEach(t=>{
      if(t && t.id) map[String(t.id)] = t;
    });
    adminState.manualTeams.forEach(m=>{
      if(m && m.id) map[String(m.id)] = m;
    });
    return map;
  }

  function getPoolMap(){
    const map = {};
    adminState.pools.forEach(p=>{
      if(p && p.id) map[p.id] = p;
    });
    return map;
  }

  function getScheduleForDivision(div){
    const s = adminState.schedules.find(x=>x.division === div);
    if(!s) return { division:div, games:[], knockouts:[] };
    return {
      division:div,
      games:Array.isArray(s.games)?s.games:[],
      knockouts:Array.isArray(s.knockouts)?s.knockouts:[]
    };
  }

  function formatTeamName(team){
    if(!team) return 'TBD';
    return team.teamName || 'Team';
  }

  /* ========== Rendering: Division Block View ========== */

  function renderDivisionView(division){
    const sched = getScheduleForDivision(division);
    const games = (sched.games || []).slice();
    const knockouts = (sched.knockouts || []).slice();
    const teamMap = getTeamMap();

    if(!games.length && !knockouts.length){
      scheduleContent.innerHTML = '<div class="empty">No games scheduled yet for this division.</div>';
      viewTitle.textContent = DIVISION_LABELS[division] || division;
      viewSubtitle.textContent = 'Pool play and knockout games will appear once published.';
      summaryTag.textContent = '';
      return;
    }

    // Combine pool + knockout for grid display
    const all = games.map(g=>({
      kind:'pool',
      division,
      date:g.date || '',
      time:g.time || '',
      field:g.field || '',
      poolId:g.poolId,
      homeId:g.homeId,
      awayId:g.awayId,
      label:null
    })).concat(
      knockouts.map(k=>({
        kind:'ko',
        division,
        date:k.date || '',
        time:k.time || '',
        field:k.field || '',
        poolId:null,
        homeId:k.homeId,
        awayId:k.awayId,
        label:k.type || 'Knockout'
      }))
    );

    // Group by day
    const byDay = {};
    all.forEach(g=>{
      const d = g.date || 'TBD';
      if(!byDay[d]) byDay[d] = [];
      byDay[d].push(g);
    });

    const days = Object.keys(byDay).sort((a,b)=>dayIndex(a)-dayIndex(b));

    const poolMap = getPoolMap();
    const poolsForDiv = adminState.pools.filter(p=>p.division === division);

    let html = '';

    // --- Optional Pool Summary at top (simple table) ---
    if(poolsForDiv.length){
      html += '<div class="pool-summary"><strong>Pools</strong><table class="pool-table"><thead><tr><th>Pool</th><th>Teams</th></tr></thead><tbody>';
      poolsForDiv.forEach(p=>{
        const teamNames = (p.teamIds || []).map(id=>{
          const t = getTeamMap()[String(id)];
          return t ? t.teamName : null;
        }).filter(Boolean);
        html += `<tr><td>${p.name}</td><td>${teamNames.join(', ') || '-'}</td></tr>`;
      });
      html += '</tbody></table></div>';
    }

    // --- Day blocks with field/time grid ---
    days.forEach(day=>{
      const gamesForDay = byDay[day];

      // Collect unique times & fields
      const timeSet = new Set();
      const fieldSet = new Set();
      gamesForDay.forEach(g=>{
        if(g.time) timeSet.add(g.time);
        if(g.field) fieldSet.add(g.field);
      });
      const times = Array.from(timeSet).sort((a,b)=>timeToMinutes(a)-timeToMinutes(b));
      const fields = Array.from(fieldSet).sort((a,b)=>a.localeCompare(b));

      if(!times.length || !fields.length){
        return;
      }

      html += '<div class="grid-block">';
      html += `<div class="grid-header-main">${DIVISION_LABELS[division] || division} – Pool Play & Finals</div>`;
      html += `
        <div class="grid-sub-row">
          <div class="grid-sub-cell day-label">${day}</div>
          <div class="grid-sub-cell">Field Grid</div>
        </div>
      `;

      html += '<table class="time-field-table"><thead><tr>';
      html += '<th class="time-col">Time</th>';
      fields.forEach(f=>{
        html += `<th>${f}</th>`;
      });
      html += '</tr></thead><tbody>';

      times.forEach((time, idx)=>{
        const rowGames = gamesForDay.filter(g=>g.time === time);
        const rowClass = (idx % 2 === 1) ? 'row-alt' : '';
        html += `<tr class="${rowClass}"><td class="time-col">${time}</td>`;

        fields.forEach(field=>{
          const game = rowGames.find(g=>g.field === field);
          if(!game){
            html += '<td></td>';
          }else{
            const home = teamMap[game.homeId];
            const away = teamMap[game.awayId];
            const label = game.label || '';
            html += '<td>';
            html += `<div class="slot">${formatTeamName(home)} v ${formatTeamName(away)}`;
            if(label){
              html += `<small>${label}</small>`;
            }else if(game.kind === 'pool' && game.poolId && poolMap[game.poolId]){
              html += `<small>Pool ${poolMap[game.poolId].name}</small>`;
            }
            html += '</div>';
            html += '</td>';
          }
        });

        html += '</tr>';
      });

      html += '</tbody></table></div>';
    });

    scheduleContent.innerHTML = html || '<div class="empty">No games found for this division.</div>';

    viewTitle.textContent = DIVISION_LABELS[division] || division;
    viewSubtitle.textContent = 'Block view by field and time. Includes pool play and knockout games.';
    const totalGames = all.length;
    summaryTag.textContent = `${totalGames} game${totalGames===1?'':'s'}`;
  }

  /* ========== Rendering: All Divisions Combined Grid ========== */

  function renderCombinedView(){
    const teamMap = getTeamMap();
    const poolMap = getPoolMap();

    const all = [];
    adminState.schedules.forEach(s=>{
      const div = s.division;
      (s.games || []).forEach(g=>{
        all.push({
          kind:'pool',
          division:div,
          date:g.date || '',
          time:g.time || '',
          field:g.field || '',
          poolId:g.poolId,
          homeId:g.homeId,
          awayId:g.awayId,
          label:null
        });
      });
      (s.knockouts || []).forEach(k=>{
        all.push({
          kind:'ko',
          division:div,
          date:k.date || '',
          time:k.time || '',
          field:k.field || '',
          poolId:null,
          homeId:k.homeId,
          awayId:k.awayId,
          label:k.type || 'Knockout'
        });
      });
    });

    if(!all.length){
      scheduleContent.innerHTML = '<div class="empty">No games scheduled yet.</div>';
      viewTitle.textContent = 'All Divisions';
      viewSubtitle.textContent = 'Schedule will appear here once games are published.';
      summaryTag.textContent = '';
      return;
    }

    // Group by day
    const byDay = {};
    all.forEach(g=>{
      const d = g.date || 'TBD';
      if(!byDay[d]) byDay[d] = [];
      byDay[d].push(g);
    });
    const days = Object.keys(byDay).sort((a,b)=>dayIndex(a)-dayIndex(b));

    let html = '';

    days.forEach(day=>{
      const gamesForDay = byDay[day];

      const timeSet = new Set();
      const fieldSet = new Set();
      gamesForDay.forEach(g=>{
        if(g.time) timeSet.add(g.time);
        if(g.field) fieldSet.add(g.field);
      });
      const times = Array.from(timeSet).sort((a,b)=>timeToMinutes(a)-timeToMinutes(b));
      const fields = Array.from(fieldSet).sort((a,b)=>a.localeCompare(b));

      if(!times.length || !fields.length) return;

      html += '<div class="grid-block">';
      html += `<div class="grid-header-main">All Divisions – Field Schedule</div>`;
      html += `
        <div class="grid-sub-row">
          <div class="grid-sub-cell day-label">${day}</div>
          <div class="grid-sub-cell">All divisions using shared fields</div>
        </div>
      `;

      html += '<table class="time-field-table"><thead><tr>';
      html += '<th class="time-col">Time</th>';
      fields.forEach(f=>{
        html += `<th>${f}</th>`;
      });
      html += '</tr></thead><tbody>';

      times.forEach((time, idx)=>{
        const rowGames = gamesForDay.filter(g=>g.time === time);
        const rowClass = (idx % 2 === 1) ? 'row-alt' : '';
        html += `<tr class="${rowClass}"><td class="time-col">${time}</td>`;

        fields.forEach(field=>{
          const game = rowGames.find(g=>g.field === field);
          if(!game){
            html += '<td></td>';
          }else{
            const home = teamMap[game.homeId];
            const away = teamMap[game.awayId];
            const divLabel = DIVISION_LABELS[game.division] || game.division || '';
            const stageLabel = game.kind === 'pool'
              ? (game.poolId && poolMap[game.poolId] ? 'Pool ' + poolMap[game.poolId].name : 'Pool Play')
              : (game.label || 'Knockout');
            html += '<td>';
            html += `<div class="slot">${divLabel}: ${formatTeamName(home)} v ${formatTeamName(away)}<small>${stageLabel}</small></div>`;
            html += '</td>';
          }
        });

        html += '</tr>';
      });

      html += '</tbody></table></div>';
    });

    scheduleContent.innerHTML = html;
    viewTitle.textContent = 'All Divisions';
    viewSubtitle.textContent = 'Field / time grid across every division (pool play & finals).';
    summaryTag.textContent = `${all.length} game${all.length===1?'':'s'}`;
  }

  /* ========== Tabs / View Switching ========== */

  function setActiveDivision(div){
    activeDivision = div;
    document.querySelectorAll('#divisionTabs .tab-btn').forEach(btn=>{
      const d = btn.getAttribute('data-div');
      btn.classList.toggle('active', d === div);
    });
    if(div === 'all'){
      renderCombinedView();
    }else{
      renderDivisionView(div);
    }
  }

  document.querySelectorAll('#divisionTabs .tab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const d = btn.getAttribute('data-div');
      setActiveDivision(d);
    });
  });

  /* ========== Load from Apps Script ========== */

  async function loadData(){
    try{
      const [teamsRes, stateRes] = await Promise.all([
        fetch(API_URL),
        fetch(API_URL + '?entity=state')
      ]);
      teams = await teamsRes.json();
      adminState = normalizeState(await stateRes.json());
      buildDayOrder();
      setActiveDivision('all');
    }catch(err){
      console.error(err);
      scheduleContent.innerHTML =
        '<div class="error">Unable to load schedule. Please try again later.</div>';
    }
  }

  document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
