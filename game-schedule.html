<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OSF 2026 – Game Schedule</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    :root{
      --primary:#004b8d;
      --accent:#d62828;
      --bg:#f3f4f6;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top left,#e0f2fe 0,#f9fafb 45%,#e5e7eb 100%);
      color:var(--text);
    }
    .page{
      max-width:1100px;
      margin:0 auto;
      padding:24px 12px 40px;
    }
    h1{
      margin:0 0 4px;
      font-size:26px;
      letter-spacing:0.04em;
    }
    .subtitle{
      margin:0 0 12px;
      font-size:13px;
      color:var(--muted);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(37,99,235,0.08);
      color:#1d4ed8;
      font-size:12px;
      font-weight:600;
      margin-bottom:6px;
    }

    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:14px;
    }
    .tab-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
      background:rgba(15,23,42,0.02);
      padding:7px 13px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:#374151;
    }
    .tab-btn.active{
      background:#111827;
      color:#fff;
      border-color:#0f172a;
    }

    .card{
      background:var(--card);
      border-radius:16px;
      box-shadow:0 18px 40px rgba(15,23,42,0.18);
      border:1px solid rgba(148,163,184,0.4);
      padding:14px 12px 14px;
      margin-bottom:16px;
    }
    .card-header{
      font-size:14px;
      font-weight:600;
      margin-bottom:4px;
    }
    .card-sub{
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
    }

    /* Pool cards */
    .pools-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
      gap:10px;
      margin-bottom:14px;
    }
    .pool-card{
      border-radius:14px;
      border:1px solid #e5e7eb;
      background:linear-gradient(145deg,#eef2ff,#eff6ff);
      padding:8px 9px;
      font-size:12px;
    }
    .pool-name{
      font-weight:700;
      font-size:13px;
      margin-bottom:2px;
    }
    .pool-division{
      font-size:11px;
      color:#4b5563;
      margin-bottom:4px;
    }
    .pool-team{
      display:flex;
      flex-direction:column;
      padding:4px 0;
      border-top:1px solid rgba(148,163,184,0.35);
    }
    .pool-team:first-of-type{
      border-top:none;
    }
    .pool-team-name{
      font-weight:600;
      font-size:12px;
    }
    .pool-team-meta{
      font-size:11px;
      color:#6b7280;
    }

    /* Schedule tables */
    .day-block{
      margin-bottom:16px;
    }
    .day-title{
      font-weight:600;
      font-size:13px;
      margin-bottom:6px;
    }
    .schedule-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      overflow:hidden;
      border-radius:12px;
      box-shadow:0 10px 24px rgba(15,23,42,0.08);
    }
    .schedule-table th,
    .schedule-table td{
      border:1px solid #e5e7eb;
      padding:6px 8px;
      text-align:left;
      vertical-align:top;
    }
    .schedule-table th{
      background:#f3f4f6;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:#6b7280;
    }
    .time-cell{
      width:70px;
      background:#f9fafb;
      font-weight:600;
      font-size:12px;
      white-space:nowrap;
    }
    .game-cell-main{
      font-weight:600;
    }
    .game-cell{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .game-meta-line{
      font-size:11px;
      color:#6b7280;
    }
    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:1px;
    }
    .chip{
      border-radius:999px;
      padding:2px 7px;
      font-size:10px;
      font-weight:600;
      border:1px solid rgba(148,163,184,0.7);
      background:#f9fafb;
      color:#374151;
    }
    .chip-division{
      border-color:#93c5fd;
      background:#eff6ff;
      color:#1d4ed8;
    }
    .chip-cross{
      border-color:#fed7aa;
      background:#fffbeb;
      color:#b45309;
    }
    .chip-knockout{
      border-color:#fecaca;
      background:#fef2f2;
      color:#b91c1c;
    }
    .chip-pool{
      border-color:#bbf7d0;
      background:#f0fdf4;
      color:#166534;
    }

    .empty-note{
      font-size:12px;
      color:#9ca3af;
      padding:6px 2px;
    }
  </style>
</head>
<body>
<div class="page">
  <div class="badge">OSF 2026 • Game Schedule</div>
  <h1>Match Schedule</h1>
  <p class="subtitle">
    Select a division to view its games, or view all games together by field and time.
  </p>

  <div class="tabs">
    <button class="tab-btn active" data-div="ALL">All Games</button>
    <button class="tab-btn" data-div="10UB">10U Boys</button>
    <button class="tab-btn" data-div="10UG">10U Girls</button>
    <button class="tab-btn" data-div="12UB">12U Boys</button>
    <button class="tab-btn" data-div="12UG">12U Girls</button>
    <button class="tab-btn" data-div="14UB">14U Boys</button>
    <button class="tab-btn" data-div="14UG">14U Girls</button>
  </div>

  <div id="poolsWrapper"></div>
  <div id="scheduleWrapper"></div>
</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxTgz1zRnrtYvzsJraQeDKIdw5DY6-YFgs2FI87toZE7liLc1JXRgQbYcpIcmlhVczd/exec';

  const DIVISION_LABELS = {
    '10UB':'10U Boys',
    '10UG':'10U Girls',
    '12UB':'12U Boys',
    '12UG':'12U Girls',
    '14UB':'14U Boys',
    '14UG':'14U Girls'
  };

  const tabs = document.querySelectorAll('.tab-btn');
  const poolsWrapper = document.getElementById('poolsWrapper');
  const scheduleWrapper = document.getElementById('scheduleWrapper');

  let allTeams = [];
  let adminState = {
    manualTeams: [],
    pools: [],
    schedules: [],
    scores: {},
    dayConfigs: {}
  };

  function normalizeState(state){
    if (!state || typeof state !== 'object') state = {};
    state.manualTeams = Array.isArray(state.manualTeams) ? state.manualTeams : [];
    state.pools = Array.isArray(state.pools) ? state.pools : [];
    state.schedules = Array.isArray(state.schedules) ? state.schedules : [];
    state.scores = state.scores && typeof state.scores === 'object' ? state.scores : {};
    state.dayConfigs = state.dayConfigs && typeof state.dayConfigs === 'object' ? state.dayConfigs : {};
    return state;
  }

  function getAllTeamsCombined(){
    const manual = (adminState.manualTeams || []).map(m => Object.assign({manual:true}, m));
    return allTeams.concat(manual);
  }

  function getTeamById(id){
    if (!id && id !== 0) return null;
    id = String(id);
    return getAllTeamsCombined().find(t => String(t.id) === id) || null;
  }

  function divisionLabel(code){
    return DIVISION_LABELS[code] || code || '';
  }

  function getScheduleForDivision(division){
    if (!Array.isArray(adminState.schedules)) return null;
    return adminState.schedules.find(s => s.division === division) || null;
  }

  function collectGamesForDivision(division){
    const result = [];
    if (division === 'ALL'){
      (adminState.schedules || []).forEach(s => {
        const div = s.division;
        const schedGames = Array.isArray(s.games) ? s.games : [];
        const ko = Array.isArray(s.knockouts) ? s.knockouts : [];

        schedGames.forEach(g => {
          result.push(Object.assign({}, g, {
            division: div,
            stage: g.stage || 'pool'
          }));
        });

        ko.forEach(k => {
          if (!k.date || !k.time) return; // only show scheduled knockouts
          result.push({
            id: k.id,
            division: div,
            poolId: null,
            homeId: k.homeId,
            awayId: k.awayId,
            date: k.date,
            time: k.time,
            field: k.field,
            type: k.type || '',
            stage: 'knockout'
          });
        });
      });
      return result;
    }

    const sched = getScheduleForDivision(division);
    if (!sched) return [];

    const poolGames = (sched.games || []).map(g =>
      Object.assign({}, g, { division, stage: g.stage || 'pool' })
    );

    const koGames = (sched.knockouts || [])
      .filter(k => k.date && k.time)
      .map(k => ({
        id: k.id,
        division,
        poolId: null,
        homeId: k.homeId,
        awayId: k.awayId,
        date: k.date,
        time: k.time,
        field: k.field,
        type: k.type || '',
        stage: 'knockout'
      }));

    return poolGames.concat(koGames);
  }

  function renderPoolsForDivision(division){
    poolsWrapper.innerHTML = '';
    if (division === 'ALL') return; // no pools on combined view

    const pools = (adminState.pools || []).filter(p => p.division === division);
    if (!pools.length){
      poolsWrapper.innerHTML = '<div class="card"><div class="empty-note">No pools created yet for this division.</div></div>';
      return;
    }

    const allTeamsCombined = getAllTeamsCombined();
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="card-header">Pools – ${divisionLabel(division)}</div>
      <div class="card-sub">Pool assignments for this division.</div>
    `;

    const grid = document.createElement('div');
    grid.className = 'pools-grid';

    pools.forEach(pool => {
      const pCard = document.createElement('div');
      pCard.className = 'pool-card';

      const name = document.createElement('div');
      name.className = 'pool-name';
      name.textContent = pool.name || 'Pool';
      const divText = document.createElement('div');
      divText.className = 'pool-division';
      divText.textContent = divisionLabel(pool.division);
      pCard.appendChild(name);
      pCard.appendChild(divText);

      const teamIds = (pool.teamIds || []).map(String);
      const members = allTeamsCombined.filter(t => teamIds.includes(String(t.id)));

      if (!members.length){
        const empty = document.createElement('div');
        empty.className = 'pool-team-meta';
        empty.textContent = 'No teams assigned yet.';
        pCard.appendChild(empty);
      } else {
        members.forEach(t => {
          const row = document.createElement('div');
          row.className = 'pool-team';

          const top = document.createElement('div');
          top.className = 'pool-team-name';
          top.textContent = t.teamName || 'Team';

          const meta = document.createElement('div');
          meta.className = 'pool-team-meta';
          const region = t.regionNumber ? `Region ${t.regionNumber}` : 'Region TBD';
          const coach = t.coachName ? `Coach: ${t.coachName}` : 'Coach: TBD';
          meta.textContent = `${region} • ${coach}`;

          row.appendChild(top);
          row.appendChild(meta);
          pCard.appendChild(row);
        });
      }

      grid.appendChild(pCard);
    });

    card.appendChild(grid);
    poolsWrapper.appendChild(card);
  }
  function timeToMinutes(t){
    if (!t) return 24 * 60 + 1; // push empties to the end
    t = String(t).trim().toLowerCase();

    if (t === 'tbd') return 24 * 60 + 1;

    // Handles formats like:
    // 8am, 8:00am, 8:00 am, 12pm, 12:15pm, etc.
    const match = t.match(/^(\d{1,2})(?::(\d{2}))?\s*(am|pm)?$/i);
    if (!match) return 24 * 60 + 1;

    let hour = parseInt(match[1], 10);
    let minute = match[2] ? parseInt(match[2], 10) : 0;
    const mer = match[3];

    if (mer === 'pm' && hour !== 12) hour += 12;
    if (mer === 'am' && hour === 12) hour = 0;

    return hour * 60 + minute;
  }

  function renderSchedule(division){
    scheduleWrapper.innerHTML = '';

    const games = collectGamesForDivision(division);
    if (!games.length){
      scheduleWrapper.innerHTML = '<div class="card"><div class="empty-note">No games scheduled yet.</div></div>';
      return;
    }

    const poolMap = {};
    (adminState.pools || []).forEach(p => { poolMap[p.id] = p; });

    // group by date
    const byDate = {};
    games.forEach(g => {
      const dateKey = g.date || 'TBD';
      if (!byDate[dateKey]) byDate[dateKey] = [];
      byDate[dateKey].push(g);
    });

    Object.keys(byDate).forEach(dateKey => {
      const dayGames = byDate[dateKey];

      // unique fields and times
      const fields = Array.from(new Set(dayGames.map(g => g.field || 'TBD'))).sort();
      const times  = Array.from(new Set(dayGames.map(g => g.time || 'TBD'))).sort();

      const dayBlock = document.createElement('div');
      dayBlock.className = 'day-block';

      const title = document.createElement('div');
      title.className = 'day-title';
      title.textContent = dateKey === 'TBD' ? 'Date TBD' : dateKey;
      dayBlock.appendChild(title);

      const table = document.createElement('table');
      table.className = 'schedule-table';

      const thead = document.createElement('thead');
      const hr = document.createElement('tr');
      const thTime = document.createElement('th');
      thTime.textContent = 'Time';
      hr.appendChild(thTime);
      fields.forEach(f => {
        const th = document.createElement('th');
        th.textContent = f || 'Field';
        hr.appendChild(th);
      });
      thead.appendChild(hr);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      times.forEach(time => {
        const tr = document.createElement('tr');
        const tdTime = document.createElement('td');
        tdTime.className = 'time-cell';
        tdTime.textContent = time;
        tr.appendChild(tdTime);

        fields.forEach(field => {
          const td = document.createElement('td');

          const match = dayGames.find(g => (g.time || 'TBD') === time && (g.field || 'TBD') === field);
          if (match){
            const home = getTeamById(match.homeId);
            const away = getTeamById(match.awayId);

            const cell = document.createElement('div');
            cell.className = 'game-cell';

            const main = document.createElement('div');
            main.className = 'game-cell-main';

            const labelDivision = divisionLabel(match.division);
            const matchup = `${home ? home.teamName : 'TBD'} vs ${away ? away.teamName : 'TBD'}`;
            if (match.stage === 'knockout' && match.type){
              main.textContent = `${match.type}: ${matchup}`;
            } else {
              main.textContent = matchup;
            }

            const meta = document.createElement('div');
            meta.className = 'game-meta-line';
            const poolName = match.poolId && poolMap[match.poolId] ? poolMap[match.poolId].name : '';
            meta.textContent = poolName ? `${labelDivision} • ${poolName}` : labelDivision;

            const chips = document.createElement('div');
            chips.className = 'chip-row';

            const divChip = document.createElement('span');
            divChip.className = 'chip chip-division';
            divChip.textContent = labelDivision;
            chips.appendChild(divChip);

            if (poolName){
              const pChip = document.createElement('span');
              pChip.className = 'chip chip-pool';
              pChip.textContent = poolName;
              chips.appendChild(pChip);
            }

            if (match.crossPool){
              const xChip = document.createElement('span');
              xChip.className = 'chip chip-cross';
              xChip.textContent = 'Cross Pool';
              chips.appendChild(xChip);
            }

            if (match.stage === 'knockout'){
              const kChip = document.createElement('span');
              kChip.className = 'chip chip-knockout';
              kChip.textContent = 'Knockout';
              chips.appendChild(kChip);
            }

            cell.appendChild(main);
            cell.appendChild(meta);
            cell.appendChild(chips);

            td.appendChild(cell);
          } else {
            td.innerHTML = '&nbsp;';
          }

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      dayBlock.appendChild(table);
      scheduleWrapper.appendChild(dayBlock);
    });
  }

  function renderTab(division){
    tabs.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.div === division);
    });
    renderPoolsForDivision(division);
    renderSchedule(division);
  }

  async function loadData(){
    try{
      const [teamsRes,stateRes] = await Promise.all([
        fetch(API_URL),
        fetch(API_URL+'?entity=state')
      ]);
      allTeams = await teamsRes.json();
      adminState = normalizeState(await stateRes.json());
      renderTab('ALL');
    }catch(err){
      console.error(err);
      scheduleWrapper.innerHTML = '<div class="card"><div class="empty-note">Unable to load schedule.</div></div>';
    }
  }

  tabs.forEach(btn=>{
    btn.addEventListener('click',()=>renderTab(btn.dataset.div));
  });

  loadData();
</script>
</body>
</html>
