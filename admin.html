<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OSF 2026 – Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #004b8d;
      --accent:  #d62828;
      --bg:      #f3f4f6;
      --card-bg: #ffffff;
      --text:    #111827;
      --muted:   #6b7280;
      --border:  #e5e7eb;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, #dbeafe 0, #f9fafb 40%, #e5e7eb 100%);
      color: var(--text);
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    .header {
      margin-bottom: 18px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.07);
      color: #1d4ed8;
      font-size: 12px;
      font-weight: 600;
      gap: 6px;
      margin-bottom: 8px;
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #facc15;
      box-shadow: 0 0 0 4px rgba(250, 204, 21, 0.32);
    }

    h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 0.03em;
    }

    .subtitle {
      margin-top: 6px;
      color: var(--muted);
      font-size: 14px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 14px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.16);
      border: 1px solid rgba(148,163,184,0.4);
      padding: 16px 14px 12px;
      margin-bottom: 18px;
    }

    .card-title {
      font-size: 16px;
      margin: 0 0 6px;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 10px;
    }

    .login-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .login-row input {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 7px 11px;
      font-size: 13px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 13px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #1d4ed8);
      color: #ffffff;
      box-shadow: 0 12px 26px rgba(37,99,235,0.45);
    }

    .btn-small {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      margin-bottom: 3px;
    }

    .btn-approve { background: #22c55e; color: white; }
    .btn-decline { background: #ef4444; color: white; }
    .btn-pending { background: #f97316; color: white; }
    .btn-ghost {
      background: #f3f4f6;
      color: #374151;
    }

    .message {
      font-size: 12px;
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 8px;
      display: none;
    }

    .message.visible { display:block; }
    .message.success {
      background: #ecfdf3;
      border: 1px solid #22c55e;
      color: #166534;
    }
    .message.error {
      background: #fef2f2;
      border: 1px solid #ef4444;
      color: #991b1b;
    }

    /* Tabs */
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      border-bottom: 1px solid rgba(148,163,184,0.5);
      margin-bottom: 10px;
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 7px 12px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 999px 999px 0 0;
      color: #6b7280;
      font-weight: 500;
    }

    .tab-btn.active {
      background: #ffffff;
      color: #111827;
      box-shadow: 0 -1px 0 #ffffff, 0 -2px 0 #1d4ed8;
    }

    .tab-panel { display:none; }
    .tab-panel.active { display:block; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 8px;
    }

    thead { background: #f3f4f6; }

    th, td {
      padding: 7px 9px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
    }

    tbody tr:hover { background: #f9fafb; }

    .status-chip {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-pending  { background: #fef3c7; color: #92400e; }
    .status-approved { background: #dcfce7; color: #166534; }
    .status-declined { background: #fee2e2; color: #991b1b; }

    .coach-line { font-size: 11px; color: #4b5563; }
    .email-line { font-size: 11px; color: #6b7280; word-break: break-all; }

    .docs-flags {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 11px;
    }

    .docs-flag-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .docs-flag-row input[type="checkbox"] {
      width: 13px;
      height: 13px;
      cursor: pointer;
    }

    .empty-note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    .chip {
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      background:#eef2ff;
      color:#3730a3;
      font-size:11px;
      gap:4px;
    }

    .pill {
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      background:#f3f4f6;
      font-size:12px;
      gap:6px;
      margin-right:6px;
      margin-bottom:4px;
    }

    .pill span:last-child {
      font-size:11px;
      color:#6b7280;
    }

    .tag {
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:#e5e7eb;
      font-size:11px;
      margin-right:4px;
      margin-bottom:2px;
    }

    .small-input-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
      font-size:13px;
    }

    .small-input-row input,
    .small-input-row select {
      padding:6px 9px;
      border-radius:8px;
      border:1px solid var(--border);
      font-size:13px;
    }

    .small-label {
      font-size:12px;
      color:#4b5563;
      margin-bottom:2px;
    }

    .game-row {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      font-size:12px;
      padding:4px 0;
      border-bottom:1px solid #e5e7eb;
    }

    .game-row:last-child { border-bottom:none; }

    .score-input {
      width:40px;
      padding:2px 4px;
      border-radius:4px;
      border:1px solid var(--border);
      font-size:12px;
      text-align:center;
    }

    .admin-game-input {
      width:90px;
      padding:3px 5px;
      border-radius:6px;
      border:1px solid var(--border);
      font-size:11px;
    }

    .schedule-grid {
      border:1px solid #e5e7eb;
      border-radius:10px;
      overflow:hidden;
      margin-top:10px;
      background:#fff;
    }

    .schedule-grid table {
      margin:0;
      border-collapse:collapse;
      width:100%;
      font-size:12px;
    }

    .schedule-grid th,
    .schedule-grid td {
      border:1px solid #e5e7eb;
      padding:6px 6px;
      text-align:center;
    }

    .schedule-date-header {
      background:#111827;
      color:white;
      padding:6px 10px;
      font-size:13px;
      font-weight:600;
    }

    .schedule-field-header {
      background:#e5e7eb;
      font-weight:600;
      font-size:11px;
    }

    .highlight {
      background:#fef3c7;
    }

    @media (max-width: 640px) {
      .card { padding: 12px 8px 10px; }
      th:nth-child(5), td:nth-child(5) { display:none; }
    }
  </style>
</head>
<body>
<div class="page">
  <header class="header">
    <div class="badge">
      <span class="badge-dot"></span>
      Tournament Admin • OSF 2026
    </div>
    <h1>Admin – Tournament Control Center</h1>
    <p class="subtitle">
      One-stop hub to manage teams, pools, schedules, and scoring for the Oxnard Sports Festival.
    </p>
  </header>

  <!-- Login / Unlock -->
  <section class="card">
    <div class="login-row">
      <input type="password" id="adminPassword" placeholder="Admin password" />
      <button id="adminLoginBtn" class="btn btn-primary">Unlock Admin</button>
    </div>
    <div id="adminLoginMessage" class="message"></div>

    <div id="adminMain" style="display:none; margin-top:10px;">
      <div class="tabs">
        <button class="tab-btn active" data-tab="teamsTab">Teams</button>
        <button class="tab-btn" data-tab="poolsTab">Pools</button>
        <button class="tab-btn" data-tab="scheduleTab">Game Schedules</button>
        <button class="tab-btn" data-tab="scoringTab">Scoring</button>
      </div>

      <!-- TEAMS TAB -->
      <div id="teamsTab" class="tab-panel active">
        <!-- Pending & Approved -->
        <section class="card" style="margin-top:4px;">
          <h2 class="card-title">Active Teams (Pending &amp; Approved)</h2>
          <p class="card-subtitle">
            Use the checkboxes to flag documents received. Use Approve / Decline to change team status.
          </p>

          <table>
            <thead>
            <tr>
              <th>Division</th>
              <th>Region</th>
              <th>Team / Coach</th>
              <th>Docs (flags)</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody id="adminTeamsBody"></tbody>
          </table>
          <div id="activeEmpty" class="empty-note" style="display:none;">
            No pending or approved teams yet.
          </div>
        </section>

        <!-- Declined -->
        <section class="card">
          <h2 class="card-title">Declined Teams</h2>
          <p class="card-subtitle">
            Teams that have been declined. You can move them back to Pending if needed.
          </p>

          <table>
            <thead>
            <tr>
              <th>Division</th>
              <th>Region</th>
              <th>Team / Coach</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody id="declinedTeamsBody"></tbody>
          </table>
          <div id="declinedEmpty" class="empty-note" style="display:none;">
            No declined teams at this time.
          </div>
        </section>
      </div>

      <!-- POOLS TAB -->
      <div id="poolsTab" class="tab-panel">
        <section class="card" style="margin-top:4px;">
          <h2 class="card-title">Pools by Division</h2>
          <p class="card-subtitle">
            Create pools using the list of <strong>approved teams</strong> or manual placeholders.
            (Saved in this browser for now.)
          </p>

          <div class="small-input-row">
            <div>
              <div class="small-label">Division</div>
              <select id="poolDivision">
                <option value="10UB">10U Boys</option>
                <option value="10UG">10U Girls</option>
                <option value="12UB">12U Boys</option>
                <option value="12UG">12U Girls</option>
                <option value="14UB">14U Boys</option>
                <option value="14UG">14U Girls</option>
              </select>
            </div>
            <div>
              <div class="small-label">New Pool Name</div>
              <input type="text" id="poolName" placeholder="e.g., Pool A" />
            </div>
            <div style="align-self:flex-end;">
              <button class="btn btn-primary" id="createPoolBtn">Add Pool</button>
            </div>
          </div>

          <div class="small-input-row">
            <div style="flex:1; min-width:200px;">
              <div class="small-label">Manual Team (placeholder)</div>
              <input type="text" id="manualTeamName" placeholder="e.g., Reserved Spot 1" style="width:100%;" />
            </div>
            <div style="align-self:flex-end;">
              <button class="btn btn-ghost" id="addManualTeamBtn">Add Manual Team</button>
            </div>
          </div>

          <p class="small-label">Assign Teams to Pools (selected division)</p>
          <div id="poolTeamsArea" style="font-size:12px; margin-bottom:6px;">
            <span class="empty-note">Select a division with approved or manual teams to assign pools.</span>
          </div>

          <div id="poolsList"></div>
        </section>
      </div>

      <!-- SCHEDULE TAB -->
      <div id="scheduleTab" class="tab-panel">
        <section class="card" style="margin-top:4px;">
          <h2 class="card-title">Game Schedule Generator</h2>
          <p class="card-subtitle">
            Define dates, fields, and game times per division. Pool-play schedule is generated locally
            (max 3 pool-play games per team) with optional cross-pool games.
          </p>

          <div class="small-input-row">
            <div>
              <div class="small-label">Division</div>
              <select id="schedDivision">
                <option value="10UB">10U Boys</option>
                <option value="10UG">10U Girls</option>
                <option value="12UB">12U Boys</option>
                <option value="12UG">12U Girls</option>
                <option value="14UB">14U Boys</option>
                <option value="14UG">14U Girls</option>
              </select>
            </div>
            <div style="flex:1; min-width:200px;">
              <div class="small-label">Dates (comma separated)</div>
              <input type="text" id="schedDates" placeholder="Saturday (Apr 25), Sunday (Apr 26)" style="width:100%;" />
            </div>
          </div>

          <div class="small-input-row">
            <div style="flex:1; min-width:200px;">
              <div class="small-label">Fields (comma separated)</div>
              <input type="text" id="schedFields" placeholder="Field 5, Field 6" style="width:100%;" />
            </div>
            <div style="flex:1; min-width:200px;">
              <div class="small-label">Game Times (comma separated)</div>
              <input type="text" id="schedTimes" placeholder="8:00, 9:30, 11:00, 2:00, 3:30" style="width:100%;" />
            </div>
          </div>

          <div class="small-input-row">
            <label style="display:flex; align-items:center; gap:6px; font-size:12px;">
              <input type="checkbox" id="crossPoolCheckbox" />
              Generate cross-pool games (respecting 3-game max per team)
            </label>
          </div>

          <button class="btn btn-primary" id="generateScheduleBtn">Generate / Regenerate Pool-Play (local)</button>

          <div id="scheduleAdmin" style="margin-top:14px; font-size:12px;"></div>

          <hr style="margin:12px 0; border:none; border-top:1px solid #e5e7eb;" />

          <h3 class="card-title">Finals / Knockout Games (manual)</h3>
          <p class="card-subtitle">
            Add semifinals, finals, or consolation games by selecting teams. These do not affect pool standings.
          </p>

          <div class="small-input-row">
            <div>
              <div class="small-label">Stage</div>
              <select id="finalStage">
                <option value="Semi">Semi</option>
                <option value="Final">Final</option>
                <option value="Consolation">Consolation</option>
              </select>
            </div>
            <div>
              <div class="small-label">Date</div>
              <input type="text" id="finalDate" class="admin-game-input" placeholder="Sunday (Apr 26)" />
            </div>
            <div>
              <div class="small-label">Time</div>
              <input type="text" id="finalTime" class="admin-game-input" placeholder="1:00" />
            </div>
            <div>
              <div class="small-label">Field</div>
              <input type="text" id="finalField" class="admin-game-input" placeholder="Field 5" />
            </div>
          </div>

          <div class="small-input-row">
            <div>
              <div class="small-label">Home Team</div>
              <select id="finalHomeTeam" class="admin-game-input"></select>
            </div>
            <div>
              <div class="small-label">Away Team</div>
              <select id="finalAwayTeam" class="admin-game-input"></select>
            </div>
            <div style="align-self:flex-end;">
              <button class="btn btn-ghost" id="addFinalBtn">Add Knockout Game</button>
            </div>
          </div>

          <div id="finalsList" style="margin-top:8px; font-size:12px;"></div>

          <hr style="margin:14px 0; border:none; border-top:1px solid #e5e7eb;" />

          <h3 class="card-title">Parent-Facing Schedule Preview</h3>
          <p class="card-subtitle">
            Grouped by date with time down the side and fields across, similar to your printed sheets.
          </p>
          <div id="schedulePreview"></div>
        </section>
      </div>

      <!-- SCORING TAB -->
      <div id="scoringTab" class="tab-panel">
        <section class="card" style="margin-top:4px;">
          <h2 class="card-title">Scoring & Standings</h2>
          <p class="card-subtitle">
            Enter scores for pool-play games. Points use: Win 6 • Tie 3 • Loss 0 • Shutout 1 • Goals 1 each (max 3).
            You can also apply manual point deductions. Standings are grouped by pool.
          </p>

          <div class="small-input-row">
            <div>
              <div class="small-label">Division</div>
              <select id="scoreDivision">
                <option value="10UB">10U Boys</option>
                <option value="10UG">10U Girls</option>
                <option value="12UB">12U Boys</option>
                <option value="12UG">12U Girls</option>
                <option value="14UB">14U Boys</option>
                <option value="14UG">14U Girls</option>
              </select>
            </div>
            <div style="align-self:flex-end;">
              <button class="btn btn-primary" id="loadScoresBtn">Load Games</button>
            </div>
          </div>

          <div id="scoringGames" style="margin-top:6px;"></div>
          <div id="standingsOutput" style="margin-top:10px; font-size:12px;"></div>
        </section>
      </div>
    </div>
  </section>
</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycby81ycJHK0S9NUWgWuYSuHHzmz9mf2VKV_oDt4KEJv-hvSvlvOF-dxZa-AnZacewuJ8/exec';
  const ADMIN_PASSWORD = 'PLAYSOCCER';

  let teams = []; // from Apps Script
  let manualTeams = JSON.parse(localStorage.getItem('osf_manualTeams') || '[]'); // {id, division, teamName, manual:true}
  let pools = JSON.parse(localStorage.getItem('osf_pools') || '[]');             // {id, division, name, teamIds[]}
  let schedules = JSON.parse(localStorage.getItem('osf_schedules') || '[]');     // {division, games:[], finals:[]}
  let scores = JSON.parse(localStorage.getItem('osf_scores') || '{}');           // { gameId: {home, away} }
  let deductions = JSON.parse(localStorage.getItem('osf_deductions') || '{}');   // { division: { teamId: number } }

  function saveManualTeams() { localStorage.setItem('osf_manualTeams', JSON.stringify(manualTeams)); }
  function savePools()       { localStorage.setItem('osf_pools', JSON.stringify(pools)); }
  function saveSchedules()   { localStorage.setItem('osf_schedules', JSON.stringify(schedules)); }
  function saveScores()      { localStorage.setItem('osf_scores', JSON.stringify(scores)); }
  function saveDeductions()  { localStorage.setItem('osf_deductions', JSON.stringify(deductions)); }

  function divisionLabel(code) {
    return {
      '10UB': '10U Boys', '10UG': '10U Girls',
      '12UB': '12U Boys', '12UG': '12U Girls',
      '14UB': '14U Boys', '14UG': '14U Girls'
    }[code] || code || '';
  }

  function toBool(v) {
    return v === true ||
           v === 'TRUE' || v === 'true' ||
           v === 1 || v === '1' ||
           v === 'Yes' || v === 'YES' || v === 'yes';
  }

  function getAllTeams() {
    return [...teams, ...manualTeams];
  }

  function getTeamById(id) {
    return teams.find(t => String(t.id) === String(id)) ||
           manualTeams.find(t => String(t.id) === String(id)) ||
           null;
  }

  const adminLoginBtn      = document.getElementById('adminLoginBtn');
  const adminPasswordInput = document.getElementById('adminPassword');
  const adminLoginMessage  = document.getElementById('adminLoginMessage');
  const adminMain          = document.getElementById('adminMain');

  // Tabs
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');

      if (btn.dataset.tab === 'poolsTab') refreshPoolsUI();
      if (btn.dataset.tab === 'scheduleTab') {
        populateFinalTeamDropdowns();
        renderScheduleAdmin(document.getElementById('schedDivision').value);
        renderSchedulePreview(document.getElementById('schedDivision').value);
      }
    });
  });

  adminLoginBtn.addEventListener('click', async () => {
    const entered = adminPasswordInput.value.trim();
    if (entered !== ADMIN_PASSWORD) {
      adminLoginMessage.textContent = 'Incorrect password. Please try again.';
      adminLoginMessage.className = 'message visible error';
      adminMain.style.display = 'none';
      return;
    }
    adminLoginMessage.textContent = 'Admin panel unlocked.';
    adminLoginMessage.className = 'message visible success';
    adminMain.style.display = 'block';

    await loadTeamsFromApi();
    renderTeamsTables();
    refreshPoolsUI();
    populateFinalTeamDropdowns();
  });

  async function loadTeamsFromApi() {
    const res  = await fetch(API_URL);
    const data = await res.json();
    teams = Array.isArray(data) ? data : [];
  }

  /* ---------------- TEAMS TAB ---------------- */

  const adminTeamsBody     = document.getElementById('adminTeamsBody');
  const declinedTeamsBody  = document.getElementById('declinedTeamsBody');
  const activeEmpty        = document.getElementById('activeEmpty');
  const declinedEmpty      = document.getElementById('declinedEmpty');

  function renderTeamsTables() {
    adminTeamsBody.innerHTML    = '';
    declinedTeamsBody.innerHTML = '';

    const activeTeams   = teams.filter(t => (t.status || 'pending') !== 'declined');
    const declinedTeams = teams.filter(t => t.status === 'declined');

    activeEmpty.style.display   = activeTeams.length   ? 'none' : 'block';
    declinedEmpty.style.display = declinedTeams.length ? 'none' : 'block';

    // Active
    activeTeams.forEach(team => {
      const tr = document.createElement('tr');

      const tdDiv = document.createElement('td');
      tdDiv.textContent = divisionLabel(team.division);

      const tdRegion = document.createElement('td');
      tdRegion.innerHTML = `<strong>${team.regionNumber || ''}</strong>`;

      const tdTeamCoach = document.createElement('td');
      tdTeamCoach.innerHTML =
        `<strong>${team.teamName || ''}</strong><br>` +
        `<div class="coach-line">Coach: ${team.coachName || ''}</div>` +
        `<div class="email-line">${team.coachEmail || ''}</div>`;

      const tdDocs = document.createElement('td');
      tdDocs.className = 'docs-flags';

      const appRow = document.createElement('div');
      appRow.className = 'docs-flag-row';
      const appCb = document.createElement('input');
      appCb.type = 'checkbox';
      appCb.checked = toBool(team.docs_application);
      appCb.addEventListener('change', () => {
        updateDocs(team.id, { docs_application: appCb.checked, docs_roster: toBool(team.docs_roster), docs_check: toBool(team.docs_check) });
      });
      appRow.appendChild(appCb);
      appRow.appendChild(document.createElement('span')).textContent = 'Application received';

      const rosterRow = document.createElement('div');
      rosterRow.className = 'docs-flag-row';
      const rosterCb = document.createElement('input');
      rosterCb.type = 'checkbox';
      rosterCb.checked = toBool(team.docs_roster);
      rosterCb.addEventListener('change', () => {
        updateDocs(team.id, { docs_application: toBool(team.docs_application), docs_roster: rosterCb.checked, docs_check: toBool(team.docs_check) });
      });
      rosterRow.appendChild(rosterCb);
      rosterRow.appendChild(document.createElement('span')).textContent = 'Roster received';

      const checkRow = document.createElement('div');
      checkRow.className = 'docs-flag-row';
      const checkCb = document.createElement('input');
      checkCb.type = 'checkbox';
      checkCb.checked = toBool(team.docs_check);
      checkCb.addEventListener('change', () => {
        updateDocs(team.id, { docs_application: toBool(team.docs_application), docs_roster: toBool(team.docs_roster), docs_check: checkCb.checked });
      });
      checkRow.appendChild(checkCb);
      checkRow.appendChild(document.createElement('span')).textContent = 'Check received';

      tdDocs.appendChild(appRow);
      tdDocs.appendChild(rosterRow);
      tdDocs.appendChild(checkRow);

      const tdStatus = document.createElement('td');
      const chip = document.createElement('span');
      chip.classList.add('status-chip');
      const status = team.status || 'pending';
      if (status === 'approved') chip.classList.add('status-approved');
      else if (status === 'declined') chip.classList.add('status-declined');
      else chip.classList.add('status-pending');
      chip.textContent =
        status === 'approved' ? 'Approved' :
        status === 'declined' ? 'Declined' :
        'Pending';
      tdStatus.appendChild(chip);

      const tdActions = document.createElement('td');
      const btnApprove = document.createElement('button');
      btnApprove.textContent = 'Approve';
      btnApprove.className = 'btn-small btn-approve';
      btnApprove.onclick = () => updateStatus(team.id, 'approved');
      const btnDecline = document.createElement('button');
      btnDecline.textContent  = 'Decline';
      btnDecline.className    = 'btn-small btn-decline';
      btnDecline.onclick      = () => updateStatus(team.id, 'declined');
      tdActions.appendChild(btnApprove);
      tdActions.appendChild(document.createElement('br'));
      tdActions.appendChild(btnDecline);

      tr.appendChild(tdDiv);
      tr.appendChild(tdRegion);
      tr.appendChild(tdTeamCoach);
      tr.appendChild(tdDocs);
      tr.appendChild(tdStatus);
      tr.appendChild(tdActions);

      adminTeamsBody.appendChild(tr);
    });

    // Declined
    declinedTeams.forEach(team => {
      const tr = document.createElement('tr');

      const tdDiv = document.createElement('td');
      tdDiv.textContent = divisionLabel(team.division);

      const tdRegion = document.createElement('td');
      tdRegion.innerHTML = `<strong>${team.regionNumber || ''}</strong>`;

      const tdTeamCoach = document.createElement('td');
      tdTeamCoach.innerHTML =
        `<strong>${team.teamName || ''}</strong><br>` +
        `<div class="coach-line">Coach: ${team.coachName || ''}</div>` +
        `<div class="email-line">${team.coachEmail || ''}</div>`;

      const tdStatus = document.createElement('td');
      const chip = document.createElement('span');
      chip.classList.add('status-chip', 'status-declined');
      chip.textContent = 'Declined';
      tdStatus.appendChild(chip);

      const tdActions = document.createElement('td');
      const btnPending = document.createElement('button');
      btnPending.textContent = 'Move to Pending';
      btnPending.className = 'btn-small btn-pending';
      btnPending.onclick = () => updateStatus(team.id, 'pending');
      tdActions.appendChild(btnPending);

      tr.appendChild(tdDiv);
      tr.appendChild(tdRegion);
      tr.appendChild(tdTeamCoach);
      tr.appendChild(tdStatus);
      tr.appendChild(tdActions);

      declinedTeamsBody.appendChild(tr);
    });
  }

  async function postUpdate(payload) {
    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      if (!res.ok) {
        console.error('Update failed:', text);
      }
    } catch (err) {
      console.error('Network error during update:', err);
    }
  }

  async function updateStatus(id, status) {
    await postUpdate({ mode: 'update', team: { id, status } });
    await loadTeamsFromApi();
    renderTeamsTables();
    refreshPoolsUI();
    populateFinalTeamDropdowns();
  }

  async function updateDocs(id, docs) {
    await postUpdate({ mode: 'update', team: { id, ...docs } });
    await loadTeamsFromApi();
    renderTeamsTables();
  }

  /* ---------------- POOLS TAB ---------------- */

  const poolDivisionSel = document.getElementById('poolDivision');
  const poolNameInput   = document.getElementById('poolName');
  const createPoolBtn   = document.getElementById('createPoolBtn');
  const poolTeamsArea   = document.getElementById('poolTeamsArea');
  const poolsList       = document.getElementById('poolsList');
  const manualTeamNameInput = document.getElementById('manualTeamName');
  const addManualTeamBtn    = document.getElementById('addManualTeamBtn');

  createPoolBtn.addEventListener('click', () => {
    const division = poolDivisionSel.value;
    const name = poolNameInput.value.trim();
    if (!name) return;
    const id = 'pool_' + Date.now();
    pools.push({ id, division, name, teamIds: [] });
    savePools();
    poolNameInput.value = '';
    refreshPoolsUI();
  });

  addManualTeamBtn.addEventListener('click', () => {
    const division = poolDivisionSel.value;
    const name = manualTeamNameInput.value.trim();
    if (!name) return;
    const id = 'manual_' + Date.now();
    manualTeams.push({
      id,
      division,
      teamName: name,
      manual: true,
      regionNumber: '',
      coachName: '',
      coachEmail: ''
    });
    saveManualTeams();
    manualTeamNameInput.value = '';
    refreshPoolsUI();
    populateFinalTeamDropdowns();
  });

  poolDivisionSel.addEventListener('change', () => {
    refreshPoolsUI();
    populateFinalTeamDropdowns();
  });

  function assignTeamToPool(division, teamId, poolId) {
    pools.forEach(p => {
      if (p.division !== division) return;
      p.teamIds = p.teamIds.filter(id => id !== teamId);
    });
    if (poolId) {
      const pool = pools.find(p => p.id === poolId);
      if (pool && !pool.teamIds.includes(teamId)) pool.teamIds.push(teamId);
    }
    savePools();
    refreshPoolsUI();
  }

  function refreshPoolsUI() {
    const division = poolDivisionSel.value;
    const approvedTeams = getAllTeams().filter(t =>
      (t.status === 'approved' || t.manual) && t.division === division
    );

    // Team assignment chips
    poolTeamsArea.innerHTML = '';
    if (!approvedTeams.length) {
      poolTeamsArea.innerHTML = '<span class="empty-note">No approved or manual teams yet for this division.</span>';
    } else {
      approvedTeams.forEach(team => {
        const wrapper = document.createElement('div');
        wrapper.className = 'pill';
        const label = document.createElement('span');
        label.innerHTML = `<strong>${team.teamName || 'Team'}</strong>`;
        const subtitle = document.createElement('span');
        subtitle.textContent = team.manual ? 'Manual placeholder' : `Region ${team.regionNumber || ''}`;
        wrapper.appendChild(label);
        wrapper.appendChild(subtitle);

        const select = document.createElement('select');
        const poolsForDiv = pools.filter(p => p.division === division);
        const noneOpt = document.createElement('option');
        noneOpt.value = '';
        noneOpt.textContent = 'No pool';
        select.appendChild(noneOpt);
        poolsForDiv.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          if (p.teamIds.includes(String(team.id))) opt.selected = true;
          select.appendChild(opt);
        });
        select.addEventListener('change', () =>
          assignTeamToPool(division, String(team.id), select.value)
        );
        wrapper.appendChild(select);

        poolTeamsArea.appendChild(wrapper);
      });
    }

    // Pools list with edit/delete
    poolsList.innerHTML = '';
    const poolsForDiv = pools.filter(p => p.division === division);
    if (!poolsForDiv.length) {
      poolsList.innerHTML = '<div class="empty-note">No pools created for this division yet.</div>';
    } else {
      poolsForDiv.forEach(p => {
        const div = document.createElement('div');
        div.style.marginTop = '8px';

        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.alignItems = 'center';
        header.style.gap = '6px';

        const label = document.createElement('div');
        label.innerHTML = `<span class="chip">${divisionLabel(p.division)}</span> <strong>${p.name}</strong>`;
        header.appendChild(label);

        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.className = 'btn-small btn-ghost';
        editBtn.style.fontSize = '10px';
        editBtn.onclick = () => {
          const newName = prompt('New pool name:', p.name);
          if (newName && newName.trim()) {
            p.name = newName.trim();
            savePools();
            refreshPoolsUI();
          }
        };
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.className = 'btn-small btn-decline';
        delBtn.style.fontSize = '10px';
        delBtn.onclick = () => {
          if (!confirm(`Delete ${p.name}? Teams will be unassigned from this pool.`)) return;
          pools = pools.filter(x => x.id !== p.id);
          savePools();
          refreshPoolsUI();
        };
        header.appendChild(editBtn);
        header.appendChild(delBtn);

        const body = document.createElement('div');
        body.style.marginTop = '4px';
        const members = getAllTeams().filter(t => p.teamIds.includes(String(t.id)));
        if (!members.length) {
          body.innerHTML = '<span class="empty-note">No teams assigned yet.</span>';
        } else {
          members.forEach(m => {
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.textContent = m.teamName || 'Team';
            body.appendChild(tag);
          });
        }

        div.appendChild(header);
        div.appendChild(body);
        poolsList.appendChild(div);
      });
    }
  }

  function getPoolForTeam(division, teamId) {
    return pools.find(p => p.division === division && p.teamIds.includes(String(teamId))) || null;
  }

  /* ---------------- SCHEDULE TAB ---------------- */

  const schedDivisionSel = document.getElementById('schedDivision');
  const schedDatesInput  = document.getElementById('schedDates');
  const schedFieldsInput = document.getElementById('schedFields');
  const schedTimesInput  = document.getElementById('schedTimes');
  const crossPoolCheckbox = document.getElementById('crossPoolCheckbox');
  const generateScheduleBtn = document.getElementById('generateScheduleBtn');
  const scheduleAdmin   = document.getElementById('scheduleAdmin');
  const schedulePreview = document.getElementById('schedulePreview');

  const finalStageSel   = document.getElementById('finalStage');
  const finalDateInput  = document.getElementById('finalDate');
  const finalTimeInput  = document.getElementById('finalTime');
  const finalFieldInput = document.getElementById('finalField');
  const finalHomeSel    = document.getElementById('finalHomeTeam');
  const finalAwaySel    = document.getElementById('finalAwayTeam');
  const addFinalBtn     = document.getElementById('addFinalBtn');
  const finalsList      = document.getElementById('finalsList');

  schedDivisionSel.addEventListener('change', () => {
    populateFinalTeamDropdowns();
    renderScheduleAdmin(schedDivisionSel.value);
    renderSchedulePreview(schedDivisionSel.value);
  });

  function populateFinalTeamDropdowns() {
    const division = schedDivisionSel.value;
    const divTeams = getAllTeams().filter(t => t.division === division && (t.status === 'approved' || t.manual));
    [finalHomeSel, finalAwaySel].forEach(sel => {
      sel.innerHTML = '';
      const empty = document.createElement('option');
      empty.value = '';
      empty.textContent = 'Select team';
      sel.appendChild(empty);
      divTeams.forEach(t => {
        const opt = document.createElement('option');
        opt.value = String(t.id);
        opt.textContent = t.teamName || 'Team';
        sel.appendChild(opt);
      });
    });
    renderFinalsList(division);
  }

  generateScheduleBtn.addEventListener('click', () => {
    const division = schedDivisionSel.value;
    const dates = schedDatesInput.value.split(',').map(s => s.trim()).filter(Boolean);
    const fields = schedFieldsInput.value.split(',').map(s => s.trim()).filter(Boolean);
    const times  = schedTimesInput.value.split(',').map(s => s.trim()).filter(Boolean);
    const includeCrossPool = crossPoolCheckbox.checked;

    const poolsForDiv = pools.filter(p => p.division === division);
    if (!poolsForDiv.length) {
      scheduleAdmin.innerHTML = '<div class="empty-note">Create pools for this division first.</div>';
      schedulePreview.innerHTML = '';
      return;
    }
    if (!fields.length || !times.length || !dates.length) {
      scheduleAdmin.innerHTML = '<div class="empty-note">Enter at least one date, field, and game time.</div>';
      schedulePreview.innerHTML = '';
      return;
    }

    const games = [];
    const gameCounts = {}; // teamId -> #pool games

    function addGame(poolId, poolName, homeId, awayId) {
      const hCount = gameCounts[homeId] || 0;
      const aCount = gameCounts[awayId] || 0;
      if (hCount >= 3 || aCount >= 3) return; // respect 3-game max
      const id = `${division}_${poolId}_g${games.length + 1}`;
      games.push({
        id,
        division,
        poolId,
        poolName,
        homeId,
        awayId,
        stage: 'pool'
      });
      gameCounts[homeId] = hCount + 1;
      gameCounts[awayId] = aCount + 1;
    }

    // Basic round robin within each pool
    poolsForDiv.forEach(pool => {
      const poolTeams = getAllTeams().filter(t => pool.teamIds.includes(String(t.id)));
      for (let i = 0; i < poolTeams.length; i++) {
        for (let j = i + 1; j < poolTeams.length; j++) {
          addGame(pool.id, pool.name, String(poolTeams[i].id), String(poolTeams[j].id));
        }
      }
    });

    // Optional cross-pool games, still respecting 3-game max
    if (includeCrossPool && poolsForDiv.length > 1) {
      const allPoolTeams = poolsForDiv.map(p =>
        getAllTeams().filter(t => p.teamIds.includes(String(t.id))).map(t => ({ pool: p, team: t }))
      ).flat();

      for (let i = 0; i < allPoolTeams.length; i++) {
        for (let j = i + 1; j < allPoolTeams.length; j++) {
          const a = allPoolTeams[i];
          const b = allPoolTeams[j];
          if (a.pool.id === b.pool.id) continue;
          addGame('xpool', `${a.pool.name} vs ${b.pool.name}`, String(a.team.id), String(b.team.id));
        }
      }
    }

    // Assign date/field/time slots
    const slots = [];
    dates.forEach(d => {
      fields.forEach(f => {
        times.forEach(t => {
          slots.push({ date: d, field: f, time: t });
        });
      });
    });
    games.forEach((g, idx) => {
      const slot = slots[idx % slots.length];
      g.date  = slot.date;
      g.field = slot.field;
      g.time  = slot.time;
    });

    // Save into schedules (keep existing finals)
    const existing = schedules.find(s => s.division === division);
    const finals = existing && existing.finals ? existing.finals : [];
    const sched = { division, games, finals };
    schedules = schedules.filter(s => s.division !== division);
    schedules.push(sched);
    saveSchedules();

    renderScheduleAdmin(division);
    renderSchedulePreview(division);
  });

  function renderScheduleAdmin(division) {
    const sched = schedules.find(s => s.division === division);
    scheduleAdmin.innerHTML = '';
    if (!sched || !sched.games.length) {
      scheduleAdmin.innerHTML = '<div class="empty-note">No pool-play schedule yet for this division.</div>';
      return;
    }

    const container = document.createElement('div');
    container.innerHTML = '<strong>Pool-Play Games (Admin View)</strong>';
    sched.games.forEach(g => {
      const home = getTeamById(g.homeId);
      const away = getTeamById(g.awayId);
      const row = document.createElement('div');
      row.className = 'game-row';

      const label = document.createElement('span');
      label.innerHTML = `<strong>${g.poolName || getPoolForTeam(division, g.homeId)?.name || 'Pool'}</strong> – ${(home && home.teamName) || 'Team'} vs ${(away && away.teamName) || 'Team'}`;
      row.appendChild(label);

      const dateInput = document.createElement('input');
      dateInput.className = 'admin-game-input';
      dateInput.value = g.date || '';
      dateInput.placeholder = 'Date';
      dateInput.addEventListener('change', () => {
        g.date = dateInput.value;
        saveSchedules();
        renderSchedulePreview(division);
      });

      const timeInput = document.createElement('input');
      timeInput.className = 'admin-game-input';
      timeInput.value = g.time || '';
      timeInput.placeholder = 'Time';
      timeInput.addEventListener('change', () => {
        g.time = timeInput.value;
        saveSchedules();
        renderSchedulePreview(division);
      });

      const fieldInput = document.createElement('input');
      fieldInput.className = 'admin-game-input';
      fieldInput.value = g.field || '';
      fieldInput.placeholder = 'Field';
      fieldInput.addEventListener('change', () => {
        g.field = fieldInput.value;
        saveSchedules();
        renderSchedulePreview(division);
      });

      row.appendChild(dateInput);
      row.appendChild(timeInput);
      row.appendChild(fieldInput);

      container.appendChild(row);
    });

    scheduleAdmin.appendChild(container);
  }

  addFinalBtn.addEventListener('click', () => {
    const division = schedDivisionSel.value;
    const stage = finalStageSel.value;
    const date  = finalDateInput.value.trim();
    const time  = finalTimeInput.value.trim();
    const field = finalFieldInput.value.trim();
    const homeId = finalHomeSel.value;
    const awayId = finalAwaySel.value;

    if (!homeId || !awayId || homeId === awayId) {
      alert('Select two different teams.');
      return;
    }

    const existing = schedules.find(s => s.division === division) || { division, games: [], finals: [] };
    const finalsArr = existing.finals || [];
    const id = `${division}_final_${finalsArr.length + 1}`;
    finalsArr.push({ id, division, stage, date, time, field, homeId, awayId, stageType: 'final' });

    const schedIdx = schedules.findIndex(s => s.division === division);
    if (schedIdx >= 0) {
      schedules[schedIdx].finals = finalsArr;
    } else {
      schedules.push({ division, games: [], finals: finalsArr });
    }
    saveSchedules();
    renderFinalsList(division);
  });

  function renderFinalsList(division) {
    finalsList.innerHTML = '';
    const sched = schedules.find(s => s.division === division);
    if (!sched || !sched.finals || !sched.finals.length) {
      finalsList.innerHTML = '<div class="empty-note">No knockout games added yet.</div>';
      return;
    }
    sched.finals.forEach(f => {
      const home = getTeamById(f.homeId);
      const away = getTeamById(f.awayId);
      const row = document.createElement('div');
      row.className = 'game-row';
      row.textContent = `${f.stage}: ${f.date || ''} ${f.time || ''} @ ${f.field || ''} – ${(home && home.teamName) || 'Team'} vs ${(away && away.teamName) || 'Team'}`;
      finalsList.appendChild(row);
    });
  }

  function renderSchedulePreview(division) {
    const sched = schedules.find(s => s.division === division);
    schedulePreview.innerHTML = '';
    if (!sched || !sched.games.length) {
      schedulePreview.innerHTML = '<div class="empty-note">No pool-play schedule yet for this division.</div>';
      return;
    }

    const games = sched.games.filter(g => g.stage === 'pool');
    const dates = [...new Set(games.map(g => g.date || ''))].filter(Boolean);

    dates.forEach(date => {
      const block = document.createElement('div');
      block.className = 'schedule-grid';
      const header = document.createElement('div');
      header.className = 'schedule-date-header';
      header.textContent = `${divisionLabel(division)} – ${date}`;
      block.appendChild(header);

      const fields = [...new Set(games.filter(g => g.date === date).map(g => g.field || 'Field'))];
      const times  = [...new Set(games.filter(g => g.date === date).map(g => g.time || ''))];

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      const thTime = document.createElement('th');
      thTime.textContent = 'Time';
      headRow.appendChild(thTime);
      fields.forEach(f => {
        const th = document.createElement('th');
        th.textContent = f;
        th.className = 'schedule-field-header';
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      times.forEach(t => {
        const tr = document.createElement('tr');
        const tdTime = document.createElement('td');
        tdTime.textContent = t;
        tr.appendChild(tdTime);

        fields.forEach(f => {
          const td = document.createElement('td');
          const g = games.find(x => x.date === date && x.time === t && x.field === f);
          if (g) {
            const home = getTeamById(g.homeId);
            const away = getTeamById(g.awayId);
            td.innerHTML = `<span class="highlight">${(home && home.teamName) || 'Team'} vs ${(away && away.teamName) || 'Team'}</span><br><span style="font-size:10px;">${getPoolForTeam(division,g.homeId)?.name || g.poolName || ''}</span>`;
          } else {
            td.textContent = '';
          }
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      block.appendChild(table);

      schedulePreview.appendChild(block);
    });
  }

  /* ---------------- SCORING TAB ---------------- */

  const scoreDivisionSel = document.getElementById('scoreDivision');
  const loadScoresBtn    = document.getElementById('loadScoresBtn');
  const scoringGamesDiv  = document.getElementById('scoringGames');
  const standingsOutput  = document.getElementById('standingsOutput');

  loadScoresBtn.addEventListener('click', () => {
    const division = scoreDivisionSel.value;
    renderScoringGames(division);
  });

  function renderScoringGames(division) {
    const sched = schedules.find(s => s.division === division);
    scoringGamesDiv.innerHTML = '';
    standingsOutput.innerHTML = '';

    if (!sched || !sched.games.length) {
      scoringGamesDiv.innerHTML = '<div class="empty-note">Generate a pool-play schedule for this division first.</div>';
      return;
    }

    const games = sched.games.filter(g => g.stage === 'pool');
    games.forEach(g => {
      const home = getTeamById(g.homeId);
      const away = getTeamById(g.awayId);
      const gameKey = g.id;
      const existing = scores[gameKey] || { home: '', away: '' };

      const row = document.createElement('div');
      row.className = 'game-row';
      const label = document.createElement('span');
      label.innerHTML = `<strong>${g.date || ''}</strong> ${g.time || ''} @ ${g.field || ''} – ${(home && home.teamName) || 'Team'} vs ${(away && away.teamName) || 'Team'}`;
      row.appendChild(label);

      const homeInput = document.createElement('input');
      homeInput.type = 'number';
      homeInput.min = '0';
      homeInput.className = 'score-input';
      homeInput.value = existing.home === '' ? '' : existing.home;

      const awayInput = document.createElement('input');
      awayInput.type = 'number';
      awayInput.min = '0';
      awayInput.className = 'score-input';
      awayInput.value = existing.away === '' ? '' : existing.away;

      function handleChange() {
        const hVal = homeInput.value;
        const aVal = awayInput.value;
        if (hVal === '' && aVal === '') {
          delete scores[gameKey];           // treat as no result
        } else {
          scores[gameKey] = {
            home: Number(hVal || 0),
            away: Number(aVal || 0)
          };
        }
        saveScores();
        renderStandings(division);
      }

      homeInput.addEventListener('change', handleChange);
      awayInput.addEventListener('change', handleChange);

      row.appendChild(document.createTextNode('  '));
      row.appendChild(homeInput);
      row.appendChild(document.createTextNode(' - '));
      row.appendChild(awayInput);

      scoringGamesDiv.appendChild(row);
    });

    renderStandings(division);
  }

  function renderStandings(division) {
    const sched = schedules.find(s => s.division === division);
    standingsOutput.innerHTML = '';
    if (!sched || !sched.games.length) return;

    const games = sched.games.filter(g => g.stage === 'pool');

    const points = {}; // teamId -> stats
    function ensureTeam(id) {
      if (!points[id]) {
        const t = getTeamById(id) || {};
        points[id] = {
          id,
          name: t.teamName || 'Team',
          division: division,
          played:0,wins:0,draws:0,losses:0,goalsFor:0,goalsAgainst:0,pts:0
        };
      }
      return points[id];
    }

    games.forEach(g => {
      const gameKey = g.id;
      const result = scores[gameKey];
      if (!result) return;
      const hs = Number(result.home);
      const as = Number(result.away);
      if (isNaN(hs) || isNaN(as) || (hs === 0 && as === 0 && result.home === '' && result.away === '')) return;

      const h = ensureTeam(g.homeId);
      const a = ensureTeam(g.awayId);

      h.played++; a.played++;
      h.goalsFor += hs; h.goalsAgainst += as;
      a.goalsFor += as; a.goalsAgainst += hs;

      // base points: win 6, tie 3, loss 0
      if (hs > as) { h.wins++; a.losses++; h.pts += 6; }
      else if (hs < as) { a.wins++; h.losses++; a.pts += 6; }
      else { h.draws++; a.draws++; h.pts += 3; a.pts += 3; }

      // shutout: +1 if opponent scores 0
      if (as === 0 && hs > 0) h.pts += 1;
      if (hs === 0 && as > 0) a.pts += 1;

      // goal points: 1 per goal, max 3
      h.pts += Math.min(hs, 3);
      a.pts += Math.min(as, 3);
    });

    const rows = Object.values(points);
    if (!rows.length) {
      standingsOutput.innerHTML = '<div class="empty-note">Enter some scores to see standings.</div>';
      return;
    }

    // apply deductions
    const divDeds = deductions[division] || {};
    rows.forEach(r => {
      r.deduction = Number(divDeds[r.id] || 0);
      r.adjPts = r.pts - r.deduction;
    });

    // group by pool
    const byPool = {};
    rows.forEach(r => {
      const pool = getPoolForTeam(division, r.id);
      const key = pool ? pool.name : 'Unassigned';
      if (!byPool[key]) byPool[key] = [];
      byPool[key].push(r);
    });

    let html = '<h3 class="card-title">Standings by Pool</h3>';

    Object.keys(byPool).forEach(poolName => {
      const list = byPool[poolName].slice().sort((a,b) =>
        b.adjPts - a.adjPts ||
        (b.goalsFor-b.goalsAgainst) - (a.goalsFor-a.goalsAgainst)
      );
      html += `<h4 style="margin:8px 0 4px; font-size:13px;">Pool ${poolName}</h4>`;
      html += '<table><thead><tr><th>Team</th><th>GP</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>Pts</th><th>Ded</th><th>Adj</th></tr></thead><tbody>';
      list.forEach(r => {
        html += `<tr>
          <td>${r.name}</td>
          <td>${r.played}</td>
          <td>${r.wins}</td>
          <td>${r.draws}</td>
          <td>${r.losses}</td>
          <td>${r.goalsFor}</td>
          <td>${r.goalsAgainst}</td>
          <td>${r.pts}</td>
          <td><input type="number" class="ded-input" data-team-id="${r.id}" data-division="${division}" value="${r.deduction}" style="width:45px;font-size:11px;" /></td>
          <td>${r.adjPts}</td>
        </tr>`;
      });
      html += '</tbody></table>';
    });

    standingsOutput.innerHTML = html;
    wireDeductionInputs(division);
  }

  function wireDeductionInputs(division) {
    const inputs = standingsOutput.querySelectorAll('.ded-input');
    inputs.forEach(inp => {
      inp.addEventListener('change', () => {
        const teamId = inp.getAttribute('data-team-id');
        const value = Number(inp.value || 0);
        if (!deductions[division]) deductions[division] = {};
        deductions[division][teamId] = value;
        saveDeductions();
        renderStandings(division);
      });
    });
  }
</script>
</body>
</html>
