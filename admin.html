<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OSF 2026 – Tournament Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --primary: #004b8d;
      --accent:  #d62828;
      --bg:      #f3f4f6;
      --card:    #ffffff;
      --border:  #e5e7eb;
      --text:    #111827;
      --muted:   #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #dbeafe 0, #f9fafb 40%, #e5e7eb 100%);
      color: var(--text);
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    h1 {
      margin: 0 0 6px;
      font-size: 24px;
      letter-spacing: 0.03em;
    }

    .subtitle {
      margin: 0 0 16px;
      color: var(--muted);
      font-size: 14px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.07);
      color: #1d4ed8;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #facc15;
      box-shadow: 0 0 0 4px rgba(250, 204, 21, 0.32);
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.16);
      border: 1px solid rgba(148,163,184,0.4);
      padding: 16px 14px 14px;
      margin-bottom: 18px;
    }

    .card-title {
      margin: 0 0 4px;
      font-size: 16px;
    }

    .card-subtitle {
      margin: 0 0 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .login-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .login-row input {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 7px 11px;
      font-size: 13px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 13px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #1d4ed8);
      color: #fff;
      box-shadow: 0 12px 26px rgba(37,99,235,0.45);
    }

    .btn-small {
      border-radius: 999px;
      border: none;
      padding: 3px 7px;
      font-size: 11px;
      cursor: pointer;
    }

    .btn-ghost {
      background: #f3f4f6;
      color: #374151;
    }

    .btn-approve { background:#22c55e; color:#fff; }
    .btn-decline { background:#ef4444; color:#fff; }
    .btn-pending { background:#f97316; color:#fff; }

    .message {
      font-size: 12px;
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 8px;
      display: none;
    }
    .message.visible { display:block; }
    .message.success {
      background:#ecfdf3;
      border:1px solid #22c55e;
      color:#166534;
    }
    .message.error {
      background:#fef2f2;
      border:1px solid:#ef4444;
      color:#991b1b;
    }

    .tabs {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      border-bottom:1px solid rgba(148,163,184,0.5);
      margin-bottom:10px;
    }

    .tab-btn {
      border:none;
      background:transparent;
      padding:7px 12px;
      font-size:13px;
      cursor:pointer;
      border-radius:999px 999px 0 0;
      color:#6b7280;
      font-weight:500;
    }

    .tab-btn.active {
      background:#fff;
      color:#111827;
      box-shadow:0 -1px 0 #fff, 0 -2px 0 #1d4ed8;
    }

    .tab-panel { display:none; }
    .tab-panel.active { display:block; }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      margin-top:8px;
    }
    thead { background:#f3f4f6; }
    th, td {
      padding:7px 9px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
      vertical-align:top;
    }
    th {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color:#6b7280;
    }
    tbody tr:hover { background:#f9fafb; }

    .status-chip {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
    }
    .status-pending { background:#fef3c7; color:#92400e; }
    .status-approved{ background:#dcfce7; color:#166534;}
    .status-declined{ background:#fee2e2; color:#991b1b;}

    .coach-line{font-size:11px;color:#4b5563;}
    .email-line{font-size:11px;color:#6b7280;word-break:break-all;}

    .docs-flags{display:flex;flex-direction:column;gap:3px;font-size:11px;}
    .docs-flag-row{display:flex;align-items:center;gap:6px;}
    .docs-flag-row input[type="checkbox"]{width:13px;height:13px;cursor:pointer;}

    .empty-note{font-size:12px;color:var(--muted);margin-top:6px;}

    .small-input-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
      font-size:13px;
    }
    .small-input-row input,
    .small-input-row select {
      padding:6px 9px;
      border-radius:8px;
      border:1px solid var(--border);
      font-size:13px;
    }
    .small-label{
      font-size:12px;
      color:#4b5563;
      margin-bottom:2px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:#f3f4f6;
      margin-right:6px;
      margin-bottom:4px;
      font-size:12px;
    }
    .pill span:last-child{font-size:11px;color:#6b7280;}

    .tag{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:#e5e7eb;
      font-size:11px;
      margin:2px 4px 2px 0;
    }

    .game-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      font-size:12px;
      padding:4px 0;
      border-bottom:1px solid #e5e7eb;
    }
    .game-row:last-child{border-bottom:none;}

    .admin-game-input{
      width:100px;
      padding:3px 5px;
      border-radius:6px;
      border:1px solid var(--border);
      font-size:11px;
    }

    .score-input{
      width:40px;
      padding:2px 4px;
      border-radius:4px;
      border:1px solid var(--border);
      font-size:12px;
      text-align:center;
    }

    .schedule-grid{
      border:1px solid #e5e7eb;
      border-radius:10px;
      overflow:hidden;
      margin-top:10px;
      background:#fff;
    }
    .schedule-date-header{
      background:#111827;
      color:#fff;
      padding:6px 10px;
      font-size:13px;
      font-weight:600;
    }
    .schedule-grid table{
      border-collapse:collapse;
      width:100%;
      margin:0;
      font-size:12px;
    }
    .schedule-grid th,
    .schedule-grid td{
      border:1px solid #e5e7eb;
      padding:5px 6px;
      text-align:center;
    }
    .schedule-field-header{
      background:#e5e7eb;
      font-size:11px;
      font-weight:600;
    }
    .highlight{background:#fef3c7;}

    @media (max-width:640px){
      .card{padding:12px 8px;}
      th:nth-child(5),td:nth-child(5){display:none;}
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="badge">
      <span class="badge-dot"></span>
      OSF 2026 • Tournament Admin
    </div>
    <h1>Admin Control Center</h1>
    <p class="subtitle">Manage teams, pools, schedules, semis/finals, and scoring in one place.</p>
  </header>

  <section class="card">
    <div class="login-row">
      <input type="password" id="adminPassword" placeholder="Admin password">
      <button class="btn btn-primary" id="adminLoginBtn">Unlock Admin</button>
    </div>
    <div id="adminLoginMessage" class="message"></div>

    <div id="adminMain" style="display:none; margin-top:10px;">
      <div class="tabs">
        <button class="tab-btn active" data-tab="teamsTab">Teams</button>
        <button class="tab-btn" data-tab="poolsTab">Pools</button>
        <button class="tab-btn" data-tab="scheduleTab">Game Schedules</button>
        <button class="tab-btn" data-tab="scoringTab">Scoring</button>
      </div>

      <!-- TEAMS TAB -->
      <div id="teamsTab" class="tab-panel active">
        <section class="card" style="margin-top:4px;">
          <h2 class="card-title">Teams (Pending &amp; Approved)</h2>
          <p class="card-subtitle">
            Track documents and approve/decline teams. Declined teams show in a separate list.
          </p>

          <table>
            <thead>
            <tr>
              <th>Division</th>
              <th>Region</th>
              <th>Team / Coach</th>
              <th>Docs</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody id="adminTeamsBody"></tbody>
          </table>
          <div id="activeEmpty" class="empty-note" style="display:none;">No pending or approved teams yet.</div>
        </section>

        <section class="card">
          <h2 class="card-title">Declined Teams</h2>
          <p class="card-subtitle">
            Declined teams can be moved back to Pending if needed.
          </p>
          <table>
            <thead>
            <tr>
              <th>Division</th>
              <th>Region</th>
              <th>Team / Coach</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody id="declinedTeamsBody"></tbody>
          </table>
          <div id="declinedEmpty" class="empty-note" style="display:none;">No declined teams at this time.</div>
        </section>
      </div>

      <!-- POOLS TAB -->
      <div id="poolsTab" class="tab-panel">
        <section class="card" style="margin-top:4px;">
          <h2 class="card-title">Pools</h2>
          <p class="card-subtitle">
            Create pools per division and assign approved teams. Edit or delete pools as needed.
          </p>

          <div class="small-input-row">
            <div>
              <div class="small-label">Division</div>
              <select id="poolDivision">
                <option value="10UB">10U Boys</option>
                <option value="10UG">10U Girls</option>
                <option value="12UB">12U Boys</option>
                <option value="12UG">12U Girls</option>
                <option value="14UB">14U Boys</option>
                <option value="14UG">14U Girls</option>
              </select>
            </div>
            <div>
              <div class="small-label">New Pool Name</div>
              <input id="poolName" placeholder="e.g., Pool A">
            </div>
            <div style="align-self:flex-end;">
              <button class="btn btn-primary" id="createPoolBtn">Add Pool</button>
            </div>
          </div>

          <p class="small-label">Teams in this division (approved or manual): assign to pools</p>
          <div id="poolTeamsArea" class="empty-note">No teams yet for this division.</div>

          <h3 class="card-title" style="margin-top:14px;">Existing Pools</h3>
          <div id="poolsList"></div>

          <hr style="margin:12px 0; border:none; border-top:1px solid #e5e7eb;">

          <h3 class="card-title">Manual Placeholder Teams</h3>
          <p class="card-subtitle">
            Use this for saved spots (e.g., “Reserved Spot 1”).
          </p>
          <div class="small-input-row">
            <div style="flex:1;">
              <div class="small-label">Manual Team (placeholder)</div>
              <input id="manualTeamName" style="width:100%;" placeholder="e.g., Reserved Spot 1">
            </div>
            <div style="align-self:flex-end;">
              <button class="btn btn-ghost" id="addManualTeamBtn">Add Manual Team</button>
            </div>
          </div>
        </section>
      </div>

      <!-- SCHEDULE TAB -->
      <div id="scheduleTab" class="tab-panel">
        <section class="card" style="margin-top:4px;">
          <h2 class="card-title">Game Schedules</h2>
          <p class="card-subtitle">
            Build pool-play schedules, then add 2 Semis, a Championship, and a Consolation per division.
          </p>

          <div class="small-input-row">
            <div>
              <div class="small-label">Division</div>
              <select id="schedDivision">
                <option value="10UB">10U Boys</option>
                <option value="10UG">10U Girls</option>
                <option value="12UB">12U Boys</option>
                <option value="12UG">12U Girls</option>
                <option value="14UB">14U Boys</option>
                <option value="14UG">14U Girls</option>
              </select>
            </div>
          </div>

          <h3 class="card-title">Pool-Play Day Setup</h3>
          <p class="card-subtitle">
            Each day can have its own fields and time slots (e.g., Saturday vs Sunday).
          </p>

          <div id="dayConfigs"></div>
          <button class="btn btn-ghost" id="addDayBtn">Add Day</button>

          <div class="small-input-row" style="margin-top:10px;">
            <label style="display:flex;align-items:center;gap:6px;font-size:12px;">
              <input type="checkbox" id="crossPoolCheckbox">
              Allow a few cross-pool games (only if needed; max 3 pool games per team).
            </label>
          </div>

          <button class="btn btn-primary" id="generateScheduleBtn" style="margin-top:6px;">
            Generate / Regenerate Pool-Play
          </button>

          <div id="scheduleAdmin" style="margin-top:14px;font-size:12px;"></div>

          <hr style="margin:14px 0; border:none; border-top:1px solid #e5e7eb;">

          <h3 class="card-title">Knockout Games (Semis / Consolation / Championship)</h3>
          <p class="card-subtitle">
            For each division, define exactly 4 bracket games:<br>
            Semi 1, Semi 2, Consolation, and Championship. Teams can stay <strong>TBD</strong> until decided.
          </p>

          <div id="knockoutEditor"></div>

          <hr style="margin:14px 0; border:none; border-top:1px solid #e5e7eb;">

          <h3 class="card-title">Parent-Facing Schedule Preview</h3>
          <p class="card-subtitle">
            Pool play and knockout games shown in grid format by date, fields across and times down.
          </p>
          <div id="schedulePreview"></div>
        </section>
      </div>

      <!-- SCORING TAB -->
      <div id="scoringTab" class="tab-panel">
        <section class="card" style="margin-top:4px;">
          <h2 class="card-title">Scoring & Standings</h2>
          <p class="card-subtitle">
            Enter pool-play scores (by pool). Points: Win 6 • Tie 3 • Loss 0 • Shutout +1 • Goals +1 (max 3).
          </p>

          <div class="small-input-row">
            <div>
              <div class="small-label">Division</div>
              <select id="scoreDivision">
                <option value="10UB">10U Boys</option>
                <option value="10UG">10U Girls</option>
                <option value="12UB">12U Boys</option>
                <option value="12UG">12U Girls</option>
                <option value="14UB">14U Boys</option>
                <option value="14UG">14U Girls</option>
              </select>
            </div>
            <div style="align-self:flex-end;">
              <button class="btn btn-primary" id="loadScoresBtn">Load Games</button>
            </div>
          </div>

          <div id="scoringGames" style="margin-top:6px;"></div>
          <div id="standingsOutput" style="margin-top:10px;font-size:12px;"></div>
        </section>
      </div>
    </div>
  </section>
</div>

<script>
  // ========= CONFIG ==========
  const API_URL = 'https://script.google.com/macros/s/AKfycby81ycJHK0S9NUWgWuYSuHHzmz9mf2VKV_oDt4KEJv-hvSvlvOF-dxZa-AnZacewuJ8/exec';
  const ADMIN_PASSWORD = 'PLAYSOCCER';

  // ========= SHARED STATE (loaded from AdminState) ==========
  let teams = [];        // from Teams sheet
  let manualTeams = [];  // from AdminState
  let pools = [];        // from AdminState
  let schedules = [];    // from AdminState
  let scores = {};       // from AdminState
  let dayConfigs = {};   // from AdminState

  // ========= HELPERS ==========
  function divisionLabel(code){
    return {
      '10UB':'10U Boys','10UG':'10U Girls',
      '12UB':'12U Boys','12UG':'12U Girls',
      '14UB':'14U Boys','14UG':'14U Girls'
    }[code] || code || '';
  }

  function toBool(v){
    return v === true || v === 'true' || v === 'TRUE' || v === 1 || v === '1' ||
           v === 'Yes' || v === 'YES' || v === 'yes';
  }

  function getAllTeams(){
    return [...teams, ...manualTeams];
  }
  function getTeamById(id){
    id = String(id);
    return teams.find(t => String(t.id) === id) ||
           manualTeams.find(t => String(t.id) === id) || null;
  }
  function getPoolsForDivision(division){
    return pools.filter(p => p.division === division);
  }
  function getPoolForTeam(division, teamId){
    teamId = String(teamId);
    return pools.find(p => p.division === division && p.teamIds.includes(teamId)) || null;
  }

  // ========= STATE SYNC (ADMINSTATE SHEET) ==========
  async function loadStateFromApi() {
    try {
      const res = await fetch(API_URL + '?entity=state');
      const data = await res.json();

      if (data) {
        manualTeams = Array.isArray(data.manualTeams) ? data.manualTeams : [];
        pools       = Array.isArray(data.pools)       ? data.pools       : [];
        schedules   = Array.isArray(data.schedules)   ? data.schedules   : [];
        scores      = data.scores && typeof data.scores === 'object' ? data.scores : {};
        dayConfigs  = data.dayConfigs && typeof data.dayConfigs === 'object' ? data.dayConfigs : {};
      }
    } catch (err) {
      console.error('Error loading admin state from API:', err);
      // If this fails, state just stays at defaults.
    }
  }

  async function saveStateToApi() {
    const state = {
      manualTeams,
      pools,
      schedules,
      scores,
      dayConfigs
    };

    try {
      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          entity: 'state',
          state
        })
      });
    } catch (err) {
      console.error('Error saving admin state to API:', err);
    }
  }

  // These are now just wrappers around saveStateToApi
  function saveManualTeams(){ saveStateToApi(); }
  function savePools(){ saveStateToApi(); }
  function saveSchedules(){ saveStateToApi(); }
  function saveScoresStore(){ saveStateToApi(); }
  function saveDayConfigs(){ saveStateToApi(); }

  // ========= LOGIN + TABS ==========
  const adminLoginBtn = document.getElementById('adminLoginBtn');
  const adminPasswordInput = document.getElementById('adminPassword');
  const adminLoginMessage = document.getElementById('adminLoginMessage');
  const adminMain = document.getElementById('adminMain');

  adminLoginBtn.addEventListener('click', async () => {
    if (adminPasswordInput.value.trim() !== ADMIN_PASSWORD){
      adminLoginMessage.textContent = 'Incorrect password.';
      adminLoginMessage.className = 'message visible error';
      adminMain.style.display = 'none';
      return;
    }
    adminLoginMessage.textContent = 'Admin panel unlocked.';
    adminLoginMessage.className = 'message visible success';
    adminMain.style.display = 'block';

    // 1. Load teams from Teams sheet
    await loadTeamsFromApi();
    // 2. Load shared admin state (pools, schedules, scores, etc.)
    await loadStateFromApi();

    renderTeamsTables();
    refreshPoolsUI();
    renderDayConfigsUI();
    renderKnockoutEditor();
    renderScheduleAdmin(document.getElementById('schedDivision').value);
    renderSchedulePreview(document.getElementById('schedDivision').value);
  });

  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
    });
  });

  async function loadTeamsFromApi(){
    const res = await fetch(API_URL);
    const data = await res.json();
    teams = Array.isArray(data) ? data : [];
  }

  async function postUpdate(payload){
    try {
      const res = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      await res.text();
    } catch(err){
      console.error('Update error', err);
    }
  }

  // ========= TEAMS TAB ==========
  const adminTeamsBody   = document.getElementById('adminTeamsBody');
  const declinedTeamsBody= document.getElementById('declinedTeamsBody');
  const activeEmpty      = document.getElementById('activeEmpty');
  const declinedEmpty    = document.getElementById('declinedEmpty');

  function renderTeamsTables(){
    adminTeamsBody.innerHTML = '';
    declinedTeamsBody.innerHTML = '';

    const activeTeams = teams.filter(t => (t.status || 'pending') !== 'declined');
    const declinedTeams = teams.filter(t => t.status === 'declined');

    activeEmpty.style.display = activeTeams.length ? 'none' : 'block';
    declinedEmpty.style.display = declinedTeams.length ? 'none' : 'block';

    activeTeams.forEach(team => {
      const tr = document.createElement('tr');

      const tdDiv = document.createElement('td');
      tdDiv.textContent = divisionLabel(team.division);

      const tdRegion = document.createElement('td');
      tdRegion.innerHTML = `<strong>${team.regionNumber || ''}</strong>`;

      const tdTeam = document.createElement('td');
      tdTeam.innerHTML =
        `<strong>${team.teamName || ''}</strong><br>` +
        `<div class="coach-line">Coach: ${team.coachName || ''}</div>` +
        `<div class="email-line">${team.coachEmail || ''}</div>`;

      const tdDocs = document.createElement('td');
      tdDocs.className = 'docs-flags';

      const makeDocRow = (label, key) => {
        const row = document.createElement('div');
        row.className = 'docs-flag-row';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = toBool(team[key]);
        cb.addEventListener('change', () => {
          updateDocs(team.id, {
            docs_application: key === 'docs_application' ? cb.checked : toBool(team.docs_application),
            docs_roster:      key === 'docs_roster'      ? cb.checked : toBool(team.docs_roster),
            docs_check:       key === 'docs_check'       ? cb.checked : toBool(team.docs_check)
          });
        });
        row.appendChild(cb);
        const span = document.createElement('span');
        span.textContent = label;
        row.appendChild(span);
        return row;
      };

      tdDocs.appendChild(makeDocRow('Application', 'docs_application'));
      tdDocs.appendChild(makeDocRow('Roster', 'docs_roster'));
      tdDocs.appendChild(makeDocRow('Check', 'docs_check'));

      const tdStatus = document.createElement('td');
      const chip = document.createElement('span');
      chip.className = 'status-chip';
      const status = team.status || 'pending';
      if (status === 'approved') chip.classList.add('status-approved');
      else if (status === 'declined') chip.classList.add('status-declined');
      else chip.classList.add('status-pending');
      chip.textContent = status === 'approved' ? 'Approved' :
                         status === 'declined' ? 'Declined' :
                         'Pending';
      tdStatus.appendChild(chip);

      const tdActions = document.createElement('td');
      const btnApprove = document.createElement('button');
      btnApprove.textContent = 'Approve';
      btnApprove.className = 'btn-small btn-approve';
      btnApprove.onclick = () => updateStatus(team.id, 'approved');
      const btnDecline = document.createElement('button');
      btnDecline.textContent = 'Decline';
      btnDecline.className = 'btn-small btn-decline';
      btnDecline.onclick = () => updateStatus(team.id, 'declined');
      tdActions.appendChild(btnApprove);
      tdActions.appendChild(document.createElement('br'));
      tdActions.appendChild(btnDecline);

      tr.appendChild(tdDiv);
      tr.appendChild(tdRegion);
      tr.appendChild(tdTeam);
      tr.appendChild(tdDocs);
      tr.appendChild(tdStatus);
      tr.appendChild(tdActions);

      adminTeamsBody.appendChild(tr);
    });

    declinedTeams.forEach(team => {
      const tr = document.createElement('tr');

      const tdDiv = document.createElement('td');
      tdDiv.textContent = divisionLabel(team.division);

      const tdRegion = document.createElement('td');
      tdRegion.innerHTML = `<strong>${team.regionNumber || ''}</strong>`;

      const tdTeam = document.createElement('td');
      tdTeam.innerHTML =
        `<strong>${team.teamName || ''}</strong><br>` +
        `<div class="coach-line">Coach: ${team.coachName || ''}</div>` +
        `<div class="email-line">${team.coachEmail || ''}</div>`;

      const tdStatus = document.createElement('td');
      const chip = document.createElement('span');
      chip.className = 'status-chip status-declined';
      chip.textContent = 'Declined';
      tdStatus.appendChild(chip);

      const tdActions = document.createElement('td');
      const btnPending = document.createElement('button');
      btnPending.textContent = 'Move to Pending';
      btnPending.className = 'btn-small btn-pending';
      btnPending.onclick = () => updateStatus(team.id, 'pending');
      tdActions.appendChild(btnPending);

      tr.appendChild(tdDiv);
      tr.appendChild(tdRegion);
      tr.appendChild(tdTeam);
      tr.appendChild(tdStatus);
      tr.appendChild(tdActions);

      declinedTeamsBody.appendChild(tr);
    });
  }

  async function updateStatus(id, status){
    await postUpdate({mode:'update', team:{id, status}});
    await loadTeamsFromApi();
    renderTeamsTables();
    refreshPoolsUI();
    renderSchedulePreview(document.getElementById('schedDivision').value);
  }

  async function updateDocs(id, docs){
    await postUpdate({mode:'update', team:{id, ...docs}});
    await loadTeamsFromApi();
    renderTeamsTables();
  }

  // ========= POOLS TAB ==========
  const poolDivisionSel   = document.getElementById('poolDivision');
  const poolNameInput     = document.getElementById('poolName');
  const createPoolBtn     = document.getElementById('createPoolBtn');
  const poolTeamsArea     = document.getElementById('poolTeamsArea');
  const poolsList         = document.getElementById('poolsList');
  const manualTeamNameInput = document.getElementById('manualTeamName');
  const addManualTeamBtn  = document.getElementById('addManualTeamBtn');

  poolDivisionSel.addEventListener('change', () => {
    refreshPoolsUI();
  });

  createPoolBtn.addEventListener('click', () => {
    const division = poolDivisionSel.value;
    const name = poolNameInput.value.trim();
    if (!name) return;
    const id = 'pool_' + Date.now();
    pools.push({id, division, name, teamIds:[]});
    poolNameInput.value = '';
    savePools();
    refreshPoolsUI();
  });

  addManualTeamBtn.addEventListener('click', () => {
    const division = poolDivisionSel.value;
    const name = manualTeamNameInput.value.trim();
    if (!name) return;
    const id = 'manual_' + Date.now();
    manualTeams.push({
      id,
      division,
      teamName:name,
      manual:true,
      regionNumber:'',
      coachName:'',
      coachEmail:''
    });
    manualTeamNameInput.value = '';
    saveManualTeams();
    refreshPoolsUI();
    renderSchedulePreview(document.getElementById('schedDivision').value);
  });

  function assignTeamToPool(division, teamId, poolId){
    teamId = String(teamId);
    pools.forEach(p => {
      if (p.division !== division) return;
      p.teamIds = p.teamIds.filter(id => id !== teamId);
    });
    if (poolId){
      const pool = pools.find(p => p.id === poolId);
      if (pool && !pool.teamIds.includes(teamId)) pool.teamIds.push(teamId);
    }
    savePools();
    refreshPoolsUI();
    renderSchedulePreview(document.getElementById('schedDivision').value);
  }

  function refreshPoolsUI(){
    const division = poolDivisionSel.value;
    const relevantTeams = getAllTeams().filter(t =>
      t.division === division && (t.status === 'approved' || t.manual)
    );

    poolTeamsArea.innerHTML = '';
    if (!relevantTeams.length){
      poolTeamsArea.innerHTML = '<span class="empty-note">No approved or manual teams yet for this division.</span>';
    } else {
      relevantTeams.forEach(team => {
        const div = document.createElement('div');
        div.className = 'pill';
        const nameSpan = document.createElement('span');
        nameSpan.innerHTML = `<strong>${team.teamName || 'Team'}</strong>`;
        const sub = document.createElement('span');
        sub.textContent = team.manual ? 'Manual' : `Region ${team.regionNumber || ''}`;
        div.appendChild(nameSpan);
        div.appendChild(sub);

        const select = document.createElement('select');
        const noneOpt = document.createElement('option');
        noneOpt.value = '';
        noneOpt.textContent = 'No pool';
        select.appendChild(noneOpt);
        const poolsForDiv = getPoolsForDivision(division);
        poolsForDiv.forEach(p => {
          const o = document.createElement('option');
          o.value = p.id;
          o.textContent = p.name;
          if (p.teamIds.includes(String(team.id))) o.selected = true;
          select.appendChild(o);
        });
        select.addEventListener('change', () => {
          assignTeamToPool(division, team.id, select.value);
        });
        div.appendChild(select);

        poolTeamsArea.appendChild(div);
      });
    }

    poolsList.innerHTML = '';
    const poolsForDiv = getPoolsForDivision(division);
    if (!poolsForDiv.length){
      poolsList.innerHTML = '<div class="empty-note">No pools created yet for this division.</div>';
    } else {
      poolsForDiv.forEach(pool => {
        const container = document.createElement('div');
        container.style.marginTop = '8px';

        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.alignItems = 'center';
        header.style.gap = '6px';

        const title = document.createElement('div');
        title.innerHTML = `<strong>${pool.name}</strong> <span style="font-size:11px;color:#6b7280;">(${divisionLabel(pool.division)})</span>`;
        header.appendChild(title);

        const editBtn = document.createElement('button');
        editBtn.className = 'btn-small btn-ghost';
        editBtn.style.fontSize = '10px';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', () => {
          const newName = prompt('New pool name:', pool.name);
          if (newName && newName.trim()){
            pool.name = newName.trim();
            savePools();
            refreshPoolsUI();
            renderScheduleAdmin(pool.division);
            renderSchedulePreview(pool.division);
          }
        });

        const delBtn = document.createElement('button');
        delBtn.className = 'btn-small btn-decline';
        delBtn.style.fontSize = '10px';
        delBtn.textContent = 'Delete';
        delBtn.addEventListener('click', () => {
          if (!confirm(`Delete ${pool.name}? Teams will be unassigned from this pool.`)) return;
          pools = pools.filter(p => p.id !== pool.id);
          savePools();
          refreshPoolsUI();
          renderScheduleAdmin(pool.division);
          renderSchedulePreview(pool.division);
        });

        header.appendChild(editBtn);
        header.appendChild(delBtn);

        const body = document.createElement('div');
        body.style.marginTop = '4px';
        const members = getAllTeams().filter(t => pool.teamIds.includes(String(t.id)));
        if (!members.length){
          body.innerHTML = '<span class="empty-note">No teams assigned yet.</span>';
        } else {
          members.forEach(m => {
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.textContent = m.teamName || 'Team';
            body.appendChild(tag);
          });
        }

        container.appendChild(header);
        container.appendChild(body);
        poolsList.appendChild(container);
      });
    }
  }

  // ========= SCHEDULE TAB ==========
  const schedDivisionSel = document.getElementById('schedDivision');
  const dayConfigsDiv    = document.getElementById('dayConfigs');
  const addDayBtn        = document.getElementById('addDayBtn');
  const crossPoolCheckbox= document.getElementById('crossPoolCheckbox');
  const generateScheduleBtn = document.getElementById('generateScheduleBtn');
  const scheduleAdmin    = document.getElementById('scheduleAdmin');
  const schedulePreview  = document.getElementById('schedulePreview');
  const knockoutEditor   = document.getElementById('knockoutEditor');

  schedDivisionSel.addEventListener('change', () => {
    renderDayConfigsUI();
    renderScheduleAdmin(schedDivisionSel.value);
    renderKnockoutEditor();
    renderSchedulePreview(schedDivisionSel.value);
  });

  addDayBtn.addEventListener('click', () => {
    const division = schedDivisionSel.value;
    if (!dayConfigs[division]) dayConfigs[division] = [];
    dayConfigs[division].push({label:'',fields:'',times:''});
    saveDayConfigs();
    renderDayConfigsUI();
  });

  function renderDayConfigsUI(){
    const division = schedDivisionSel.value;
    const list = dayConfigs[division] || [];
    dayConfigsDiv.innerHTML = '';
    if (!list.length){
      dayConfigsDiv.innerHTML = '<div class="empty-note">Add at least one day (e.g., "Saturday (Apr 25)") with fields and times.</div>';
      return;
    }

    list.forEach((day, idx) => {
      const row = document.createElement('div');
      row.className = 'small-input-row';

      const wrapLabel = document.createElement('div');
      const lbl1 = document.createElement('div');
      lbl1.className = 'small-label';
      lbl1.textContent = `Day ${idx+1} Label`;
      const inp1 = document.createElement('input');
      inp1.value = day.label;
      inp1.placeholder = 'Saturday (Apr 25)';
      inp1.style.minWidth = '150px';
      inp1.addEventListener('input', () => {
        dayConfigs[division][idx].label = inp1.value;
        saveDayConfigs();
      });
      wrapLabel.appendChild(lbl1);
      wrapLabel.appendChild(inp1);

      const wrapFields = document.createElement('div');
      wrapFields.style.flex = '1';
      const lbl2 = document.createElement('div');
      lbl2.className = 'small-label';
      lbl2.textContent = 'Fields (comma separated)';
      const inp2 = document.createElement('input');
      inp2.value = day.fields;
      inp2.placeholder = 'Field 5, Field 6';
      inp2.style.width = '100%';
      inp2.addEventListener('input', () => {
        dayConfigs[division][idx].fields = inp2.value;
        saveDayConfigs();
      });
      wrapFields.appendChild(lbl2);
      wrapFields.appendChild(inp2);

      const wrapTimes = document.createElement('div');
      wrapTimes.style.flex = '1';
      const lbl3 = document.createElement('div');
      lbl3.className = 'small-label';
      lbl3.textContent = 'Times (comma separated)';
      const inp3 = document.createElement('input');
      inp3.value = day.times;
      inp3.placeholder = '8:00am, 9:15am, 10:30am';
      inp3.style.width = '100%';
      inp3.addEventListener('input', () => {
        dayConfigs[division][idx].times = inp3.value;
        saveDayConfigs();
      });
      wrapTimes.appendChild(lbl3);
      wrapTimes.appendChild(inp3);

      const wrapDel = document.createElement('div');
      wrapDel.style.alignSelf = 'flex-end';
      const delBtn = document.createElement('button');
      delBtn.className = 'btn-small btn-decline';
      delBtn.textContent = 'X';
      delBtn.addEventListener('click', () => {
        dayConfigs[division].splice(idx,1);
        saveDayConfigs();
        renderDayConfigsUI();
      });
      wrapDel.appendChild(delBtn);

      row.appendChild(wrapLabel);
      row.appendChild(wrapFields);
      row.appendChild(wrapTimes);
      row.appendChild(wrapDel);

      dayConfigsDiv.appendChild(row);
    });
  }

  function buildRoundRobin(teamIds, maxGamesPerTeam){
    const ids = teamIds.map(String);
    if (ids.length < 2) return [];
    let work = [...ids];
    const n = work.length;
    if (n % 2 === 1){
      work.push('BYE');
    }
    const m = work.length;
    const rounds = [];
    const gameCount = {};
    const canPlay = (a,b) => {
      const ca = gameCount[a] || 0;
      const cb = gameCount[b] || 0;
      return ca < maxGamesPerTeam && cb < maxGamesPerTeam;
    };

    for (let r=0; r<m-1; r++){
      const roundMatches = [];
      for (let i=0; i<m/2; i++){
        const t1 = work[i];
        const t2 = work[m-1-i];
        if (t1 === 'BYE' || t2 === 'BYE') continue;
        if (!canPlay(t1,t2)) continue;
        roundMatches.push({homeId:String(t1), awayId:String(t2)});
        gameCount[t1] = (gameCount[t1]||0)+1;
        gameCount[t2] = (gameCount[t2]||0)+1;
      }
      if (roundMatches.length) rounds.push(roundMatches);
      work = [work[0], ...work.slice(2), work[1]];
    }
    return rounds;
  }

  generateScheduleBtn.addEventListener('click', () => {
    const division = schedDivisionSel.value;
    const poolsForDiv = getPoolsForDivision(division);
    if (!poolsForDiv.length){
      scheduleAdmin.innerHTML = '<div class="empty-note">Create pools for this division first.</div>';
      schedulePreview.innerHTML = '';
      return;
    }

    const rawDays = (dayConfigs[division] || []).map(d => ({
      label:d.label.trim(),
      fields:d.fields.split(',').map(x=>x.trim()).filter(Boolean),
      times:d.times.split(',').map(x=>x.trim()).filter(Boolean)
    })).filter(d => d.label && d.fields.length && d.times.length);

    if (!rawDays.length){
      scheduleAdmin.innerHTML = '<div class="empty-note">Add at least one day with fields and times.</div>';
      schedulePreview.innerHTML = '';
      return;
    }

    const includeCross = crossPoolCheckbox.checked;

    const allDivTeams = getAllTeams().filter(t => t.division === division);
    const poolRounds = [];
    poolsForDiv.forEach(pool => {
      const teamIds = allDivTeams
        .filter(t => pool.teamIds.includes(String(t.id)))
        .map(t => String(t.id));
      if (teamIds.length < 2) return;
      const rounds = buildRoundRobin(teamIds, 3);
      if (rounds.length){
        poolRounds.push({poolId:pool.id, poolName:pool.name, rounds});
      }
    });

    const crossRounds = [];
    if (includeCross && poolRounds.length > 1){
      const gameCount = {};
      poolRounds.forEach(pr => {
        pr.rounds.forEach(r => {
          r.forEach(m => {
            gameCount[m.homeId] = (gameCount[m.homeId]||0)+1;
            gameCount[m.awayId] = (gameCount[m.awayId]||0)+1;
          });
        });
      });

      const allPairs = [];
      const poolTeams = poolsForDiv.map(p => ({
        pool:p,
        teams: allDivTeams.filter(t => p.teamIds.includes(String(t.id)))
      }));

      for (let i=0;i<poolTeams.length;i++){
        for (let j=i+1;j<poolTeams.length;j++){
          poolTeams[i].teams.forEach(a => {
            poolTeams[j].teams.forEach(b => {
              allPairs.push({a,b});
            });
          });
        }
      }

      const usedPairs = new Set();
      const crossList = [];
      allPairs.forEach(pair => {
        const key = [pair.a.id, pair.b.id].sort().join('_');
        if (usedPairs.has(key)) return;
        const ca = gameCount[pair.a.id] || 0;
        const cb = gameCount[pair.b.id] || 0;
        if (ca >= 3 || cb >= 3) return;
        usedPairs.add(key);
        gameCount[pair.a.id]=ca+1;
        gameCount[pair.b.id]=cb+1;
        crossList.push({
          poolId:'cross',
          poolName:`${getPoolForTeam(division,pair.a.id)?.name || ''} vs ${getPoolForTeam(division,pair.b.id)?.name || ''}`,
          homeId:String(pair.a.id),
          awayId:String(pair.b.id)
        });
      });

      if (crossList.length){
        const chunkSize = Math.max(1, Math.floor(crossList.length/2));
        for (let i=0;i<crossList.length;i+=chunkSize){
          crossRounds.push(crossList.slice(i,i+chunkSize));
        }
      }
    }

    const globalRounds = [];
    const maxRounds = poolRounds.reduce((max,pr)=>Math.max(max,pr.rounds.length),0);
    for (let r=0;r<maxRounds;r++){
      const arr = [];
      poolRounds.forEach(pr => {
        if (pr.rounds[r]){
          pr.rounds[r].forEach(m => arr.push({
            poolId:pr.poolId, poolName:pr.poolName,
            homeId:m.homeId, awayId:m.awayId
          }));
        }
      });
      if (arr.length) globalRounds.push(arr);
    }
    crossRounds.forEach(cr => {
      globalRounds.push(cr.map(m => ({
        poolId:m.poolId, poolName:m.poolName,
        homeId:m.homeId, awayId:m.awayId
      })));
    });

    if (!globalRounds.length){
      scheduleAdmin.innerHTML = '<div class="empty-note">No games generated. Check pools and teams.</div>';
      schedulePreview.innerHTML = '';
      return;
    }

    const timeBlocks = [];
    let blockIdx = 0;
    rawDays.forEach((day, di) => {
      day.times.forEach((time, ti) => {
        timeBlocks.push({
          index:blockIdx++,
          dayIndex:di,
          label:day.label,
          timeIndex:ti,
          time,
          fields:[...day.fields]
        });
      });
    });
    const blocksCount = timeBlocks.length;
    if (!blocksCount){
      scheduleAdmin.innerHTML = '<div class="empty-note">No time blocks defined.</div>';
      schedulePreview.innerHTML = '';
      return;
    }

    const usedBlocksByTeam = {};
    const blockUsage = timeBlocks.map(()=>0);
    const assignedGames = [];

    function teamCanPlayAtBlock(teamId, blockIndex){
      teamId = String(teamId);
      const used = usedBlocksByTeam[teamId] || [];
      for (const idx of used){
        if (idx === blockIndex) return false;
        if (Math.abs(idx-blockIndex) < 2) return false;
      }
      return true;
    }

    const roundCount = globalRounds.length;
    let blocksPerRound = Math.max(1, Math.floor(blocksCount/roundCount));
    if (blocksCount >= 2*roundCount){
      blocksPerRound = Math.floor(blocksCount/roundCount);
    }

    function assignGameToBlock(game, roundIndex){
      const start = roundIndex * blocksPerRound;
      let end = (roundIndex+1)*blocksPerRound - 1;
      if (roundIndex === roundCount-1) end = blocksCount-1;
      const ranges = [
        [Math.max(0,start), Math.min(blocksCount-1,end)],
        [0, blocksCount-1]
      ];

      for (const [from,to] of ranges){
        for (let b=from;b<=to;b++){
          const block = timeBlocks[b];
          if (blockUsage[b] >= block.fields.length) continue;
          if (!teamCanPlayAtBlock(game.homeId,b)) continue;
          if (!teamCanPlayAtBlock(game.awayId,b)) continue;

          const field = block.fields[blockUsage[b]];
          blockUsage[b]++;

          const g = {
            id: `${division}_${game.poolId}_${assignedGames.length+1}`,
            division,
            poolId: game.poolId,
            poolName: game.poolName,
            homeId: game.homeId,
            awayId: game.awayId,
            date: block.label,
            time: block.time,
            field,
            stage: 'pool'
          };
          assignedGames.push(g);

          [game.homeId, game.awayId].forEach(tid => {
            tid = String(tid);
            if (!usedBlocksByTeam[tid]) usedBlocksByTeam[tid] = [];
            usedBlocksByTeam[tid].push(b);
          });

          return true;
        }
      }
      assignedGames.push({
        id: `${division}_${game.poolId}_${assignedGames.length+1}`,
        division,
        poolId: game.poolId,
        poolName: game.poolName,
        homeId: game.homeId,
        awayId: game.awayId,
        date: '',
        time: '',
        field: '',
        stage: 'pool'
      });
      return false;
    }

    globalRounds.forEach((roundMatches, rIdx) => {
      const sorted = roundMatches.slice().sort((a,b)=>(a.poolId||'').localeCompare(b.poolId||''));
      sorted.forEach(g => assignGameToBlock(g, rIdx));
    });

    const existing = schedules.find(s => s.division === division);
    const knockoutsExisting = existing && existing.knockouts ? existing.knockouts : [];
    schedules = schedules.filter(s => s.division !== division);
    schedules.push({division, games:assignedGames, knockouts:knockoutsExisting});
    saveSchedules();

    renderScheduleAdmin(division);
    renderSchedulePreview(division);
    renderKnockoutEditor();
  });

  function renderScheduleAdmin(division){
    const sched = schedules.find(s => s.division === division);
    scheduleAdmin.innerHTML = '';
    if (!sched || !sched.games.length){
      scheduleAdmin.innerHTML = '<div class="empty-note">No pool-play schedule yet for this division.</div>';
      return;
    }
    const gamesByPool = {};
    sched.games.filter(g => g.stage === 'pool').forEach(g => {
      const pool = g.poolId === 'cross'
        ? 'Cross Pool'
        : (getPoolForTeam(division,g.homeId)?.name || g.poolName || 'Pool');
      if (!gamesByPool[pool]) gamesByPool[pool] = [];
      gamesByPool[pool].push(g);
    });

    Object.keys(gamesByPool).forEach(poolName => {
      const block = document.createElement('div');
      block.style.marginTop = '8px';
      const title = document.createElement('div');
      title.innerHTML = `<strong>${poolName}</strong>`;
      block.appendChild(title);

      const games = gamesByPool[poolName];
      const allTeams = getAllTeams().filter(t => t.division === division);

      games.forEach(g => {
        const row = document.createElement('div');
        row.className = 'game-row';

        const dateInput = document.createElement('input');
        dateInput.className = 'admin-game-input';
        dateInput.value = g.date || '';
        dateInput.placeholder = 'Date';
        dateInput.addEventListener('input', () => {
          g.date = dateInput.value;
          saveSchedules();
          renderSchedulePreview(division);
        });

        const timeInput = document.createElement('input');
        timeInput.className = 'admin-game-input';
        timeInput.value = g.time || '';
        timeInput.placeholder = 'Time';
        timeInput.addEventListener('input', () => {
          g.time = timeInput.value;
          saveSchedules();
          renderSchedulePreview(division);
        });

        const fieldInput = document.createElement('input');
        fieldInput.className = 'admin-game-input';
        fieldInput.value = g.field || '';
        fieldInput.placeholder = 'Field';
        fieldInput.addEventListener('input', () => {
          g.field = fieldInput.value;
          saveSchedules();
          renderSchedulePreview(division);
        });

        const homeSel = document.createElement('select');
        homeSel.className = 'admin-game-input';
        const awaySel = document.createElement('select');
        awaySel.className = 'admin-game-input';

        function fillTeamSelect(sel, currentId){
          sel.innerHTML = '';
          const tbd = document.createElement('option');
          tbd.value = '';
          tbd.textContent = 'TBD';
          sel.appendChild(tbd);
          allTeams.forEach(t => {
            const o = document.createElement('option');
            o.value = String(t.id);
            o.textContent = t.teamName || 'Team';
            if (String(t.id) === String(currentId)) o.selected = true;
            sel.appendChild(o);
          });
        }
        fillTeamSelect(homeSel, g.homeId);
        fillTeamSelect(awaySel, g.awayId);

        homeSel.addEventListener('change', () => {
          g.homeId = homeSel.value;
          saveSchedules();
          renderSchedulePreview(division);
        });
        awaySel.addEventListener('change', () => {
          g.awayId = awaySel.value;
          saveSchedules();
          renderSchedulePreview(division);
        });

        row.appendChild(dateInput);
        row.appendChild(timeInput);
        row.appendChild(fieldInput);
        row.appendChild(homeSel);
        row.appendChild(document.createTextNode('vs'));
        row.appendChild(awaySel);

        block.appendChild(row);
      });

      scheduleAdmin.appendChild(block);
    });
  }

  // ========= KNOCKOUT GAMES ==========
  function getDivisionSchedule(division){
    return schedules.find(s => s.division === division) || {division, games:[], knockouts:[]};
  }

  function renderKnockoutEditor(){
    const division = schedDivisionSel.value;
    const sched = getDivisionSchedule(division);
    if (!sched.knockouts) sched.knockouts = [];

    const types = ['Semi 1','Semi 2','Consolation','Championship'];
    types.forEach(t => {
      if (!sched.knockouts.find(k => k.type === t)){
        sched.knockouts.push({
          id: `${division}_KO_${t.replace(' ','_')}`,
          division,
          type: t,
          date:'',
          time:'',
          field:'',
          homeId:'',
          awayId:''
        });
      }
    });

    sched.knockouts = sched.knockouts.filter(k => types.includes(k.type));
    schedules = schedules.filter(s => s.division !== division);
    schedules.push(sched);
    saveSchedules();

    knockoutEditor.innerHTML = '';
    const allTeams = getAllTeams().filter(t => t.division === division && (t.status === 'approved' || t.manual));

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    thead.innerHTML = '<tr><th>Game</th><th>Date</th><th>Time</th><th>Field</th><th>Home</th><th>Away</th></tr>';
    table.appendChild(thead);
    const tbody = document.createElement('tbody');

    sched.knockouts.forEach(k => {
      const tr = document.createElement('tr');

      const tdType = document.createElement('td');
      tdType.textContent = k.type;

      const dateInput = document.createElement('input');
      dateInput.className = 'admin-game-input';
      dateInput.value = k.date || '';
      dateInput.placeholder = 'e.g., Sunday (Apr 26)';
      dateInput.addEventListener('input', () => {
        k.date = dateInput.value;
        saveSchedules();
        renderSchedulePreview(division);
      });

      const timeInput = document.createElement('input');
      timeInput.className = 'admin-game-input';
      timeInput.value = k.time || '';
      timeInput.placeholder = 'e.g., 1:00pm';
      timeInput.addEventListener('input', () => {
        k.time = timeInput.value;
        saveSchedules();
        renderSchedulePreview(division);
      });

      const fieldInput = document.createElement('input');
      fieldInput.className = 'admin-game-input';
      fieldInput.value = k.field || '';
      fieldInput.placeholder = 'Field';
      fieldInput.addEventListener('input', () => {
        k.field = fieldInput.value;
        saveSchedules();
        renderSchedulePreview(division);
      });

      const homeSel = document.createElement('select');
      homeSel.className = 'admin-game-input';
      const awaySel = document.createElement('select');
      awaySel.className = 'admin-game-input';

      function fill(sel, currentId){
        sel.innerHTML = '';
        const tbd = document.createElement('option');
        tbd.value = '';
        tbd.textContent = 'TBD';
        sel.appendChild(tbd);
        allTeams.forEach(t => {
          const o = document.createElement('option');
          o.value = String(t.id);
          o.textContent = t.teamName || 'Team';
          if (String(t.id) === String(currentId)) o.selected = true;
          sel.appendChild(o);
        });
      }
      fill(homeSel, k.homeId);
      fill(awaySel, k.awayId);

      homeSel.addEventListener('change', () => {
        k.homeId = homeSel.value;
        saveSchedules();
        renderSchedulePreview(division);
      });
      awaySel.addEventListener('change', () => {
        k.awayId = awaySel.value;
        saveSchedules();
        renderSchedulePreview(division);
      });

      const tdDate  = document.createElement('td'); tdDate.appendChild(dateInput);
      const tdTime  = document.createElement('td'); tdTime.appendChild(timeInput);
      const tdField = document.createElement('td'); tdField.appendChild(fieldInput);
      const tdHome  = document.createElement('td'); tdHome.appendChild(homeSel);
      const tdAway  = document.createElement('td'); tdAway.appendChild(awaySel);

      tr.appendChild(tdType);
      tr.appendChild(tdDate);
      tr.appendChild(tdTime);
      tr.appendChild(tdField);
      tr.appendChild(tdHome);
      tr.appendChild(tdAway);

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    knockoutEditor.appendChild(table);
  }

  // ========= SCHEDULE PREVIEW ==========
  function renderSchedulePreview(division){
    const sched = schedules.find(s => s.division === division);
    schedulePreview.innerHTML = '';
    if (!sched){
      schedulePreview.innerHTML = '<div class="empty-note">No schedule yet for this division.</div>';
      return;
    }

    const poolGames = (sched.games || []).filter(g => g.stage === 'pool');
    const knockouts = sched.knockouts || [];

    if (!poolGames.length && !knockouts.length){
      schedulePreview.innerHTML = '<div class="empty-note">No games yet for this division.</div>';
      return;
    }

    const dates = new Set();
    poolGames.forEach(g => { if (g.date) dates.add(g.date); });
    knockouts.forEach(k => { if (k.date) dates.add(k.date); });

    const sortedDates = Array.from(dates);
    if (!sortedDates.length){
      schedulePreview.innerHTML = '<div class="empty-note">Assign dates to games to see the grid.</div>';
      return;
    }

    sortedDates.forEach(dateLabel => {
      const block = document.createElement('div');
      block.className = 'schedule-grid';
      const header = document.createElement('div');
      header.className = 'schedule-date-header';
      header.textContent = `${divisionLabel(division)} – ${dateLabel}`;
      block.appendChild(header);

      const dayPoolGames = poolGames.filter(g => g.date === dateLabel);
      const dayKO = knockouts.filter(k => k.date === dateLabel);

      const fields = [...new Set([
        ...dayPoolGames.map(g => g.field || 'Field'),
        ...dayKO.map(k => k.field || 'Field')
      ])];
      const times = [...new Set([
        ...dayPoolGames.map(g => g.time || ''),
        ...dayKO.map(k => k.time || '')
      ])].filter(Boolean);

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      const thTime = document.createElement('th');
      thTime.textContent = 'Time';
      headRow.appendChild(thTime);
      fields.forEach(f => {
        const th = document.createElement('th');
        th.textContent = f;
        th.className = 'schedule-field-header';
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      times.forEach(t => {
        const tr = document.createElement('tr');
        const tdTime = document.createElement('td');
        tdTime.textContent = t;
        tr.appendChild(tdTime);

        fields.forEach(f => {
          const td = document.createElement('td');
          const g = dayPoolGames.find(x => x.time === t && x.field === f);
          const k = dayKO.find(x => x.time === t && x.field === f);

          if (g){
            const home = g.homeId ? getTeamById(g.homeId) : null;
            const away = g.awayId ? getTeamById(g.awayId) : null;
            const poolName = getPoolForTeam(division,g.homeId)?.name || g.poolName || '';
            td.innerHTML = `<span class="highlight">${home ? home.teamName : 'TBD'} vs ${away ? away.teamName : 'TBD'}</span><br><span style="font-size:10px;">${poolName || 'Pool play'}</span>`;
          } else if (k){
            const home = k.homeId ? getTeamById(k.homeId) : null;
            const away = k.awayId ? getTeamById(k.awayId) : null;
            td.innerHTML =
              `<span class="highlight">${home ? home.teamName : 'TBD'} vs ${away ? away.teamName : 'TBD'}</span><br>` +
              `<span style="font-size:10px;">${k.type}</span>`;
          } else {
            td.textContent = '';
          }

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      block.appendChild(table);
      schedulePreview.appendChild(block);
    });
  }

  // ========= SCORING TAB ==========
  const scoreDivisionSel = document.getElementById('scoreDivision');
  const loadScoresBtn    = document.getElementById('loadScoresBtn');
  const scoringGamesDiv  = document.getElementById('scoringGames');
  const standingsOutput  = document.getElementById('standingsOutput');

  loadScoresBtn.addEventListener('click', () => {
    const division = scoreDivisionSel.value;
    renderScoringGames(division);
  });

  function renderScoringGames(division){
    const sched = schedules.find(s => s.division === division);
    scoringGamesDiv.innerHTML = '';
    standingsOutput.innerHTML = '';
    if (!sched || !sched.games.length){
      scoringGamesDiv.innerHTML = '<div class="empty-note">Generate a pool-play schedule first.</div>';
      return;
    }

    const games = sched.games.filter(g => g.stage === 'pool');
    const byPool = {};
    games.forEach(g => {
      const pool = g.poolId === 'cross'
        ? 'Cross Pool'
        : (getPoolForTeam(division,g.homeId)?.name || g.poolName || 'Pool');
      if (!byPool[pool]) byPool[pool] = [];
      byPool[pool].push(g);
    });

    Object.keys(byPool).forEach(poolName => {
      const h = document.createElement('h4');
      h.style.margin = '8px 0 4px';
      h.style.fontSize = '13px';
      h.textContent = `Pool ${poolName}`;
      scoringGamesDiv.appendChild(h);

      byPool[poolName].forEach(g => {
        const home = g.homeId ? getTeamById(g.homeId) : null;
        const away = g.awayId ? getTeamById(g.awayId) : null;
        const key = g.id;
        const existing = scores[key] || {home:'',away:''};

        const row = document.createElement('div');
        row.className = 'game-row';
        const label = document.createElement('span');
        label.innerHTML = `<strong>${g.date || ''}</strong> ${g.time || ''} @ ${g.field || ''} – ${(home && home.teamName) || 'TBD'} vs ${(away && away.teamName) || 'TBD'}`;
        row.appendChild(label);

        const homeInput = document.createElement('input');
        homeInput.type = 'number';
        homeInput.min = '0';
        homeInput.className = 'score-input';
        homeInput.value = existing.home === '' ? '' : existing.home;

        const awayInput = document.createElement('input');
        awayInput.type = 'number';
        awayInput.min = '0';
        awayInput.className = 'score-input';
        awayInput.value = existing.away === '' ? '' : existing.away;

        function handleChange(){
          const hVal = homeInput.value;
          const aVal = awayInput.value;
          if (hVal === '' && aVal === ''){
            delete scores[key];
          } else {
            scores[key] = {home:Number(hVal || 0), away:Number(aVal || 0)};
          }
          saveScoresStore();
          renderStandings(division);
        }

        homeInput.addEventListener('change', handleChange);
        awayInput.addEventListener('change', handleChange);

        row.appendChild(document.createTextNode(' '));
        row.appendChild(homeInput);
        row.appendChild(document.createTextNode(' - '));
        row.appendChild(awayInput);

        scoringGamesDiv.appendChild(row);
      });
    });

    renderStandings(division);
  }

  function renderStandings(division){
    const sched = schedules.find(s => s.division === division);
    standingsOutput.innerHTML = '';
    if (!sched || !sched.games.length) return;
    const games = sched.games.filter(g => g.stage === 'pool');

    const stats = {};

    function ensureTeam(id){
      id = String(id);
      if (!stats[id]){
        const t = getTeamById(id) || {};
        stats[id] = {
          id,
          name:t.teamName || 'Team',
          played:0,w:0,d:0,l:0, gf:0,ga:0, pts:0
        };
      }
      return stats[id];
    }

    games.forEach(g => {
      const key = g.id;
      const r = scores[key];
      if (!r) return;
      const hs = Number(r.home);
      const as = Number(r.away);
      if (isNaN(hs) || isNaN(as)) return;

      const home = ensureTeam(g.homeId);
      const away = ensureTeam(g.awayId);

      home.played++; away.played++;
      home.gf += hs; home.ga += as;
      away.gf += as; away.ga += hs;

      if (hs > as){ home.w++; away.l++; home.pts += 6; }
      else if (hs < as){ away.w++; home.l++; away.pts += 6; }
      else { home.d++; away.d++; home.pts += 3; away.pts += 3; }

      if (as === 0 && hs > 0) home.pts += 1;
      if (hs === 0 && as > 0) away.pts += 1;

      home.pts += Math.min(hs,3);
      away.pts += Math.min(as,3);
    });

    const rows = Object.values(stats);
    if (!rows.length){
      standingsOutput.innerHTML = '<div class="empty-note">Enter scores to see standings.</div>';
      return;
    }

    const byPool = {};
    rows.forEach(r => {
      const pool = getPoolForTeam(division,r.id);
      const key = pool ? pool.name : 'Unassigned';
      if (!byPool[key]) byPool[key] = [];
      byPool[key].push(r);
    });

    let html = '<h3 class="card-title">Standings by Pool</h3>';
    Object.keys(byPool).forEach(poolName => {
      const list = byPool[poolName].slice().sort((a,b) =>
        b.pts - a.pts || (b.gf-b.ga) - (a.gf-a.ga)
      );
      html += `<h4 style="margin:8px 0 4px;font-size:13px;">Pool ${poolName}</h4>`;
      html += '<table><thead><tr><th>Team</th><th>GP</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>Pts</th></tr></thead><tbody>';
      list.forEach(r => {
        html += `<tr>
          <td>${r.name}</td>
          <td>${r.played}</td>
          <td>${r.w}</td>
          <td>${r.d}</td>
          <td>${r.l}</td>
          <td>${r.gf}</td>
          <td>${r.ga}</td>
          <td>${r.pts}</td>
        </tr>`;
      });
      html += '</tbody></table>';
    });

    standingsOutput.innerHTML = html;
  }
</script>
</body>
</html>
