<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OSF 2026 – Admin Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root{
      --primary:#004b8d;
      --accent:#d62828;
      --bg:#f3f4f6;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top left,#dbeafe 0,#f9fafb 40%,#e5e7eb 100%);
      color:var(--text);
    }
    .page{
      max-width:1150px;
      margin:0 auto;
      padding:24px 16px 40px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(37,99,235,0.07);
      color:#1d4ed8;
      font-size:12px;
      font-weight:600;
      margin-bottom:6px;
    }
    h1{
      margin:0 0 4px;
      font-size:26px;
      letter-spacing:0.03em;
    }
    .subtitle{
      margin:0 0 8px;
      font-size:13px;
      color:var(--muted);
    }

    .top-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:14px;
      gap:8px;
      flex-wrap:wrap;
    }
    .top-bar-note{
      font-size:12px;
      color:#6b7280;
    }

    .tabs{
      display:flex;
      gap:6px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    .tab-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
      background:rgba(15,23,42,0.02);
      padding:7px 14px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:#374151;
    }
    .tab-btn.active{
      background:#111827;
      color:#fff;
      border-color:#0f172a;
    }
    .tab-panel{display:none;}
    .tab-panel.active{display:block;}

    .layout-two{
      display:grid;
      grid-template-columns:minmax(0,1.2fr) minmax(0,1fr);
      gap:16px;
    }
    @media(max-width:900px){
      .layout-two{grid-template-columns:1fr;}
    }

    .card{
      background:var(--card);
      border-radius:14px;
      box-shadow:0 16px 36px rgba(15,23,42,0.16);
      border:1px solid rgba(148,163,184,0.4);
      padding:14px 12px 14px;
      margin-bottom:14px;
    }
    .card-header{
      font-size:14px;
      font-weight:600;
      margin-bottom:4px;
    }
    .card-sub{
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
    }

    label{
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.06em;
      display:block;
      margin-bottom:3px;
      color:#6b7280;
    }
    select,input,textarea{
      width:100%;
      border-radius:9px;
      border:1px solid var(--border);
      padding:6px 8px;
      font-size:13px;
      font-family:inherit;
      outline:none;
      background:#f9fafb;
      transition:border-color .15s, box-shadow .15s, background .15s;
    }
    select:focus,input:focus,textarea:focus{
      border-color:#2563eb;
      background:#fff;
      box-shadow:0 0 0 1px rgba(37,99,235,0.25);
    }
    textarea{resize:vertical;min-height:60px;}

    .row{
      display:flex;
      gap:8px;
      margin-bottom:6px;
      flex-wrap:wrap;
    }
    .row>div{flex:1;}

    .btn{
      border-radius:999px;
      border:none;
      padding:7px 13px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-primary{
      background:linear-gradient(135deg,#2563eb,#1d4ed8);
      color:#fff;
      box-shadow:0 12px 22px rgba(37,99,235,0.35);
    }
    .btn-ghost{
      background:rgba(15,23,42,0.03);
      color:#111827;
      border:1px solid rgba(148,163,184,0.6);
    }
    .btn-small{
      padding:4px 9px;
      font-size:11px;
      box-shadow:none;
    }
    .btn-approve{background:#16a34a;color:#fff;}
    .btn-decline{background:#ef4444;color:#fff;}
    .btn-pending{background:#facc15;color:#111827;}

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
    }
    .status-pending{background:#fef9c3;color:#854d0e;}
    .status-approved{background:#dcfce7;color:#166534;}
    .status-declined{background:#fee2e2;color:#991b1b;}

    .team-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:420px;
      overflow:auto;
      padding-right:4px;
    }
    .team-card{
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      padding:8px 8px;
      font-size:12px;
    }
    .team-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:2px;
      flex-wrap:wrap;
    }
    .team-title{font-weight:600;font-size:13px;}
    .team-meta{font-size:11px;color:#6b7280;}
    .team-row{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-top:4px;
      flex-wrap:wrap;
    }
    .check-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:4px;
    }
    .check-row label{
      font-size:11px;
      text-transform:none;
      letter-spacing:0;
      font-weight:500;
      display:flex;
      align-items:center;
      gap:4px;
      color:#374151;
    }
    .check-row input[type="checkbox"]{
      width:auto;height:auto;
    }
    .note-input{
      width:100%;
      border-radius:8px;
      border:1px dashed #cbd5f5;
      background:#fff;
      padding:4px 6px;
      font-size:11px;
      margin-top:4px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 8px;
      border-radius:999px;
      background:#eff6ff;
      color:#1d4ed8;
      font-size:11px;
      font-weight:600;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      padding:2px 7px;
      font-size:11px;
      border-radius:999px;
      background:#e5e7eb;
      margin:2px 4px 2px 0;
    }
    .empty-note{
      font-size:12px;
      color:#9ca3af;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{
      padding:5px 6px;
      border:1px solid #e5e7eb;
      text-align:left;
    }
    th{
      background:#f3f4f6;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:#6b7280;
    }

    .toast{
      position:fixed;
      bottom:16px;
      right:16px;
      background:#111827;
      color:#f9fafb;
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      transform:translateY(8px);
      transition:all .2s ease-out;
      box-shadow:0 10px 25px rgba(15,23,42,0.35);
      z-index:50;
    }
    .toast.visible{
      opacity:1;
      transform:translateY(0);
    }

    .game-card{
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      padding:6px 8px;
      margin-bottom:6px;
      font-size:12px;
    }
    .game-header{
      display:flex;
      justify-content:space-between;
      gap:6px;
      margin-bottom:2px;
      flex-wrap:wrap;
    }
    .game-meta{
      font-size:11px;
      color:#6b7280;
    }

    /* AUTH GATE */
    #authGate{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at top,#1e293b,#020617);
      color:#e5e7eb;
      z-index:100;
    }
    .auth-card{
      width:100%;
      max-width:360px;
      background:#020617;
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.4);
      box-shadow:0 24px 60px rgba(0,0,0,0.7);
      padding:18px 18px 16px;
    }
    .auth-title{
      font-size:18px;
      font-weight:600;
      margin-bottom:4px;
    }
    .auth-sub{
      font-size:12px;
      color:#9ca3af;
      margin-bottom:12px;
    }
    .auth-label{
      font-size:11px;
      font-weight:600;
      letter-spacing:0.08em;
      text-transform:uppercase;
      margin-bottom:3px;
      color:#9ca3af;
    }
    .auth-input{
      width:100%;
      border-radius:10px;
      border:1px solid #4b5563;
      background:#020617;
      padding:7px 9px;
      color:#e5e7eb;
      font-size:13px;
      outline:none;
    }
    .auth-input:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,0.35);
    }
    .auth-error{
      font-size:11px;
      color:#f97316;
      margin-top:4px;
      min-height:14px;
    }
    .auth-footer{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:11px;
      color:#6b7280;
    }
  </style>
</head>
<body>

<!-- PASSWORD GATE -->
<div id="authGate">
  <div class="auth-card">
    <div class="badge" style="margin-bottom:8px;background:rgba(37,99,235,0.16);color:#bfdbfe;">
      OSF 2026 • Admin
    </div>
    <div class="auth-title">Tournament Admin Login</div>
    <div class="auth-sub">
      This page is for tournament staff. Enter the admin password to continue.
    </div>
    <div>
      <div class="auth-label">Password</div>
      <input id="authPassword" type="password" class="auth-input" placeholder="Enter password">
      <div id="authError" class="auth-error"></div>
    </div>
    <div style="margin-top:10px;display:flex;justify-content:flex-end;">
      <button id="authSubmit" class="btn btn-primary btn-small">Enter</button>
    </div>
    <div class="auth-footer">
      <span>Hint: same password used for admin access.</span>
      <span>AYSO • Area 10W</span>
    </div>
  </div>
</div>

<main id="adminMain" class="page" style="display:none;">
  <div class="badge">OSF 2026 • Tournament Admin</div>
  <h1>Admin Portal</h1>
  <p class="subtitle">
    One-stop view for teams, pools, schedules, and scoring.
  </p>

  <div class="top-bar">
    <div class="top-bar-note">
      Changes are saved to your <strong>OSF 2026 Tournament Teams</strong> spreadsheet (Teams + AdminState).
    </div>
    <button id="saveStateBtn" class="btn btn-primary btn-small">Save / Publish</button>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="teams">Teams</button>
    <button class="tab-btn" data-tab="pools">Pools</button>
    <button class="tab-btn" data-tab="schedule">Game Schedule</button>
    <button class="tab-btn" data-tab="scoring">Scoring</button>
  </div>

  <!-- TEAMS TAB -->
  <section id="tab-teams" class="tab-panel active">
    <div class="layout-two">
      <div>
        <div class="card">
          <div class="card-header">Filters</div>
          <div class="card-sub">Filter by division and status.</div>
          <div class="row">
            <div>
              <label>Division</label>
              <select id="teamsDivisionFilter">
                <option value="">All</option>
                <option value="10UB">10U Boys</option>
                <option value="10UG">10U Girls</option>
                <option value="12UB">12U Boys</option>
                <option value="12UG">12U Girls</option>
                <option value="14UB">14U Boys</option>
                <option value="14UG">14U Girls</option>
              </select>
            </div>
            <div>
              <label>Status</label>
              <select id="teamsStatusFilter">
                <option value="">All</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="declined">Declined</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Teams</div>
          <div class="card-sub">
            Approve, decline, or move teams back to pending. Toggle document checkboxes as paperwork is received.
          </div>
          <div id="teamsList" class="team-list"></div>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="card-header">Summary</div>
          <div class="card-sub">Counts by status (all divisions).</div>
          <div id="teamsSummary"></div>
        </div>
        <div class="card">
          <div class="card-header">Legend</div>
          <div class="card-sub">How this flows into the public pages.</div>
          <ul style="padding-left:18px;font-size:12px;margin:0;">
            <li><strong>Approved</strong> → appears on public Approved Teams.</li>
            <li>Schedules + scores → drive the public Schedule and Stats pages.</li>
            <li>Declined teams stay in the system and can be moved back to Pending.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- POOLS TAB -->
  <section id="tab-pools" class="tab-panel">
    <div class="layout-two">
      <div>
        <div class="card">
          <div class="card-header">Pools by Division</div>
          <div class="card-sub">Create pools, edit/delete, and see which teams are assigned.</div>
          <div class="row">
            <div>
              <label>Division</label>
              <select id="poolsDivisionSelect">
                <option value="10UB">10U Boys</option>
                <option value="10UG">10U Girls</option>
                <option value="12UB">12U Boys</option>
                <option value="12UG">12U Girls</option>
                <option value="14UB">14U Boys</option>
                <option value="14UG">14U Girls</option>
              </select>
            </div>
            <div>
              <label>New Pool Name</label>
              <div class="row" style="margin-bottom:0;">
                <div><input type="text" id="newPoolName" placeholder="Pool A"></div>
                <div style="flex:0 0 auto;">
                  <button class="btn btn-primary btn-small" id="addPoolBtn">Add Pool</button>
                </div>
              </div>
            </div>
          </div>
          <div id="poolsList" style="margin-top:8px;"></div>
        </div>

        <div class="card">
          <div class="card-header">Assign Teams to Pools</div>
          <div class="card-sub">Approved teams and manual placeholders.</div>
          <div id="poolTeamsArea"></div>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="card-header">Manual Teams</div>
          <div class="card-sub">Use this if you’re holding spots or need a placeholder team.</div>
          <div class="row">
            <div>
              <label>Team Name</label>
              <input type="text" id="manualTeamName" placeholder="Placeholder Team">
            </div>
          </div>
          <div class="row">
            <div>
              <label>Region #</label>
              <input type="number" id="manualTeamRegion" placeholder="304">
            </div>
            <div>
              <label>City</label>
              <input type="text" id="manualTeamCity" placeholder="Oxnard">
            </div>
            <div>
              <label>State</label>
              <input type="text" id="manualTeamState" placeholder="CA" maxlength="2">
            </div>
          </div>
          <button class="btn btn-primary btn-small" id="addManualTeamBtn">Add Manual Team</button>
          <div id="manualTeamsList" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- SCHEDULE TAB -->
  <section id="tab-schedule" class="tab-panel">
    <div class="layout-two">
      <div>
        <div class="card">
          <div class="card-header">Day & Field Configuration</div>
          <div class="card-sub">
            Configure days (Saturday/Sunday), fields, and times for pool-play games.
          </div>
          <div class="row">
            <div>
              <label>Division</label>
              <select id="schedDivisionSelect">
                <option value="10UB">10U Boys</option>
                <option value="10UG">10U Girls</option>
                <option value="12UB">12U Boys</option>
                <option value="12UG">12U Girls</option>
                <option value="14UB">14U Boys</option>
                <option value="14UG">14U Girls</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Date label</label>
              <input type="text" id="schedDayLabel" placeholder="Saturday">
            </div>
          </div>
          <div class="row">
            <div>
              <label>Fields (comma-separated)</label>
              <input type="text" id="schedFields" placeholder="Field 1, Field 2">
            </div>
          </div>
          <div class="row">
            <div>
              <label>Times (comma-separated)</label>
              <input type="text" id="schedTimes" placeholder="8:00am, 9:15am, 10:30am">
            </div>
          </div>
          <button class="btn btn-primary btn-small" id="addDayConfigBtn">Add Day</button>
          <div id="dayConfigsList" style="margin-top:10px;"></div>
        </div>

        <div class="card">
          <div class="card-header">Generate Pool-Play Schedule</div>
          <div class="card-sub">
            Uses pools and day configs. Tries to avoid back-to-back games and duplicate time slots.
          </div>
          <button class="btn btn-primary btn-small" id="generateScheduleBtn">Generate Schedule</button>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="card-header">Pool-Play Games</div>
          <div class="card-sub">Edit date, field, time, and teams if needed. You can also delete games.</div>
          <div id="gamesList" style="max-height:360px;overflow:auto;padding-right:4px;"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Knockout Games (Semis, Consolation, Final)</div>
      <div class="card-sub">These feed into the public schedule. You can leave teams as TBD.</div>
      <div id="knockoutsList"></div>
    </div>
  </section>

  <!-- SCORING TAB -->
  <section id="tab-scoring" class="tab-panel">
    <div class="card">
      <div class="card-header">Scoring & Standings</div>
      <div class="card-sub">
        Enter scores for pool-play games. Clearing scores resets that game.
      </div>
      <div class="row">
        <div style="max-width:220px;">
          <label>Division</label>
          <select id="scoreDivisionSelect">
            <option value="10UB">10U Boys</option>
            <option value="10UG">10U Girls</option>
            <option value="12UB">12U Boys</option>
            <option value="12UG">12U Girls</option>
            <option value="14UB">14U Boys</option>
            <option value="14UG">14U Girls</option>
          </select>
        </div>
      </div>
      <div id="scoringContent"></div>
    </div>
  </section>
</main>

<div id="toast" class="toast">Saved</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxTgz1zRnrtYvzsJraQeDKIdw5DY6-YFgs2FI87toZE7liLc1JXRgQbYcpIcmlhVczd/exec';
  const ADMIN_PASSWORD = 'PLAYSOCCER';

  const DIVISION_LABELS = {
    '10UB':'10U Boys',
    '10UG':'10U Girls',
    '12UB':'12U Boys',
    '12UG':'12U Girls',
    '14UB':'14U Boys',
    '14UG':'14U Girls'
  };

  let allTeams = [];
  let adminState = {
    manualTeams: [],
    pools: [],
    schedules: [],
    scores: {},
    dayConfigs: {}
  };

  const toastEl = document.getElementById('toast');
  const saveStateBtn = document.getElementById('saveStateBtn');
  let toastTimer = null;

  const authGate = document.getElementById('authGate');
  const adminMain = document.getElementById('adminMain');
  const authPasswordInput = document.getElementById('authPassword');
  const authSubmitBtn = document.getElementById('authSubmit');
  const authError = document.getElementById('authError');

  /* ===== Toast ===== */
  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('visible');
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toastEl.classList.remove('visible'),1500);
  }

  /* ===== Admin state normalize ===== */
  function normalizeState(state){
    if (!state || typeof state !== 'object') state = {};
    state.manualTeams = Array.isArray(state.manualTeams) ? state.manualTeams : [];
    state.pools = Array.isArray(state.pools) ? state.pools : [];
    state.schedules = Array.isArray(state.schedules) ? state.schedules : [];
    state.scores = state.scores && typeof state.scores === 'object' ? state.scores : {};
    state.dayConfigs = state.dayConfigs && typeof state.dayConfigs === 'object' ? state.dayConfigs : {};
    return state;
  }

  /* ===== Save to Apps Script (no JSON parse) ===== */
  async function saveStateToApi(showMessage = true){
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      // no Content-Type header -> avoids CORS preflight
      body: JSON.stringify({
        // doPost treats anything without mode=create/update as admin state
        state: adminState
      })
    });

    if (!res.ok) {
      console.error('Save HTTP error', res.status);
      if (showMessage) showToast('Save failed');
      return false;
    }

    // If you ever want to inspect response:
    // const text = await res.text(); console.log('Save response:', text);

    if (showMessage) showToast('Saved');
    return true;
  } catch (e) {
    console.error('Save fetch error', e);
    if (showMessage) showToast('Save failed');
    return false;
  }
}


  /* ===== Load from Apps Script ===== */
  async function loadAdminData(){
    try{
      const [teamsRes,stateRes] = await Promise.all([
        fetch(API_URL),
        fetch(API_URL+'?entity=state')
      ]);
      allTeams = await teamsRes.json();
      adminState = normalizeState(await stateRes.json());
      renderAll();
    }catch(e){
      console.error(e);
      showToast('Load error');
    }
  }

  function renderAll(){
    renderTeamsTab();
    refreshPoolsUI();
    renderManualTeams();
    renderDayConfigsUI();
    renderGamesUI();
    renderKnockoutsUI();
    renderScoringTab();
  }

  /* ===== AUTH GATE ===== */
  function unlockAdmin(){
    authGate.style.display = 'none';
    adminMain.style.display = 'block';
    loadAdminData();
  }

  function handleAuth(){
    const val = authPasswordInput.value.trim();
    if (val === ADMIN_PASSWORD){
      localStorage.setItem('osf2026_admin_authed','true');
      authError.textContent = '';
      unlockAdmin();
    }else{
      authError.textContent = 'Incorrect password. Please try again.';
    }
  }

  authSubmitBtn.addEventListener('click', handleAuth);
  authPasswordInput.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') handleAuth();
  });

  document.addEventListener('DOMContentLoaded', ()=>{
    const authed = localStorage.getItem('osf2026_admin_authed') === 'true';
    if (authed){
      unlockAdmin();
    }else{
      authGate.style.display = 'flex';
      adminMain.style.display = 'none';
    }
  });

  /* ===== Tabs ===== */
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const tab = btn.dataset.tab;
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.addEventListener('click',()=>{});
      btn.classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(p=>{
        p.classList.toggle('active',p.id==='tab-'+tab);
      });
    });
  });

  /* ---- TEAMS TAB ---- */
  const teamsDivisionFilter = document.getElementById('teamsDivisionFilter');
  const teamsStatusFilter = document.getElementById('teamsStatusFilter');
  const teamsListEl = document.getElementById('teamsList');
  const teamsSummaryEl = document.getElementById('teamsSummary');

  teamsDivisionFilter.addEventListener('change',renderTeamsTab);
  teamsStatusFilter.addEventListener('change',renderTeamsTab);

  function statusPill(status){
    const span=document.createElement('span');
    span.classList.add('status-pill');
    if(status==='approved'){span.classList.add('status-approved');span.textContent='Approved';}
    else if(status==='declined'){span.classList.add('status-declined');span.textContent='Declined';}
    else {span.classList.add('status-pending');span.textContent='Pending';}
    return span;
  }

  function renderTeamsTab(){
    if(!Array.isArray(allTeams)) allTeams=[];
    const divFilter = teamsDivisionFilter.value;
    const stFilter = teamsStatusFilter.value;
    let list = allTeams.slice();
    if(divFilter) list=list.filter(t=>t.division===divFilter);
    if(stFilter) list=list.filter(t=>String(t.status).toLowerCase()===stFilter);

    teamsListEl.innerHTML='';
    if(!list.length){
      teamsListEl.innerHTML='<div class="empty-note">No teams match the current filters.</div>';
    }else{
      list.forEach(team=>teamsListEl.appendChild(renderTeamCard(team)));
    }

    const pending = allTeams.filter(t=>String(t.status).toLowerCase()==='pending').length;
    const approved = allTeams.filter(t=>String(t.status).toLowerCase()==='approved').length;
    const declined = allTeams.filter(t=>String(t.status).toLowerCase()==='declined').length;

    teamsSummaryEl.innerHTML = `
      <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:12px;">
        <span class="pill">Pending: ${pending}</span>
        <span class="pill" style="background:#dcfce7;color:#166534;">Approved: ${approved}</span>
        <span class="pill" style="background:#fee2e2;color:#991b1b;">Declined: ${declined}</span>
      </div>
    `;
  }

  function renderTeamCard(team){
    const card=document.createElement('div');
    card.className='team-card';

    const header=document.createElement('div');
    header.className='team-header';

    const left=document.createElement('div');
    const title=document.createElement('div');
    title.className='team-title';
    title.textContent=team.teamName||'Team';
    const meta=document.createElement('div');
    meta.className='team-meta';
    const divLabel=DIVISION_LABELS[team.division]||team.division||'';
    meta.textContent=`${divLabel} • Region ${team.regionNumber||''} • ${team.city||''}, ${team.state||''}`;
    left.appendChild(title);left.appendChild(meta);

    const right=document.createElement('div');
    right.appendChild(statusPill(String(team.status).toLowerCase()));

    header.appendChild(left);header.appendChild(right);

    const row1=document.createElement('div');
    row1.className='team-row';
    row1.innerHTML=`
      <div><strong>Coach:</strong> ${team.coachName||''}</div>
      <div><strong>Email:</strong> ${team.coachEmail||''}</div>
      <div><strong>Phone:</strong> ${team.coachPhone||''}</div>
    `;

    const checks=document.createElement('div');
    checks.className='check-row';
    const docs=[
      {key:'docs_application',label:'Application'},
      {key:'docs_roster',label:'Roster'},
      {key:'docs_check',label:'Check'}
    ];
    docs.forEach(d=>{
      const lbl=document.createElement('label');
      const cb=document.createElement('input');
      cb.type='checkbox';
      cb.checked=!!team[d.key];
      cb.addEventListener('change',()=>{
        const updated=Object.assign({},team,{[d.key]:cb.checked?1:0});
        updateTeamOnServer(updated);
      });
      lbl.appendChild(cb);
      lbl.append(' '+d.label);
      checks.appendChild(lbl);
    });

    const actions=document.createElement('div');
    actions.className='team-row';
    const leftActions=document.createElement('div');
    const rightActions=document.createElement('div');

    const btnApprove=document.createElement('button');
    btnApprove.className='btn btn-approve btn-small';
    btnApprove.textContent='Approve';
    btnApprove.addEventListener('click',()=>changeTeamStatus(team,'approved'));

    const btnPending=document.createElement('button');
    btnPending.className='btn btn-pending btn-small';
    btnPending.textContent='Set Pending';
    btnPending.addEventListener('click',()=>changeTeamStatus(team,'pending'));

    const btnDecline=document.createElement('button');
    btnDecline.className='btn btn-decline btn-small';
    btnDecline.textContent='Decline';
    btnDecline.addEventListener('click',()=>changeTeamStatus(team,'declined'));

    leftActions.appendChild(btnApprove);
    leftActions.appendChild(btnPending);
    leftActions.appendChild(btnDecline);

    const noteInput=document.createElement('input');
    noteInput.className='note-input';
    noteInput.placeholder='Internal note (not public)';
    noteInput.value=team.internalNote||'';
    noteInput.addEventListener('change',()=>{
      const updated=Object.assign({},team,{internalNote:noteInput.value});
      updateTeamOnServer(updated);
    });
    rightActions.appendChild(noteInput);

    actions.appendChild(leftActions);
    actions.appendChild(rightActions);

    card.appendChild(header);
    card.appendChild(row1);
    card.appendChild(checks);
    card.appendChild(actions);
    return card;
  }

 async function updateTeamOnServer(updatedTeam){
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      // no Content-Type header -> avoids CORS preflight
      body: JSON.stringify({ mode: 'update', team: updatedTeam })
    });

    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch (err) {
      console.error('Non-JSON response from Apps Script on update:', text);
      showToast('Update failed');
      return;
    }

    if (!data.ok) {
      console.error('Update failed:', data.error);
      showToast('Update failed');
      return;
    }

    const idx = allTeams.findIndex(t => String(t.id) === String(updatedTeam.id));
    if (idx !== -1) allTeams[idx] = updatedTeam;

    renderTeamsTab();
    showToast('Team updated');
  } catch (e) {
    console.error('Update fetch error', e);
    showToast('Update failed');
  }
}


  /* ---- POOLS TAB ---- */
  const poolsDivisionSel=document.getElementById('poolsDivisionSelect');
  const newPoolNameInput=document.getElementById('newPoolName');
  const addPoolBtn=document.getElementById('addPoolBtn');
  const poolsList=document.getElementById('poolsList');
  const poolTeamsArea=document.getElementById('poolTeamsArea');
  const manualTeamNameInput=document.getElementById('manualTeamName');
  const manualTeamRegionInput=document.getElementById('manualTeamRegion');
  const manualTeamCityInput=document.getElementById('manualTeamCity');
  const manualTeamStateInput=document.getElementById('manualTeamState');
  const addManualTeamBtn=document.getElementById('addManualTeamBtn');
  const manualTeamsList=document.getElementById('manualTeamsList');

  poolsDivisionSel.addEventListener('change',()=>{
    refreshPoolsUI();
    renderManualTeams();
  });

  addPoolBtn.addEventListener('click',()=>{
    const name=newPoolNameInput.value.trim();
    const division=poolsDivisionSel.value;
    if(!name) return;
    const pool={id:'P_'+division+'_'+Date.now(),division,name,teamIds:[]};
    adminState.pools.push(pool);
    newPoolNameInput.value='';
    saveStateToApi(false);
    refreshPoolsUI();
  });

  addManualTeamBtn.addEventListener('click',()=>{
    const division=poolsDivisionSel.value;
    const name=manualTeamNameInput.value.trim();
    if(!name) return;
    const manualTeam={
      id:'M_'+Date.now(),
      division,
      teamName:name,
      regionNumber:manualTeamRegionInput.value||'',
      city:manualTeamCityInput.value||'',
      state:manualTeamStateInput.value||'',
      manual:true
    };
    adminState.manualTeams.push(manualTeam);
    manualTeamNameInput.value='';
    manualTeamRegionInput.value='';
    manualTeamCityInput.value='';
    manualTeamStateInput.value='';
    saveStateToApi(false);
    refreshPoolsUI();
    renderManualTeams();
  });

  function getPoolsForDivision(division){
    return adminState.pools.filter(p=>p.division===division);
  }
  function getAllTeamsCombined(){
    const manual = adminState.manualTeams.map(m=>Object.assign({manual:true},m));
    return allTeams.concat(manual);
  }
  function getAllTeamsForDivision(division){
    return getAllTeamsCombined().filter(t=>t.division===division);
  }

  function assignTeamToPool(division,teamId,poolId){
    const idStr=String(teamId);
    adminState.pools.forEach(p=>{
      if(p.division===division){
        p.teamIds=(p.teamIds||[]).map(String).filter(id=>id!==idStr);
      }
    });
    if(poolId){
      const pool=adminState.pools.find(p=>p.id===poolId);
      if(pool){
        pool.teamIds=pool.teamIds||[];
        if(!pool.teamIds.map(String).includes(idStr)){
          pool.teamIds.push(idStr);
        }
      }
    }
    saveStateToApi(false);
    refreshPoolsUI();
  }

  function divisionLabel(code){
    return DIVISION_LABELS[code]||code||'';
  }

  function renderManualTeams(){
    const division=poolsDivisionSel.value;
    const manual=adminState.manualTeams.filter(m=>m.division===division);
    manualTeamsList.innerHTML='';
    if(!manual.length){
      manualTeamsList.innerHTML='<div class="empty-note">No manual teams for this division.</div>';
      return;
    }
    manual.forEach(m=>{
      const row=document.createElement('div');
      row.style.fontSize='12px';
      row.style.marginBottom='3px';
      row.innerHTML=`
        <span class="tag">${m.teamName}</span>
        <span class="team-meta">Region ${m.regionNumber||''} • ${m.city||''} ${m.state||''}</span>
      `;
      manualTeamsList.appendChild(row);
    });
  }

  function refreshPoolsUI(){
    const division=poolsDivisionSel.value;
    const relevantTeams=getAllTeamsForDivision(division)
      .filter(t=>String(t.status).toLowerCase()==='approved' || t.manual);

    poolTeamsArea.innerHTML='';
    if(!relevantTeams.length){
      poolTeamsArea.innerHTML='<span class="empty-note">No approved or manual teams yet.</span>';
    }else{
      relevantTeams.forEach(team=>{
        const div=document.createElement('div');
        div.className='pill';
        const nameSpan=document.createElement('span');
        nameSpan.innerHTML=`<strong>${team.teamName||'Team'}</strong>`;
        const sub=document.createElement('span');
        sub.style.fontSize='11px';
        sub.style.color='#6b7280';
        sub.textContent=team.manual?'Manual':`Region ${team.regionNumber||''}`;
        div.appendChild(nameSpan);
        div.appendChild(sub);

        const select=document.createElement('select');
        select.style.marginLeft='8px';
        const noneOpt=document.createElement('option');
        noneOpt.value='';noneOpt.textContent='No pool';
        select.appendChild(noneOpt);

        const poolsForDiv=getPoolsForDivision(division);
        poolsForDiv.forEach(p=>{
          const o=document.createElement('option');
          o.value=p.id;o.textContent=p.name;
          if((p.teamIds||[]).map(String).includes(String(team.id))) o.selected=true;
          select.appendChild(o);
        });
        select.addEventListener('change',()=>assignTeamToPool(division,team.id,select.value));
        div.appendChild(select);
        poolTeamsArea.appendChild(div);
      });
    }

    poolsList.innerHTML='';
    const poolsForDiv=getPoolsForDivision(division);
    if(!poolsForDiv.length){
      poolsList.innerHTML='<div class="empty-note">No pools created yet.</div>';
      return;
    }
    poolsForDiv.forEach(pool=>{
      const container=document.createElement('div');
      container.style.marginTop='8px';

      const header=document.createElement('div');
      header.style.display='flex';
      header.style.alignItems='center';
      header.style.gap='6px';
      header.style.flexWrap='wrap';

      const title=document.createElement('div');
      title.innerHTML=`<strong>${pool.name}</strong> <span style="font-size:11px;color:#6b7280;">(${divisionLabel(pool.division)})</span>`;
      header.appendChild(title);

      const editBtn=document.createElement('button');
      editBtn.className='btn btn-ghost btn-small';
      editBtn.style.fontSize='10px';
      editBtn.textContent='Edit';
      editBtn.addEventListener('click',()=>{
        const newName=prompt('New pool name:',pool.name);
        if(newName && newName.trim()){
          pool.name=newName.trim();
          saveStateToApi(false);
          refreshPoolsUI();
          renderGamesUI();
        }
      });

      const delBtn=document.createElement('button');
      delBtn.className='btn btn-decline btn-small';
      delBtn.style.fontSize='10px';
      delBtn.textContent='Delete';
      delBtn.addEventListener('click',()=>{
        if(!confirm(`Delete ${pool.name}? Teams will be unassigned.`)) return;
        adminState.pools=adminState.pools.filter(p=>p.id!==pool.id);
        saveStateToApi(false);
        refreshPoolsUI();
        renderGamesUI();
      });

      header.appendChild(editBtn);
      header.appendChild(delBtn);

      const body=document.createElement('div');
      body.style.marginTop='4px';
      const members=getAllTeamsCombined().filter(t=>(pool.teamIds||[]).map(String).includes(String(t.id)));
      if(!members.length){
        body.innerHTML='<span class="empty-note">No teams assigned yet.</span>';
      }else{
        members.forEach(m=>{
          const tag=document.createElement('span');
          tag.className='tag';
          tag.textContent=m.teamName||'Team';
          body.appendChild(tag);
        });
      }

      container.appendChild(header);
      container.appendChild(body);
      poolsList.appendChild(container);
    });
  }

  /* ---- SCHEDULE HELPERS ---- */
  function getScheduleForDivision(division){
    let sched = adminState.schedules.find(s=>s.division===division);
    if(!sched){
      sched={division,games:[],knockouts:[]};
      adminState.schedules.push(sched);
    }
    sched.games=Array.isArray(sched.games)?sched.games:[];
    sched.knockouts=Array.isArray(sched.knockouts)?sched.knockouts:[];
    return sched;
  }
  function getDayConfigsForDivision(division){
    adminState.dayConfigs=adminState.dayConfigs||{};
    if(!adminState.dayConfigs[division]) adminState.dayConfigs[division]=[];
    return adminState.dayConfigs[division];
  }
  function getTeamByIdAll(id){
    id=String(id);
    return getAllTeamsCombined().find(t=>String(t.id)===id)||null;
  }

  /* ---- SCHEDULE TAB ---- */
  const schedDivisionSelect=document.getElementById('schedDivisionSelect');
  const schedDayLabelInput=document.getElementById('schedDayLabel');
  const schedFieldsInput=document.getElementById('schedFields');
  const schedTimesInput=document.getElementById('schedTimes');
  const addDayConfigBtn=document.getElementById('addDayConfigBtn');
  const dayConfigsList=document.getElementById('dayConfigsList');
  const generateScheduleBtn=document.getElementById('generateScheduleBtn');
  const gamesListEl=document.getElementById('gamesList');
  const knockoutsListEl=document.getElementById('knockoutsList');

  schedDivisionSelect.addEventListener('change',()=>{
    renderDayConfigsUI();
    renderGamesUI();
    renderKnockoutsUI();
  });

  addDayConfigBtn.addEventListener('click',()=>{
    const division=schedDivisionSelect.value;
    const label=schedDayLabelInput.value.trim();
    const fieldsStr=schedFieldsInput.value.trim();
    const timesStr=schedTimesInput.value.trim();
    if(!label || !fieldsStr || !timesStr) return;
    const cfgs=getDayConfigsForDivision(division);
    cfgs.push({id:'D_'+Date.now(),label,fields:fieldsStr,times:timesStr});
    schedDayLabelInput.value='';
    schedFieldsInput.value='';
    schedTimesInput.value='';
    saveStateToApi(false);
    renderDayConfigsUI();
  });

  function renderDayConfigsUI(){
    const division=schedDivisionSelect.value;
    const cfgs=getDayConfigsForDivision(division);
    dayConfigsList.innerHTML='';
    if(!cfgs.length){
      dayConfigsList.innerHTML='<div class="empty-note">No day configuration yet.</div>';
      return;
    }
    cfgs.forEach(cfg=>{
      const row=document.createElement('div');
      row.style.fontSize='12px';
      row.style.marginBottom='4px';
      row.innerHTML=`<strong>${cfg.label}</strong> – Fields: ${cfg.fields} • Times: ${cfg.times}`;
      const btn=document.createElement('button');
      btn.className='btn btn-ghost btn-small';
      btn.style.marginTop='2px';
      btn.textContent='Delete';
      btn.addEventListener('click',()=>{
        const list=getDayConfigsForDivision(division);
        adminState.dayConfigs[division]=list.filter(c=>c.id!==cfg.id);
        saveStateToApi(false);
        renderDayConfigsUI();
      });
      row.appendChild(document.createElement('br'));
      row.appendChild(btn);
      dayConfigsList.appendChild(row);
    });
  }

  generateScheduleBtn.addEventListener('click',()=>{
    const division=schedDivisionSelect.value;
    const pools=getPoolsForDivision(division);
    const cfgs=getDayConfigsForDivision(division);
    if(!pools.length){alert('Create pools first.');return;}
    if(!cfgs.length){alert('Add at least one day configuration first.');return;}

    const slots=[];
    cfgs.forEach(cfg=>{
      const fields=cfg.fields.split(',').map(s=>s.trim()).filter(Boolean);
      const times=cfg.times.split(',').map(s=>s.trim()).filter(Boolean);
      times.forEach(time=>{
        fields.forEach(field=>{
          slots.push({date:cfg.label,time,field});
        });
      });
    });
    if(!slots.length){alert('No usable slots from your day configuration.');return;}

    const sched=getScheduleForDivision(division);
    sched.games=[];

    const allGames=[];
    pools.forEach(pool=>{
      const ids=(pool.teamIds||[]).map(String);
      for(let i=0;i<ids.length;i++){
        for(let j=i+1;j<ids.length;j++){
          allGames.push({
            id:'G_'+division+'_'+Date.now()+'_'+i+'_'+j,
            division,
            poolId:pool.id,
            homeId:ids[i],
            awayId:ids[j],
            stage:'pool'
          });
        }
      }
    });

    const gamesPerTeam={};
    function canScheduleGame(game,slot){
      const t1=game.homeId,t2=game.awayId;
      const alreadyAtTime=sched.games.some(g=>g.date===slot.date && g.time===slot.time && (g.homeId===t1||g.awayId===t1||g.homeId===t2||g.awayId===t2));
      if(alreadyAtTime) return false;
      const g1=gamesPerTeam[t1]||0,g2=gamesPerTeam[t2]||0;
      if(g1>=3 || g2>=3) return false;
      return true;
    }

    let slotIdx=0;
    allGames.forEach(game=>{
      let placed=false;
      let tries=0;
      while(!placed && tries<slots.length){
        const slot=slots[slotIdx%slots.length];
        if(canScheduleGame(game,slot)){
          const g=Object.assign({},game,{
            date:slot.date,
            time:slot.time,
            field:slot.field
          });
          sched.games.push(g);
          gamesPerTeam[game.homeId]=(gamesPerTeam[game.homeId]||0)+1;
          gamesPerTeam[game.awayId]=(gamesPerTeam[game.awayId]||0)+1;
          placed=true;
        }
        slotIdx++;tries++;
      }
    });

    saveStateToApi(false);
    renderGamesUI();
    renderScoringTab();  // make sure games appear on scoring tab right away
    showToast('Schedule generated');
  });

  function renderGamesUI(){
    const division=schedDivisionSelect.value;
    const sched=getScheduleForDivision(division);
    const games=sched.games||[];
    gamesListEl.innerHTML='';
    if(!games.length){
      gamesListEl.innerHTML='<div class="empty-note">No games for this division yet.</div>';
      return;
    }
    games.forEach(g=>{
      const card=document.createElement('div');
      card.className='game-card';

      const header=document.createElement('div');
      header.className='game-header';
      const teamsSpan=document.createElement('div');
      const home=getTeamByIdAll(g.homeId);
      const away=getTeamByIdAll(g.awayId);
      teamsSpan.textContent=`${home?home.teamName:'TBD'} vs ${away?away.teamName:'TBD'}`;

      const rightWrap=document.createElement('div');
      rightWrap.style.display='flex';
      rightWrap.style.gap='6px';
      rightWrap.style.alignItems='center';
      rightWrap.style.flexWrap='wrap';

      const meta=document.createElement('div');
      meta.className='game-meta';
      meta.textContent=`${g.date||''} • ${g.time||''} • ${g.field||''}`;

      const delBtn=document.createElement('button');
      delBtn.className='btn btn-decline btn-small';
      delBtn.textContent='Delete';
      delBtn.addEventListener('click',()=>{
        const schedDiv=getScheduleForDivision(division);
        schedDiv.games = (schedDiv.games||[]).filter(game=>game.id!==g.id);
        saveStateToApi(false);
        renderGamesUI();
        renderScoringTab();
      });

      rightWrap.appendChild(meta);
      rightWrap.appendChild(delBtn);

      header.appendChild(teamsSpan);
      header.appendChild(rightWrap);

      const row=document.createElement('div');
      row.className='row';
      const d1=document.createElement('div');
      d1.innerHTML='<label>Date</label>';
      const dateInput=document.createElement('input');
      dateInput.value=g.date||'';
      dateInput.addEventListener('change',()=>{g.date=dateInput.value;saveStateToApi(false);renderScoringTab();});
      d1.appendChild(dateInput);

      const d2=document.createElement('div');
      d2.innerHTML='<label>Time</label>';
      const timeInput=document.createElement('input');
      timeInput.value=g.time||'';
      timeInput.addEventListener('change',()=>{g.time=timeInput.value;saveStateToApi(false);renderScoringTab();});
      d2.appendChild(timeInput);

      const d3=document.createElement('div');
      d3.innerHTML='<label>Field</label>';
      const fieldInput=document.createElement('input');
      fieldInput.value=g.field||'';
      fieldInput.addEventListener('change',()=>{g.field=fieldInput.value;saveStateToApi(false);});
      d3.appendChild(fieldInput);

      row.appendChild(d1);row.appendChild(d2);row.appendChild(d3);

      card.appendChild(header);
      card.appendChild(row);
      gamesListEl.appendChild(card);
    });
  }

  function renderKnockoutsUI(){
    const division=schedDivisionSelect.value;
    const sched=getScheduleForDivision(division);
    const allDivTeams=getAllTeamsForDivision(division);

    if(!sched.knockouts.length){
      sched.knockouts=[
        {id:'KO_'+division+'_S1',division,type:'Semi 1',date:'',time:'',field:'',homeId:null,awayId:null},
        {id:'KO_'+division+'_S2',division,type:'Semi 2',date:'',time:'',field:'',homeId:null,awayId:null},
        {id:'KO_'+division+'_C',division,type:'Consolation',date:'',time:'',field:'',homeId:null,awayId:null},
        {id:'KO_'+division+'_F',division,type:'Final',date:'',time:'',field:'',homeId:null,awayId:null}
      ];
    }

    knockoutsListEl.innerHTML='';
    sched.knockouts.forEach(k=>{
      const card=document.createElement('div');
      card.className='game-card';
      const header=document.createElement('div');
      header.className='game-header';
      const title=document.createElement('div');
      title.textContent=k.type;
      const meta=document.createElement('div');
      meta.className='game-meta';
      meta.textContent=`${k.date||''} • ${k.time||''} • ${k.field||''}`;
      header.appendChild(title);header.appendChild(meta);

      const row1=document.createElement('div');
      row1.className='row';
      const d1=document.createElement('div');
      d1.innerHTML='<label>Date</label>';
      const dateInput=document.createElement('input');
      dateInput.value=k.date||'';
      dateInput.addEventListener('change',()=>{k.date=dateInput.value;saveStateToApi(false);});
      d1.appendChild(dateInput);

      const d2=document.createElement('div');
      d2.innerHTML='<label>Time</label>';
      const timeInput=document.createElement('input');
      timeInput.value=k.time||'';
      timeInput.addEventListener('change',()=>{k.time=timeInput.value;saveStateToApi(false);});
      d2.appendChild(timeInput);

      const d3=document.createElement('div');
      d3.innerHTML='<label>Field</label>';
      const fieldInput=document.createElement('input');
      fieldInput.value=k.field||'';
      fieldInput.addEventListener('change',()=>{k.field=fieldInput.value;saveStateToApi(false);});
      d3.appendChild(fieldInput);

      row1.appendChild(d1);row1.appendChild(d2);row1.appendChild(d3);

      const row2=document.createElement('div');
      row2.className='row';
      const h1=document.createElement('div');
      h1.innerHTML='<label>Home</label>';
      const homeSel=document.createElement('select');
      const optHNone=document.createElement('option');
      optHNone.value='';optHNone.textContent='TBD';
      homeSel.appendChild(optHNone);
      allDivTeams.forEach(t=>{
        const o=document.createElement('option');
        o.value=t.id;o.textContent=t.teamName;
        if(String(k.homeId)===String(t.id)) o.selected=true;
        homeSel.appendChild(o);
      });
      homeSel.addEventListener('change',()=>{k.homeId=homeSel.value||null;saveStateToApi(false);});
      h1.appendChild(homeSel);

      const h2=document.createElement('div');
      h2.innerHTML='<label>Away</label>';
      const awaySel=document.createElement('select');
      const optANone=document.createElement('option');
      optANone.value='';optANone.textContent='TBD';
      awaySel.appendChild(optANone);
      allDivTeams.forEach(t=>{
        const o=document.createElement('option');
        o.value=t.id;o.textContent=t.teamName;
        if(String(k.awayId)===String(t.id)) o.selected=true;
        awaySel.appendChild(o);
      });
      awaySel.addEventListener('change',()=>{k.awayId=awaySel.value||null;saveStateToApi(false);});
      h2.appendChild(awaySel);

      row2.appendChild(h1);row2.appendChild(h2);

      card.appendChild(header);
      card.appendChild(row1);
      card.appendChild(row2);
      knockoutsListEl.appendChild(card);
    });
  }

  /* ---- SCORING ---- */
  const scoreDivisionSelect=document.getElementById('scoreDivisionSelect');
  const scoringContent=document.getElementById('scoringContent');

  scoreDivisionSelect.addEventListener('change',renderScoringTab);

  function renderScoringTab(){
    const division=scoreDivisionSelect.value;
    const sched=getScheduleForDivision(division);
    const games=(sched.games||[]).filter(g=>g.stage==='pool');
    scoringContent.innerHTML='';
    if(!games.length){
      scoringContent.innerHTML='<div class="empty-note">No pool-play games yet for this division.</div>';
      return;
    }

    const poolsById={};
    adminState.pools.forEach(p=>{poolsById[p.id]=p;});

    const byPool={};
    games.forEach(g=>{
      const poolName=poolsById[g.poolId]?.name || 'Unassigned';
      if(!byPool[poolName]) byPool[poolName]=[];
      byPool[poolName].push(g);
    });

    Object.keys(byPool).forEach(poolName=>{
      const section=document.createElement('div');
      const title=document.createElement('div');
      title.className='card-header';
      title.textContent='Pool '+poolName;
      section.appendChild(title);

      byPool[poolName].forEach(g=>{
        const row=document.createElement('div');
        row.className='game-card';
        const header=document.createElement('div');
        header.className='game-header';
        const home=getTeamByIdAll(g.homeId);
        const away=getTeamByIdAll(g.awayId);
        const label=document.createElement('div');
        label.textContent=`${home?home.teamName:'TBD'} vs ${away?away.teamName:'TBD'}`;
        const meta=document.createElement('div');
        meta.className='game-meta';
        meta.textContent=`${g.date||''} • ${g.time||''} • ${g.field||''}`;
        header.appendChild(label);header.appendChild(meta);

        const scoreRow=document.createElement('div');
        scoreRow.className='row';
        const s1=document.createElement('div');
        s1.innerHTML='<label>Home</label>';
        const homeInput=document.createElement('input');
        homeInput.type='number';
        homeInput.min='0';
        const sData=adminState.scores[g.id]||{};
        homeInput.value=(sData.home!=null)?sData.home:'';
        homeInput.addEventListener('change',()=>{
          const val=homeInput.value===''?null:Number(homeInput.value);
          if(!adminState.scores[g.id]) adminState.scores[g.id]={};
          adminState.scores[g.id].home=val;
          saveStateToApi(false);
        });
        s1.appendChild(homeInput);

        const s2=document.createElement('div');
        s2.innerHTML='<label>Away</label>';
        const awayInput=document.createElement('input');
        awayInput.type='number';
        awayInput.min='0';
        awayInput.value=(sData.away!=null)?sData.away:'';
        awayInput.addEventListener('change',()=>{
          const val=awayInput.value===''?null:Number(awayInput.value);
          if(!adminState.scores[g.id]) adminState.scores[g.id]={};
          adminState.scores[g.id].away=val;
          saveStateToApi(false);
        });
        s2.appendChild(awayInput);

        const s3=document.createElement('div');
        s3.innerHTML='<label>&nbsp;</label>';
        const clearBtn=document.createElement('button');
        clearBtn.className='btn btn-ghost btn-small';
        clearBtn.textContent='Clear';
        clearBtn.addEventListener('click',()=>{
          delete adminState.scores[g.id];
          homeInput.value='';
          awayInput.value='';
          saveStateToApi(false);
        });
        s3.appendChild(clearBtn);

        scoreRow.appendChild(s1);scoreRow.appendChild(s2);scoreRow.appendChild(s3);

        row.appendChild(header);
        row.appendChild(scoreRow);
        section.appendChild(row);
      });

      scoringContent.appendChild(section);
    });
  }
</script>
</body>
</html>
