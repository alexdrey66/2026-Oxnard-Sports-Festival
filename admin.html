<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OSF 2026 â€“ Admin Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
  /* <<< UPDATE THESE WITH YOUR EXACT CANVA HEX VALUES IF NEEDED >>> */
  --bg-deep: #020b2d;      /* main background */
  --bg-mid:  #041432;      /* mid blue */
  --bg-card: #071a3f;      /* card blue */
  --navy:    #0b1f4a;      /* strong navy */

  --accent:        #fbbf24;
  --accent-strong: #f59e0b;
  --accent-soft:   #facc15;

  --outline: #1f2937;
  --muted:   #9ca3af;
  --text:    #e5e7eb;

  --danger:  #ef4444;
  --success: #22c55e;
  --pending: #facc15;
}

* {
  box-sizing: border-box;
}

html,
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      /* Canva background */
      background:linear-gradient(135deg, #124175 0%, #1a5a8a 100%);
      color:var(--text);
    }

    /* ---------------- LOGIN (CANVA STYLE) ---------------- */

    /* AUTH GATE â€“ Canva-style login screen */
    #authGate{
      position:fixed;
      inset:0;
      display:flex;
      justify-content:center;
      align-items:center;
      background:linear-gradient(135deg,#124175 0%,#1a5a8a 100%);
      z-index:100;
      color:#0f172a;
    }

    .auth-shell{
      width:100%;
      max-width:960px;
      padding:40px 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:24px;
    }

    .auth-portal-title{
      margin:0;
      font-size:40px;
      font-weight:800;
      color:#ffffff;
      letter-spacing:0.08em;
      text-transform:uppercase;
      text-align:center;
    }

    .auth-underline{
      width:90px;
      height:4px;
      border-radius:999px;
      background:#faca3d;
    }

.auth-card{
  background:#ffffff;
  border-radius:28px;
  padding:60px 36px 28px; /* extra top padding */
  max-width:420px;
  width:100%;
  box-shadow:0 22px 45px rgba(15,23,42,0.45);
  text-align:left;
  position:relative;
  overflow:visible; /* allow icon to float above */
}


.auth-icon-circle{
  width:72px;
  height:72px;
  border-radius:999px;
  background:linear-gradient(135deg,#124175 0%,#1a5a8a 100%);
  display:flex;
  align-items:center;
  justify-content:center;
  position:absolute;
  top:-36px;        /* pulls it halfway above the card */
  left:50%;
  transform:translateX(-50%);
  box-shadow:0 12px 30px rgba(15,23,42,0.45);
}


    .auth-icon-circle span{
      font-size:28px;
      color:#faca3d;
    }

    .auth-title{
      margin:0 0 4px;
      font-size:22px;
      font-weight:800;
      text-align:center;
      color:#124175;
      letter-spacing:0.05em;
    }

    .auth-sub{
      margin:0 0 20px;
      font-size:14px;
      text-align:center;
      color:#6b7280;
    }

    .auth-field{
      margin-top:8px;
    }

    .auth-label{
      font-size:11px;
      font-weight:700;
      letter-spacing:0.12em;
      text-transform:uppercase;
      margin-bottom:4px;
      color:#1f2937;
    }

    .auth-input{
      width:100%;
      border-radius:14px;
      border:1px solid #e5e7eb;
      padding:10px 12px;
      font-size:14px;
      background:#f9fafb;
      color:#111827;
      outline:none;
      transition:border-color .15s, box-shadow .15s, background .15s;
    }

    .auth-input:focus{
      border-color:#124175;
      background:#ffffff;
      box-shadow:0 0 0 3px rgba(18,65,117,0.18);
    }

    .auth-login-btn{
      width:100%;
      margin-top:22px;
      border-radius:18px;
      border:none;
      padding:12px 16px;
      font-size:14px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:0.12em;
      cursor:pointer;
      background:linear-gradient(135deg,#faca3d 0%,#f59e0b 100%);
      color:#124175;
      box-shadow:
        0 14px 32px rgba(0,0,0,0.28),
        inset 0 2px 0 rgba(255,255,255,0.6);
      transition:transform .15s ease, box-shadow .15s ease;
    }

    .auth-login-btn:hover{
      transform:translateY(-1px);
      box-shadow:
        0 18px 40px rgba(0,0,0,0.32),
        inset 0 2px 0 rgba(255,255,255,0.7);
    }

    .auth-login-btn:active{
      transform:translateY(0);
      box-shadow:
        0 8px 20px rgba(0,0,0,0.25),
        inset 0 1px 0 rgba(255,255,255,0.5);
    }

    .auth-error{
      font-size:11px;
      color:#dc2626;
      margin-top:8px;
      min-height:14px;
    }

    .auth-footer{
      margin-top:16px;
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
      font-size:11px;
      color:#6b7280;
    }

    @media (max-width:600px){
      .auth-portal-title{
        font-size:28px;
      }
      .auth-card{
        padding:32px 22px 24px;
      }
    }

/* =========================
   SCORING TAB STYLES
========================= */

.scoring-shell{
  max-width:1100px;
  margin:0 auto;
  padding:12px 0 28px;
}

.scoring-header{
  text-align:center;
  margin-bottom:20px;
}

.scoring-title{
  font-size:18px;
  font-weight:800;
  letter-spacing:0.25em;
  text-transform:uppercase;
  color:#ffffff;
}

.scoring-underline{
  width:80px;
  height:4px;
  border-radius:999px;
  background:#f6c343;
  margin:10px auto 0;
}

.scoring-filter-card,
.scoring-main-card{
  background:#ffffff;
  border-radius:26px;
  padding:20px 24px;
  box-shadow:0 18px 40px rgba(15,23,42,0.35);
  margin-bottom:20px;
}

.scoring-filter-row{
  display:flex;
  flex-wrap:wrap;
  gap:18px;
}

.scoring-filter-field{
  flex:1;
  min-width:220px;
}

/* reuse existing label/input styles; just tweak */
.scoring-filter-field label{
  font-size:11px;
  font-weight:700;
  letter-spacing:0.1em;
  text-transform:uppercase;
  color:#6b7280;
  margin-bottom:6px;
}

.scoring-main-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-bottom:10px;
}

.scoring-main-title{
  margin:0;
  font-size:18px;
  font-weight:800;
  letter-spacing:0.08em;
  text-transform:uppercase;
  color:#111827;
}

.score-count-pill{
  padding:6px 14px;
  border-radius:999px;
  background:linear-gradient(135deg,#f6c343,#f1a608);
  color:#124175;
  font-size:12px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:0.08em;
  white-space:nowrap;
}

.scoring-main-divider{
  height:3px;
  border-radius:999px;
  background:#f6c343;
  margin-bottom:18px;
}

/* Game cards */

.score-game-card{
  border-radius:22px;
  background:#f9fafb;
  border:1px solid rgba(15,23,42,0.08);
  box-shadow:0 10px 26px rgba(15,23,42,0.18);
  margin-bottom:18px;
  overflow:hidden;
}

.score-game-header{
  background:linear-gradient(135deg,#124175 0%,#1a5a8a 100%);
  color:#ffffff;
  padding:12px 18px 10px;
}

.score-game-header-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:4px;
}

.score-game-title{
  font-size:14px;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:0.08em;
}

.score-game-meta{
  font-size:11px;
  opacity:0.9;
}

.score-game-header-actions{
  display:flex;
  gap:6px;
}

.score-clear-btn{
  border:none;
  border-radius:999px;
  width:26px;
  height:26px;
  font-size:16px;
  line-height:1;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  background:#ef4444;
  color:#ffffff;
  box-shadow:0 4px 10px rgba(239,68,68,0.5);
}

.score-clear-btn:hover{
  background:#b91c1c;
}

.score-game-body{
  padding:16px 18px 16px;
  background:#f9fafb;
}

.score-input-row{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:14px;
}

.score-input-group{
  flex:1;
  min-width:220px;
}

.score-input-group label{
  font-size:11px;
  font-weight:700;
  letter-spacing:0.08em;
  text-transform:uppercase;
  color:#6b7280;
  margin-bottom:4px;
  display:block;
}

.score-input-box{
  width:100%;
  border-radius:14px;
  border:2px solid #e5e7eb;
  padding:10px 12px;
  font-size:18px;
  font-weight:700;
  text-align:center;
  background:#ffffff;
  color:#111827;
  box-shadow:0 3px 10px rgba(15,23,42,0.08);
}

.score-input-box:focus{
  outline:none;
  border-color:#f6c343;
  box-shadow:0 0 0 3px rgba(246,195,67,0.35);
}

.score-save-btn{
  width:100%;
  border:none;
  border-radius:999px;
  padding:11px 16px;
  font-size:13px;
  font-weight:800;
  letter-spacing:0.16em;
  text-transform:uppercase;
  cursor:pointer;
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:#ffffff;
  box-shadow:0 10px 24px rgba(22,163,74,0.6);
}

.score-save-btn:hover{
  filter:brightness(1.05);
  transform:translateY(-1px);
}

.score-save-btn:active{
  transform:translateY(0);
}

/* mobile */
@media (max-width:768px){
  .scoring-main-card,
  .scoring-filter-card{
    padding:16px 16px 18px;
  }
}

    /* ---------------- ADMIN LAYOUT (CANVA-ISH) ---------------- */

    .admin-header{
      background:linear-gradient(135deg,rgba(15,23,42,0.9),rgba(12,10,40,0.98));
      border-radius:20px;
      padding:22px 22px 18px;
      border:1px solid rgba(148,163,184,0.6);
      box-shadow:
        0 24px 80px rgba(0,0,0,0.9),
        0 0 0 1px rgba(15,23,42,0.8);
      margin-bottom:20px;
      position:relative;
      overflow:hidden;
    }

    .admin-header::before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:22px;
      background:radial-gradient(circle at top left,rgba(148,163,184,0.14),transparent 55%);
      pointer-events:none;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 12px;
      border-radius:999px;
      background:rgba(15,23,42,0.8);
      color:#bfdbfe;
      font-size:11px;
      font-weight:600;
      letter-spacing:0.08em;
      text-transform:uppercase;
      margin-bottom:8px;
    }

    .badge::before{
      content:"";
      width:6px;
      height:6px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 10px rgba(34,197,94,1);
    }

    .admin-title{
      margin:0 0 4px;
      font-size:26px;
      font-weight:700;
      letter-spacing:0.02em;
    }

    .admin-subtitle{
      margin:0;
      font-size:13px;
      color:var(--muted);
    }

    .top-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:14px;
      gap:10px;
      flex-wrap:wrap;
      font-size:12px;
      color:var(--muted);
    }

    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      padding:7px 14px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(15,23,42,0.85);
      color:var(--text);
      transition:all .18s ease-out;
    }

    .btn:hover{
      border-color:var(--accent-soft);
      box-shadow:0 0 0 1px rgba(250,204,21,0.4);
      transform:translateY(-1px);
    }

    .btn-primary{
      background:radial-gradient(circle at 20% 0%,#fef3c7 0,#fbbf24 40%,#f97316 100%);
      color:#111827;
      border-color:rgba(251,191,36,0.9);
      box-shadow:
        0 16px 45px rgba(250,204,21,0.7),
        0 0 0 1px rgba(251,191,36,0.8),
        inset 0 1px 0 rgba(255,255,255,0.85);
    }

    .btn-small{padding:5px 11px;font-size:11px;box-shadow:none;}

    .btn-approve{background:#16a34a;color:#ecfdf5;border-color:#16a34a;}
    .btn-decline{background:#dc2626;color:#fee2e2;border-color:#b91c1c;}
    .btn-pending{background:#facc15;color:#111827;border-color:#eab308;}

    /* tabs */

    .tabs{
      display:flex;
      gap:8px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }

    .tab-btn{
      border-radius:999px;
      border:1px solid rgba(31,41,55,0.9);
      padding:7px 14px;
      font-size:12px;
      cursor:pointer;
      background:rgba(15,23,42,0.85);
      color:#9ca3af;
    }

    .tab-btn.active{
      background:linear-gradient(135deg,#111827,#020617);
      color:#fbbf24;
      border-color:rgba(234,179,8,0.9);
      box-shadow:0 0 0 1px rgba(250,204,21,0.6);
    }

    .tab-panel{display:none;}
    .tab-panel.active{display:block;}

    /* CARDS / LAYOUT */

    .layout-two{
      display:grid;
      grid-template-columns:minmax(0,1.15fr) minmax(0,1fr);
      gap:16px;
    }
    @media(max-width:900px){
      .layout-two{grid-template-columns:1fr;}
    }

    .card{
      background:linear-gradient(135deg,rgba(15,23,42,0.96),rgba(15,23,42,0.9));
      border-radius:16px;
      border:1px solid rgba(31,41,55,0.9);
      padding:14px 12px 14px;
      margin-bottom:14px;
      box-shadow:
        0 18px 40px rgba(0,0,0,0.85),
        0 0 0 1px rgba(15,23,42,0.8);
    }

    .card-header{
      font-size:14px;
      font-weight:600;
      margin-bottom:4px;
    }

    .card-sub{
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
    }

    label{
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.06em;
      display:block;
      margin-bottom:3px;
      color:#9ca3af;
    }

    select,input,textarea{
      width:100%;
      border-radius:10px;
      border:1px solid #1f2937;
      padding:7px 9px;
      font-size:13px;
      font-family:inherit;
      outline:none;
      background:#020617;
      color:var(--text);
    }

    select:focus,input:focus,textarea:focus{
      border-color:var(--accent-soft);
      box-shadow:0 0 0 1px rgba(250,204,21,0.5);
    }

    textarea{resize:vertical;min-height:70px;}

    .row{
      display:flex;
      gap:8px;
      margin-bottom:6px;
      flex-wrap:wrap;
    }
    .row>div{flex:1;}

    .team-list{
      display:grid;
      gap:0.85rem;
    }

    .team-card{
      background:linear-gradient(135deg,rgba(15,23,42,0.98),rgba(15,23,42,0.92));
      padding:10px 10px 9px;
      border-radius:14px;
      border:1px solid rgba(31,41,55,1);
      box-shadow:
        0 14px 35px rgba(0,0,0,0.8),
        0 0 0 1px rgba(15,23,42,0.75);
      transition:transform .15s ease-out, box-shadow .15s ease-out, border-color .15s;
    }

    .team-card:hover{
      transform:translateY(-1px);
      border-color:rgba(250,204,21,0.6);
      box-shadow:
        0 18px 45px rgba(0,0,0,0.9),
        0 0 0 1px rgba(250,204,21,0.4);
    }

    .team-header{
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:4px;
      gap:6px;
    }

    .team-title{
      font-size:15px;
      font-weight:700;
    }

    .team-meta{
      font-size:11px;
      color:#9ca3af;
    }

    .status-pill{
      padding:3px 9px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.06em;
    }

    .status-pending{background:rgba(250,204,21,0.15);color:#facc15;border:1px solid rgba(250,204,21,0.5);}
    .status-approved{background:rgba(34,197,94,0.15);color:#4ade80;border:1px solid rgba(34,197,94,0.45);}
    .status-declined{background:rgba(248,113,113,0.16);color:#fca5a5;border:1px solid rgba(248,113,113,0.45);}

    .check-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:4px;
      margin-bottom:4px;
    }

    .check-row label{
      font-size:11px;
      text-transform:none;
      letter-spacing:0;
      font-weight:500;
      display:flex;
      align-items:center;
      gap:4px;
      color:#e5e7eb;
    }

    .check-row input[type="checkbox"]{
      width:auto;
      height:auto;
      accent-color:var(--accent-soft);
    }

    .note-input{
      width:100%;
      border-radius:999px;
      border:1px dashed #374151;
      background:rgba(15,23,42,0.9);
      padding:4px 7px;
      font-size:11px;
      color:var(--text);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 9px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
      font-size:11px;
      font-weight:600;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      padding:2px 7px;
      font-size:11px;
      border-radius:999px;
      background:#1f2937;
      color:#e5e7eb;
      margin:2px 4px 2px 0;
    }

    .empty-note{
      font-size:12px;
      color:#6b7280;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      background:#020617;
      color:var(--text);
    }

    th,td{
      padding:6px 7px;
      border:1px solid #1f2937;
      text-align:left;
    }

    th{
      background:#020617;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:#9ca3af;
    }

    .toast{
      position:fixed;
      bottom:16px;
      right:16px;
      background:#111827;
      color:#e5e7eb;
      font-size:11px;
      padding:7px 12px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      transform:translateY(8px);
      transition:all .2s ease-out;
      box-shadow:0 18px 40px rgba(0,0,0,0.8);
      z-index:50;
    }
    .toast.visible{
      opacity:1;
      transform:translateY(0);
    }

    .game-card{
      border-radius:12px;
      border:1px solid #1f2937;
      background:rgba(15,23,42,0.96);
      padding:8px 9px;
      margin-bottom:6px;
      font-size:12px;
    }
    .game-header{
      display:flex;
      justify-content:space-between;
      gap:6px;
      margin-bottom:4px;
      flex-wrap:wrap;
    }
    .game-meta{
      font-size:11px;
      color:#9ca3af;
    }
  </style>
</head>

<body>

<!-- LOGIN (CANVA STYLE) -->
<!-- PASSWORD GATE -->
<div id="authGate">
  <div class="auth-shell">
    <h1 class="auth-portal-title">ADMIN PORTAL</h1>
    <div class="auth-underline"></div>

    <div class="auth-card">
      <div class="auth-icon-circle">
        <span>ðŸ”’</span>
      </div>

      <h2 class="auth-title">ADMIN LOGIN</h2>
      <p class="auth-sub">
        Enter your password to access the admin tools.
      </p>

      <div class="auth-field">
        <label class="auth-label" for="authPassword">Password</label>
        <input
          id="authPassword"
          type="password"
          class="auth-input"
          placeholder="Enter password"
        >
      </div>

      <button id="authSubmit" class="auth-login-btn">
        Login
      </button>

      <div id="authError" class="auth-error"></div>

      <div class="auth-footer">
        <span>Hint: same password used for admin access.</span>
        <span>AYSO â€¢ Area 10W</span>
      </div>
    </div>
  </div>
</div>


<!-- ADMIN APP -->
<main id="adminMain" class="page" style="display:none;">
  <div class="admin-header">
    <div class="badge">OSF 2026 â€¢ Tournament Admin</div>
    <h2 class="admin-title">Admin Portal</h2>
    <p class="admin-subtitle">
      One-stop view for teams, pools, schedules, and scoring.
    </p>
  </div>

  <div class="top-bar">
    <div>
      Changes are saved to your <strong>OSF 2026 Tournament Teams</strong> spreadsheet (Teams + AdminState).
    </div>
    <button id="saveStateBtn" class="btn btn-primary btn-small">Save / Publish</button>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="teams">Teams</button>
    <button class="tab-btn" data-tab="pools">Pools</button>
    <button class="tab-btn" data-tab="schedule">Game Schedule</button>
    <button class="tab-btn" data-tab="scoring">Scoring</button>
  </div>

  <!-- TEAMS TAB -->
  <section id="tab-teams" class="tab-panel active">
    <div class="layout-two">
      <div>
        <div class="card">
          <div class="card-header">Filters</div>
          <div class="card-sub">Filter by division and status.</div>
          <div class="row">
            <div>
              <label>Division</label>
              <select id="teamsDivisionFilter">
                <option value="">All</option>
                <option value="10UB">10U Boys</option>
                <option value="10UG">10U Girls</option>
                <option value="12UB">12U Boys</option>
                <option value="12UG">12U Girls</option>
                <option value="14UB">14U Boys</option>
                <option value="14UG">14U Girls</option>
              </select>
            </div>
            <div>
              <label>Status</label>
              <select id="teamsStatusFilter">
                <option value="">All</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="declined">Declined</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Teams</div>
          <div class="card-sub">
            Approve, decline, or move teams back to pending. Toggle document checkboxes as paperwork is received.
          </div>
          <div id="teamsList" class="team-list"></div>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="card-header">Summary</div>
          <div class="card-sub">Counts by status (all divisions).</div>
          <div id="teamsSummary"></div>
        </div>
        <div class="card">
          <div class="card-header">Legend</div>
          <div class="card-sub">How this flows into the public pages.</div>
          <ul style="padding-left:18px;font-size:12px;margin:0;">
            <li><strong>Approved</strong> â†’ appears on public Approved Teams.</li>
            <li>Schedules + scores â†’ drive the public Schedule and Stats pages.</li>
            <li>Declined teams stay in the system and can be moved back to Pending.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- POOLS TAB -->
  <section id="tab-pools" class="tab-panel">
    <div class="card">
      <div class="card-header">Create &amp; Manage Pools</div>
      <div class="card-sub">Create pools and assign approved/manual teams.</div>

      <label>Division</label>
      <select id="poolsDivisionSelect">
        <option value="10UB">10U Boys</option>
        <option value="10UG">10U Girls</option>
        <option value="12UB">12U Boys</option>
        <option value="12UG">12U Girls</option>
        <option value="14UB">14U Boys</option>
        <option value="14UG">14U Girls</option>
      </select>

      <label style="margin-top:6px;">New Pool Name</label>
      <div class="row">
        <div><input id="newPoolName" placeholder="Pool A"></div>
        <div style="flex:0 0 auto;align-self:flex-end;">
          <button id="addPoolBtn" class="btn btn-primary btn-small">Add Pool</button>
        </div>
      </div>

      <div id="poolsList" style="margin-top:6px;"></div>
    </div>

    <div class="card">
      <div class="card-header">Available Teams</div>
      <div class="card-sub">Approved &amp; manual teams in this division.</div>
      <div id="poolTeamsArea">
        <div class="empty-note">Teams will appear here when you select a division.</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Add Manual Team</div>
      <div class="card-sub">Use for guest or late-add teams that arenâ€™t in the registration sheet.</div>

      <label>Manual Team Name</label>
      <input id="manualTeamName" placeholder="Enter team name">

      <div class="row" style="margin-top:6px;">
        <div>
          <label>Region</label>
          <input id="manualTeamRegion" placeholder="e.g., 304">
        </div>
        <div>
          <label>City</label>
          <input id="manualTeamCity" placeholder="Enter city">
        </div>
        <div>
          <label>State</label>
          <input id="manualTeamState" placeholder="Enter state">
        </div>
      </div>

      <button id="addManualTeamBtn" class="btn btn-primary btn-small">Add Manual Team</button>

      <div id="manualTeamsList" style="margin-top:8px;">
        <div class="empty-note">No manual teams yet</div>
      </div>
    </div>
  </section>

  <!-- SCHEDULE TAB -->
  <section id="tab-schedule" class="tab-panel">
    <div class="layout-two">
      <div>
        <div class="card">
          <div class="card-header">Day &amp; Field Configuration</div>
          <div class="card-sub">
            Configure days (Saturday/Sunday), fields, and times for pool-play games.
          </div>
          <div class="row">
            <div>
              <label>Division</label>
              <select id="schedDivisionSelect">
                <option value="10UB">10U Boys</option>
                <option value="10UG">10U Girls</option>
                <option value="12UB">12U Boys</option>
                <option value="12UG">12U Girls</option>
                <option value="14UB">14U Boys</option>
                <option value="14UG">14U Girls</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Date label</label>
              <input type="text" id="schedDayLabel" placeholder="Saturday">
            </div>
          </div>
          <div class="row">
            <div>
              <label>Fields (comma-separated)</label>
              <input type="text" id="schedFields" placeholder="Field 1, Field 2">
            </div>
          </div>
          <div class="row">
            <div>
              <label>Times (comma-separated)</label>
              <input type="text" id="schedTimes" placeholder="8:00am, 9:15am, 10:30am">
            </div>
          </div>
          <button class="btn btn-primary btn-small" id="addDayConfigBtn">Add Day</button>
          <div id="dayConfigsList" style="margin-top:10px;"></div>
        </div>

        <div class="card">
          <div class="card-header">Generate Pool-Play Schedule</div>
          <div class="card-sub">
            Uses pools and day configs. Tries to avoid back-to-back games and duplicate time slots.
          </div>

          <label style="display:flex;align-items:center;gap:6px;font-size:12px;margin-bottom:6px;text-transform:none;letter-spacing:0;">
            <input type="checkbox" id="allowCrossPool" style="width:auto;height:auto;">
            Allow <strong>cross-pool</strong> games when needed so each team reaches 3 matches
          </label>

          <button class="btn btn-primary btn-small" id="generateScheduleBtn">Generate Schedule</button>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="card-header">Pool-Play Games</div>
          <div class="card-sub">Edit date, field, time, and teams if needed. You can also delete games.</div>
          <div id="gamesList" style="max-height:360px;overflow:auto;padding-right:4px;"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Knockout Games (Semis, Consolation, Final)</div>
      <div class="card-sub">These feed into the public schedule. You can leave teams as TBD.</div>
      <div id="knockoutsList"></div>
    </div>
  </section>

  <!-- SCORING TAB -->
  <section id="tab-scoring" class="tab-panel">
    <div class="scoring-shell">

      <!-- Header -->
      <div class="scoring-header">
        <div class="scoring-title">SCORING ADMIN</div>
        <div class="scoring-underline"></div>
      </div>

      <!-- Filter card -->
      <div class="scoring-filter-card">
        <div class="scoring-filter-row">
          <div class="scoring-filter-field">
            <label>Division</label>
            <select id="scoreDivisionSelect">
              <option value="10UB">10U Boys</option>
              <option value="10UG">10U Girls</option>
              <option value="12UB">12U Boys</option>
              <option value="12UG">12U Girls</option>
              <option value="14UB">14U Boys</option>
              <option value="14UG">14U Girls</option>
            </select>
          </div>
          <div class="scoring-filter-field">
            <label>Filter by date</label>
            <input id="scoreDateFilter" type="text" placeholder="e.g. Apr 25">
          </div>
        </div>
      </div>

      <!-- Scores card -->
      <div class="scoring-main-card">
        <div class="scoring-main-header">
          <h3 class="scoring-main-title">Enter Game Scores</h3>
          <div id="scoreGameCountBadge" class="score-count-pill">0 Games</div>
        </div>
        <div class="scoring-main-divider"></div>
        <div id="scoringContent"></div>
      </div>

    </div>
  </section>

</main>

<div id="toast" class="toast">Saved</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxTgz1zRnrtYvzsJraQeDKIdw5DY6-YFgs2FI87toZE7liLc1JXRgQbYcpIcmlhVczd/exec';
  const ADMIN_PASSWORD = 'PLAYSOCCER';

  const DIVISION_LABELS = {
    '10UB':'10U Boys',
    '10UG':'10U Girls',
    '12UB':'12U Boys',
    '12UG':'12U Girls',
    '14UB':'14U Boys',
    '14UG':'14U Girls'
  };

  let allTeams = [];
  let adminState = {
    manualTeams: [],
    pools: [],
    schedules: [],
    scores: {},
    dayConfigs: {}
  };

  const toastEl = document.getElementById('toast');
  const saveStateBtn = document.getElementById('saveStateBtn');
  let toastTimer = null;

  const authGate = document.getElementById('authGate');
  const adminMain = document.getElementById('adminMain');
  const authPasswordInput = document.getElementById('authPassword');
  const authSubmitBtn = document.getElementById('authSubmit');
  const authError = document.getElementById('authError');

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('visible');
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toastEl.classList.remove('visible'),1500);
  }

  function normalizeState(state){
    if (!state || typeof state !== 'object') state = {};
    state.manualTeams = Array.isArray(state.manualTeams) ? state.manualTeams : [];
    state.pools = Array.isArray(state.pools) ? state.pools : [];
    state.schedules = Array.isArray(state.schedules) ? state.schedules : [];
    state.scores = state.scores && typeof state.scores === 'object' ? state.scores : {};
    state.dayConfigs = state.dayConfigs && typeof state.dayConfigs === 'object' ? state.dayConfigs : {};
    return state;
  }

  async function saveStateToApi(showMessage = true){
    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({
          state: adminState
        })
      });

      if (!res.ok) {
        console.error('Save HTTP error', res.status);
        if (showMessage) showToast('Save failed');
        return false;
      }

      if (showMessage) showToast('Saved');
      return true;
    } catch (e) {
      console.error('Save fetch error', e);
      if (showMessage) showToast('Save failed');
      return false;
    }
  }

  async function saveScoresOnly() {
    try {
      const payload = {
        entity: 'scores',
        scores: adminState.scores || {}
      };

      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (!data.ok) {
        console.error('Error saving scores:', data.error);
        alert('There was a problem saving scores. Please try again.');
        return;
      }

      alert('Scores saved successfully.');
    } catch (err) {
      console.error(err);
      alert('Network error while saving scores.');
    }
  }

  async function loadAdminData(){
    try{
      const [teamsRes,stateRes] = await Promise.all([
        fetch(API_URL),
        fetch(API_URL+'?entity=state')
      ]);
      allTeams = await teamsRes.json();
      adminState = normalizeState(await stateRes.json());
      renderAll();
    }catch(e){
      console.error(e);
      showToast('Load error');
    }
  }

  function renderAll(){
    renderTeamsTab();
    refreshPoolsUI();
    renderManualTeams();
    renderDayConfigsUI();
    renderGamesUI();
    renderKnockoutsUI();
    renderScoringTab();
  }

  function unlockAdmin(){
    authGate.style.display = 'none';
    adminMain.style.display = 'block';
    loadAdminData();
  }

  function handleAuth(){
    const val = authPasswordInput.value.trim();
    if (val === ADMIN_PASSWORD){
      localStorage.setItem('osf2026_admin_authed','true');
      authError.textContent = '';
      unlockAdmin();
    }else{
      authError.textContent = 'Incorrect password. Please try again.';
    }
  }

  authSubmitBtn.addEventListener('click', handleAuth);
  authPasswordInput.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') handleAuth();
  });

  document.addEventListener('DOMContentLoaded', ()=>{
    const authed = localStorage.getItem('osf2026_admin_authed') === 'true';
    if (authed){
      unlockAdmin();
    }else{
      authGate.style.display = 'flex';
      adminMain.style.display = 'none';
    }
  });

  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const tab = btn.dataset.tab;
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(p=>{
        p.classList.toggle('active',p.id==='tab-'+tab);
      });
    });
  });

  const teamsDivisionFilter = document.getElementById('teamsDivisionFilter');
  const teamsStatusFilter = document.getElementById('teamsStatusFilter');
  const teamsListEl = document.getElementById('teamsList');
  const teamsSummaryEl = document.getElementById('teamsSummary');

  teamsDivisionFilter.addEventListener('change',renderTeamsTab);
  teamsStatusFilter.addEventListener('change',renderTeamsTab);

  function statusPill(status){
    const span=document.createElement('span');
    span.classList.add('status-pill');
    if(status==='approved'){span.classList.add('status-approved');span.textContent='Approved';}
    else if(status==='declined'){span.classList.add('status-declined');span.textContent='Declined';}
    else {span.classList.add('status-pending');span.textContent='Pending';}
    return span;
  }

  function renderTeamsTab(){
    if(!Array.isArray(allTeams)) allTeams=[];
    const divFilter = teamsDivisionFilter.value;
    const stFilter = teamsStatusFilter.value;
    let list = allTeams.slice();
    if(divFilter) list=list.filter(t=>t.division===divFilter);
    if(stFilter) list=list.filter(t=>String(t.status).toLowerCase()===stFilter);

    teamsListEl.innerHTML='';
    if(!list.length){
      teamsListEl.innerHTML='<div class="empty-note">No teams match the current filters.</div>';
    }else{
      list.forEach(team=>teamsListEl.appendChild(renderTeamCard(team)));
    }

    const pending = allTeams.filter(t=>String(t.status).toLowerCase()==='pending').length;
    const approved = allTeams.filter(t=>String(t.status).toLowerCase()==='approved').length;
    const declined = allTeams.filter(t=>String(t.status).toLowerCase()==='declined').length;

    teamsSummaryEl.innerHTML = `
      <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:12px;">
        <span class="pill">Pending: ${pending}</span>
        <span class="pill" style="background:#022c22;">Approved: ${approved}</span>
        <span class="pill" style="background:#450a0a;">Declined: ${declined}</span>
      </div>
    `;
  }

  function renderTeamCard(team){
    const card=document.createElement('div');
    card.className='team-card';

    const header=document.createElement('div');
    header.className='team-header';

    const left=document.createElement('div');
    const title=document.createElement('div');
    title.className='team-title';
    title.textContent=team.teamName||'Team';
    const meta=document.createElement('div');
    meta.className='team-meta';
    const divLabel=DIVISION_LABELS[team.division]||team.division||'';
    meta.textContent=`${divLabel} â€¢ Region ${team.regionNumber||''} â€¢ ${team.city||''}, ${team.state||''}`;
    left.appendChild(title);left.appendChild(meta);

    const right=document.createElement('div');
    right.appendChild(statusPill(String(team.status).toLowerCase()));

    header.appendChild(left);header.appendChild(right);

    const row1=document.createElement('div');
    row1.className='team-row';
    row1.innerHTML=`
      <div><strong>Coach:</strong> ${team.coachName||''}</div>
      <div><strong>Email:</strong> ${team.coachEmail||''}</div>
      <div><strong>Phone:</strong> ${team.coachPhone||''}</div>
    `;

    const checks=document.createElement('div');
    checks.className='check-row';
    const docs=[
      {key:'docs_application',label:'Application'},
      {key:'docs_roster',label:'Roster'},
      {key:'docs_check',label:'Check'}
    ];
    docs.forEach(d=>{
      const lbl=document.createElement('label');
      const cb=document.createElement('input');
      cb.type='checkbox';
      cb.checked=!!team[d.key];
      cb.addEventListener('change',()=>{
        const updated=Object.assign({},team,{[d.key]:cb.checked?1:0});
        updateTeamOnServer(updated);
      });
      lbl.appendChild(cb);
      lbl.append(' '+d.label);
      checks.appendChild(lbl);
    });

    const actions=document.createElement('div');
    actions.className='team-row';
    const leftActions=document.createElement('div');
    const rightActions=document.createElement('div');

    const btnApprove=document.createElement('button');
    btnApprove.className='btn btn-approve btn-small';
    btnApprove.textContent='Approve';
    btnApprove.addEventListener('click',()=>changeTeamStatus(team,'approved'));

    const btnPending=document.createElement('button');
    btnPending.className='btn btn-pending btn-small';
    btnPending.textContent='Set Pending';
    btnPending.addEventListener('click',()=>changeTeamStatus(team,'pending'));

    const btnDecline=document.createElement('button');
    btnDecline.className='btn btn-decline btn-small';
    btnDecline.textContent='Decline';
    btnDecline.addEventListener('click',()=>changeTeamStatus(team,'declined'));

    leftActions.appendChild(btnApprove);
    leftActions.appendChild(btnPending);
    leftActions.appendChild(btnDecline);

    const noteInput=document.createElement('input');
    noteInput.className='note-input';
    noteInput.placeholder='Internal note (not public)';
    noteInput.value=team.internalNote||'';
    noteInput.addEventListener('change',()=>{
      const updated=Object.assign({},team,{internalNote:noteInput.value});
      updateTeamOnServer(updated);
    });
    rightActions.appendChild(noteInput);

    actions.appendChild(leftActions);
    actions.appendChild(rightActions);

    card.appendChild(header);
    card.appendChild(row1);
    card.appendChild(checks);
    card.appendChild(actions);
    return card;
  }

  function changeTeamStatus(team, status) {
    const updated = Object.assign({}, team, { status });
    updateTeamOnServer(updated);
  }

  async function updateTeamOnServer(updatedTeam) {
    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({
          mode: 'update',
          team: updatedTeam
        })
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); }
      catch(err) {
        console.error("Non-JSON from server:", text);
        showToast('Update failed');
        return;
      }

      if (!data.ok) {
        console.error('Apps Script error:', data.error);
        showToast('Update failed');
        return;
      }

      const idx = allTeams.findIndex(t => String(t.id) === String(updatedTeam.id));
      if (idx !== -1) allTeams[idx] = updatedTeam;

      renderTeamsTab();
      if (typeof refreshPoolsUI === 'function') refreshPoolsUI();

      showToast("Team updated");
    }
    catch (e) {
      console.error("Fetch error", e);
      showToast("Update failed");
    }
  }

  const poolsDivisionSel=document.getElementById('poolsDivisionSelect');
  const newPoolNameInput=document.getElementById('newPoolName');
  const addPoolBtn=document.getElementById('addPoolBtn');
  const poolsList=document.getElementById('poolsList');
  const poolTeamsArea=document.getElementById('poolTeamsArea');
  const manualTeamNameInput=document.getElementById('manualTeamName');
  const manualTeamRegionInput=document.getElementById('manualTeamRegion');
  const manualTeamCityInput=document.getElementById('manualTeamCity');
  const manualTeamStateInput=document.getElementById('manualTeamState');
  const addManualTeamBtn=document.getElementById('addManualTeamBtn');
  const manualTeamsList=document.getElementById('manualTeamsList');

  poolsDivisionSel.addEventListener('change',()=>{
    refreshPoolsUI();
    renderManualTeams();
  });

  addPoolBtn.addEventListener('click',()=>{
    const name=newPoolNameInput.value.trim();
    const division=poolsDivisionSel.value;
    if(!name) return;
    const pool={id:'P_'+division+'_'+Date.now(),division,name,teamIds:[]};
    adminState.pools.push(pool);
    newPoolNameInput.value='';
    saveStateToApi(false);
    refreshPoolsUI();
  });

  addManualTeamBtn.addEventListener('click',()=>{
    const division=poolsDivisionSel.value;
    const name=manualTeamNameInput.value.trim();
    if(!name) return;
    const manualTeam={
      id:'M_'+Date.now(),
      division,
      teamName:name,
      regionNumber:manualTeamRegionInput.value||'',
      city:manualTeamCityInput.value||'',
      state:manualTeamStateInput.value||'',
      manual:true
    };
    adminState.manualTeams.push(manualTeam);
    manualTeamNameInput.value='';
    manualTeamRegionInput.value='';
    manualTeamCityInput.value='';
    manualTeamStateInput.value='';
    saveStateToApi(false);
    refreshPoolsUI();
    renderManualTeams();
  });

  function getPoolsForDivision(division){
    return adminState.pools.filter(p=>p.division===division);
  }
  function getAllTeamsCombined(){
    const manual = adminState.manualTeams.map(m=>Object.assign({manual:true},m));
    return allTeams.concat(manual);
  }
  function getAllTeamsForDivision(division){
    return getAllTeamsCombined().filter(t=>t.division===division);
  }

  function assignTeamToPool(division,teamId,poolId){
    const idStr=String(teamId);
    adminState.pools.forEach(p=>{
      if(p.division===division){
        p.teamIds=(p.teamIds||[]).map(String).filter(id=>id!==idStr);
      }
    });
    if(poolId){
      const pool=adminState.pools.find(p=>p.id===poolId);
      if(pool){
        pool.teamIds=pool.teamIds||[];
        if(!pool.teamIds.map(String).includes(idStr)){
          pool.teamIds.push(idStr);
        }
      }
    }
    saveStateToApi(false);
    refreshPoolsUI();
  }

  function divisionLabel(code){
    return DIVISION_LABELS[code]||code||'';
  }

  function renderManualTeams(){
    const division=poolsDivisionSel.value;
    const manual=adminState.manualTeams.filter(m=>m.division===division);
    manualTeamsList.innerHTML='';
    if(!manual.length){
      manualTeamsList.innerHTML='<div class="empty-note">No manual teams for this division.</div>';
      return;
    }
    manual.forEach(m=>{
      const row=document.createElement('div');
      row.style.fontSize='12px';
      row.style.marginBottom='3px';
      row.innerHTML=`
        <span class="tag">${m.teamName}</span>
        <span class="team-meta">Region ${m.regionNumber||''} â€¢ ${m.city||''} ${m.state||''}</span>
      `;
      manualTeamsList.appendChild(row);
    });
  }

  function refreshPoolsUI(){
    const division=poolsDivisionSel.value;
    const relevantTeams=getAllTeamsForDivision(division)
      .filter(t=>String(t.status).toLowerCase()==='approved' || t.manual);

    poolTeamsArea.innerHTML='';
    if(!relevantTeams.length){
      poolTeamsArea.innerHTML='<span class="empty-note">No approved or manual teams yet.</span>';
    }else{
      relevantTeams.forEach(team=>{
        const div=document.createElement('div');
        div.className='pill';
        const nameSpan=document.createElement('span');
        nameSpan.innerHTML=`<strong>${team.teamName||'Team'}</strong>`;
        const sub=document.createElement('span');
        sub.style.fontSize='11px';
        sub.style.color='#9ca3af';
        sub.textContent=team.manual?'Manual':`Region ${team.regionNumber||''}`;
        div.appendChild(nameSpan);
        div.appendChild(sub);

        const select=document.createElement('select');
        select.style.marginLeft='8px';
        const noneOpt=document.createElement('option');
        noneOpt.value='';noneOpt.textContent='No pool';
        select.appendChild(noneOpt);

        const poolsForDiv=getPoolsForDivision(division);
        poolsForDiv.forEach(p=>{
          const o=document.createElement('option');
          o.value=p.id;o.textContent=p.name;
          if((p.teamIds||[]).map(String).includes(String(team.id))) o.selected=true;
          select.appendChild(o);
        });
        select.addEventListener('change',()=>assignTeamToPool(division,team.id,select.value));
        div.appendChild(select);
        poolTeamsArea.appendChild(div);
      });
    }

    poolsList.innerHTML='';
    const poolsForDiv=getPoolsForDivision(division);
    if(!poolsForDiv.length){
      poolsList.innerHTML='<div class="empty-note">No pools created yet.</div>';
      return;
    }
    poolsForDiv.forEach(pool=>{
      const container=document.createElement('div');
      container.style.marginTop='8px';

      const header=document.createElement('div');
      header.style.display='flex';
      header.style.alignItems='center';
      header.style.gap='6px';
      header.style.flexWrap='wrap';

      const title=document.createElement('div');
      title.innerHTML=`<strong>${pool.name}</strong> <span style="font-size:11px;color:#9ca3af;">(${divisionLabel(pool.division)})</span>`;
      header.appendChild(title);

      const editBtn=document.createElement('button');
      editBtn.className='btn btn-small';
      editBtn.style.fontSize='10px';
      editBtn.textContent='Edit';
      editBtn.addEventListener('click',()=>{
        const newName=prompt('New pool name:',pool.name);
        if(newName && newName.trim()){
          pool.name=newName.trim();
          saveStateToApi(false);
          refreshPoolsUI();
          renderGamesUI();
        }
      });

      const delBtn=document.createElement('button');
      delBtn.className='btn btn-decline btn-small';
      delBtn.style.fontSize='10px';
      delBtn.textContent='Delete';
      delBtn.addEventListener('click',()=>{
        if(!confirm(`Delete ${pool.name}? Teams will be unassigned.`)) return;
        adminState.pools=adminState.pools.filter(p=>p.id!==pool.id);
        saveStateToApi(false);
        refreshPoolsUI();
        renderGamesUI();
      });

      header.appendChild(editBtn);
      header.appendChild(delBtn);

      const body=document.createElement('div');
      body.style.marginTop='4px';
      const members=getAllTeamsCombined().filter(t=>(pool.teamIds||[]).map(String).includes(String(t.id)));
      if(!members.length){
        body.innerHTML='<span class="empty-note">No teams assigned yet.</span>';
      }else{
        members.forEach(m=>{
          const tag=document.createElement('span');
          tag.className='tag';
          tag.textContent=m.teamName||'Team';
          body.appendChild(tag);
        });
      }

      container.appendChild(header);
      container.appendChild(body);
      poolsList.appendChild(container);
    });
  }

  function getScheduleForDivision(division){
    let sched = adminState.schedules.find(s=>s.division===division);
    if(!sched){
      sched={division,games:[],knockouts:[]};
      adminState.schedules.push(sched);
    }
    sched.games=Array.isArray(sched.games)?sched.games:[];
    sched.knockouts=Array.isArray(sched.knockouts)?sched.knockouts:[];
    return sched;
  }
  function getDayConfigsForDivision(division){
    adminState.dayConfigs=adminState.dayConfigs||{};
    if(!adminState.dayConfigs[division]) adminState.dayConfigs[division]=[];
    return adminState.dayConfigs[division];
  }
  function getTeamByIdAll(id){
    id=String(id);
    return getAllTeamsCombined().find(t=>String(t.id)===id)||null;
  }

  const schedDivisionSelect=document.getElementById('schedDivisionSelect');
  const schedDayLabelInput=document.getElementById('schedDayLabel');
  const schedFieldsInput=document.getElementById('schedFields');
  const schedTimesInput=document.getElementById('schedTimes');
  const addDayConfigBtn=document.getElementById('addDayConfigBtn');
  const dayConfigsList=document.getElementById('dayConfigsList');
  const generateScheduleBtn=document.getElementById('generateScheduleBtn');
  const gamesListEl=document.getElementById('gamesList');
  const knockoutsListEl=document.getElementById('knockoutsList');
  const allowCrossPoolCheckbox = document.getElementById('allowCrossPool');

  function pairKey(a,b){
    a = String(a); b = String(b);
    return (a < b) ? `${a}_${b}` : `${b}_${a}`;
  }

  function canPlaceGameInSlot(game, slot, sched, gamesPerTeam){
    const t1 = String(game.homeId);
    const t2 = String(game.awayId);

    const clash = (sched.games||[]).some(g =>
      g.date === slot.date &&
      g.time === slot.time &&
      (g.homeId === t1 || g.awayId === t1 || g.homeId === t2 || g.awayId === t2)
    );
    if (clash) return false;

    const g1 = gamesPerTeam[t1] || 0;
    const g2 = gamesPerTeam[t2] || 0;
    if (g1 >= 3 || g2 >= 3) return false;

    return true;
  }

  schedDivisionSelect.addEventListener('change',()=>{
    renderDayConfigsUI();
    renderGamesUI();
    renderKnockoutsUI();
  });

  addDayConfigBtn.addEventListener('click',()=>{
    const division=schedDivisionSelect.value;
    const label=schedDayLabelInput.value.trim();
    const fieldsStr=schedFieldsInput.value.trim();
    const timesStr=schedTimesInput.value.trim();
    if(!label || !fieldsStr || !timesStr) return;
    const cfgs=getDayConfigsForDivision(division);
    cfgs.push({id:'D_'+Date.now(),label,fields:fieldsStr,times:timesStr});
    schedDayLabelInput.value='';
    schedFieldsInput.value='';
    schedTimesInput.value='';
    saveStateToApi(false);
    renderDayConfigsUI();
  });

  function renderDayConfigsUI(){
    const division=schedDivisionSelect.value;
    const cfgs=getDayConfigsForDivision(division);
    dayConfigsList.innerHTML='';
    if(!cfgs.length){
      dayConfigsList.innerHTML='<div class="empty-note">No day configuration yet.</div>';
      return;
    }
    cfgs.forEach(cfg=>{
      const row=document.createElement('div');
      row.style.fontSize='12px';
      row.style.marginBottom='4px';
      row.innerHTML=`<strong>${cfg.label}</strong> â€“ Fields: ${cfg.fields} â€¢ Times: ${cfg.times}`;
      const btn=document.createElement('button');
      btn.className='btn btn-small';
      btn.style.marginTop='2px';
      btn.textContent='Delete';
      btn.addEventListener('click',()=>{
        const list=getDayConfigsForDivision(division);
        adminState.dayConfigs[division]=list.filter(c=>c.id!==cfg.id);
        saveStateToApi(false);
        renderDayConfigsUI();
      });
      row.appendChild(document.createElement('br'));
      row.appendChild(btn);
      dayConfigsList.appendChild(row);
    });
  }

  generateScheduleBtn.addEventListener('click', ()=>{
    const division = schedDivisionSelect.value;
    const pools = getPoolsForDivision(division);
    const cfgs = getDayConfigsForDivision(division);
    const allowCross = allowCrossPoolCheckbox.checked;

    if (!pools.length){
      alert('Create pools first.');
      return;
    }
    if (!cfgs.length){
      alert('Add at least one day configuration first.');
      return;
    }

    const slots = [];
    cfgs.forEach(cfg=>{
      const fields = cfg.fields.split(',').map(s=>s.trim()).filter(Boolean);
      const times  = cfg.times.split(',').map(s=>s.trim()).filter(Boolean);
      times.forEach(time=>{
        fields.forEach(field=>{
          slots.push({date:cfg.label,time,field});
        });
      });
    });
    if (!slots.length){
      alert('No usable slots from your day configuration.');
      return;
    }

    const sched = getScheduleForDivision(division);
    sched.games = [];

    const gamesPerTeam = {};
    const usedPairs    = new Set();

    const teamPool = {};
    pools.forEach(p=>{
      (p.teamIds || []).forEach(id=>{
        teamPool[String(id)] = p.id;
      });
    });

    const internalGames = [];
    pools.forEach(pool=>{
      const ids = (pool.teamIds || []).map(String);
      for (let i=0;i<ids.length;i++){
        for (let j=i+1;j<ids.length;j++){
          const pk = pairKey(ids[i], ids[j]);
          internalGames.push({
            id: 'G_'+division+'_'+pk+'_'+Date.now(),
            division,
            poolId: pool.id,
            homeId: ids[i],
            awayId: ids[j],
            stage: 'pool',
            crossPool: false
          });
        }
      }
    });

    function scheduleGame(game){
      let placed = false;
      let tries = 0;
      let slotIdx = 0;

      while (!placed && tries < slots.length){
        const slot = slots[slotIdx % slots.length];
        if (canPlaceGameInSlot(game, slot, sched, gamesPerTeam)){
          game.date  = slot.date;
          game.time  = slot.time;
          game.field = slot.field;

          sched.games.push(game);
          const t1 = String(game.homeId);
          const t2 = String(game.awayId);
          gamesPerTeam[t1] = (gamesPerTeam[t1] || 0) + 1;
          gamesPerTeam[t2] = (gamesPerTeam[t2] || 0) + 1;
          usedPairs.add(pairKey(t1,t2));
          placed = true;
        }
        slotIdx++;
        tries++;
      }
      return placed;
    }

    internalGames.forEach(game=>{
      scheduleGame(game);
    });

    if (allowCross){
      const allTeamIds = Object.keys(teamPool);

      let progress = true;
      while (progress){
        progress = false;

        const need = allTeamIds.filter(id => (gamesPerTeam[id] || 0) < 3);
        if (need.length < 2) break;

        outer:
        for (let i=0;i<need.length;i++){
          for (let j=i+1;j<need.length;j++){
            const a = need[i], b = need[j];
            const poolA = teamPool[a];
            const poolB = teamPool[b];

            if (!poolA || !poolB || poolA === poolB) continue;
            if (usedPairs.has(pairKey(a,b))) continue;

            const game = {
              id: 'X_'+division+'_'+pairKey(a,b)+'_'+Date.now(),
              division,
              poolId: poolA,
              homeId: a,
              awayId: b,
              stage: 'pool',
              crossPool: true
            };

            if (scheduleGame(game)){
              progress = true;
              break outer;
            }
          }
        }
      }
    }

    saveStateToApi(false);
    renderGamesUI();
    renderScoringTab();
    showToast('Schedule generated');
  });

  function renderGamesUI(){
    const division=schedDivisionSelect.value;
    const sched=getScheduleForDivision(division);
    const games=sched.games||[];
    gamesListEl.innerHTML='';
    if(!games.length){
      gamesListEl.innerHTML='<div class="empty-note">No games for this division yet.</div>';
      return;
    }
    games.forEach(g=>{
      const card=document.createElement('div');
      card.className='game-card';

      const header=document.createElement('div');
      header.className='game-header';
      const teamsSpan=document.createElement('div');
      const home=getTeamByIdAll(g.homeId);
      const away=getTeamByIdAll(g.awayId);
      teamsSpan.textContent=`${home?home.teamName:'TBD'} vs ${away?away.teamName:'TBD'}`;

      const rightWrap=document.createElement('div');
      rightWrap.style.display='flex';
      rightWrap.style.gap='6px';
      rightWrap.style.alignItems='center';
      rightWrap.style.flexWrap='wrap';

      const meta=document.createElement('div');
      meta.className='game-meta';
      let metaText = `${g.date||''} â€¢ ${g.time||''} â€¢ ${g.field||''}`;
      if (g.crossPool) metaText += ' â€¢ Cross Pool';
      meta.textContent = metaText;

      const delBtn=document.createElement('button');
      delBtn.className='btn btn-decline btn-small';
      delBtn.textContent='Delete';
      delBtn.addEventListener('click',()=>{
        const schedDiv=getScheduleForDivision(division);
        schedDiv.games = (schedDiv.games||[]).filter(game=>game.id!==g.id);
        saveStateToApi(false);
        renderGamesUI();
        renderScoringTab();
      });

      rightWrap.appendChild(meta);
      rightWrap.appendChild(delBtn);

      header.appendChild(teamsSpan);
      header.appendChild(rightWrap);

      const row=document.createElement('div');
      row.className='row';
      const d1=document.createElement('div');
      d1.innerHTML='<label>Date</label>';
      const dateInput=document.createElement('input');
      dateInput.value=g.date||'';
      dateInput.addEventListener('change',()=>{g.date=dateInput.value;saveStateToApi(false);renderScoringTab();});
      d1.appendChild(dateInput);

      const d2=document.createElement('div');
      d2.innerHTML='<label>Time</label>';
      const timeInput=document.createElement('input');
      timeInput.value=g.time||'';
      timeInput.addEventListener('change',()=>{g.time=timeInput.value;saveStateToApi(false);renderScoringTab();});
      d2.appendChild(timeInput);

      const d3=document.createElement('div');
      d3.innerHTML='<label>Field</label>';
      const fieldInput=document.createElement('input');
      fieldInput.value=g.field||'';
      fieldInput.addEventListener('change',()=>{g.field=fieldInput.value;saveStateToApi(false);});
      d3.appendChild(fieldInput);

      row.appendChild(d1);row.appendChild(d2);row.appendChild(d3);

      card.appendChild(header);
      card.appendChild(row);
      gamesListEl.appendChild(card);
    });
  }

  function renderKnockoutsUI(){
    const division=schedDivisionSelect.value;
    const sched=getScheduleForDivision(division);
    const allDivTeams=getAllTeamsForDivision(division);

    if(!sched.knockouts.length){
      sched.knockouts=[
        {id:'KO_'+division+'_S1',division,type:'Semi 1',date:'',time:'',field:'',homeId:null,awayId:null},
        {id:'KO_'+division+'_S2',division,type:'Semi 2',date:'',time:'',field:'',homeId:null,awayId:null},
        {id:'KO_'+division+'_C',division,type:'Consolation',date:'',time:'',field:'',homeId:null,awayId:null},
        {id:'KO_'+division+'_F',division,type:'Final',date:'',time:'',field:'',homeId:null,awayId:null}
      ];
    }

    knockoutsListEl.innerHTML='';
    sched.knockouts.forEach(k=>{
      const card=document.createElement('div');
      card.className='game-card';
      const header=document.createElement('div');
      header.className='game-header';
      const title=document.createElement('div');
      title.textContent=k.type;
      const meta=document.createElement('div');
      meta.className='game-meta';
      meta.textContent=`${k.date||''} â€¢ ${k.time||''} â€¢ ${k.field||''}`;
      header.appendChild(title);header.appendChild(meta);

      const row1=document.createElement('div');
      row1.className='row';
      const d1=document.createElement('div');
      d1.innerHTML='<label>Date</label>';
      const dateInput=document.createElement('input');
      dateInput.value=k.date||'';
      dateInput.addEventListener('change',()=>{k.date=dateInput.value;saveStateToApi(false);});
      d1.appendChild(dateInput);

      const d2=document.createElement('div');
      d2.innerHTML='<label>Time</label>';
      const timeInput=document.createElement('input');
      timeInput.value=k.time||'';
      timeInput.addEventListener('change',()=>{k.time=timeInput.value;saveStateToApi(false);});
      d2.appendChild(timeInput);

      const d3=document.createElement('div');
      d3.innerHTML='<label>Field</label>';
      const fieldInput=document.createElement('input');
      fieldInput.value=k.field||'';
      fieldInput.addEventListener('change',()=>{k.field=fieldInput.value;saveStateToApi(false);});
      d3.appendChild(fieldInput);

      row1.appendChild(d1);row1.appendChild(d2);row1.appendChild(d3);

      const row2=document.createElement('div');
      row2.className='row';
      const h1=document.createElement('div');
      h1.innerHTML='<label>Home</label>';
      const homeSel=document.createElement('select');
      const optHNone=document.createElement('option');
      optHNone.value='';optHNone.textContent='TBD';
      homeSel.appendChild(optHNone);
      allDivTeams.forEach(t=>{
        const o=document.createElement('option');
        o.value=t.id;o.textContent=t.teamName;
        if(String(k.homeId)===String(t.id)) o.selected=true;
        homeSel.appendChild(o);
      });
      homeSel.addEventListener('change',()=>{k.homeId=homeSel.value||null;saveStateToApi(false);});
      h1.appendChild(homeSel);

      const h2=document.createElement('div');
      h2.innerHTML='<label>Away</label>';
      const awaySel=document.createElement('select');
      const optANone=document.createElement('option');
      optANone.value='';optANone.textContent='TBD';
      awaySel.appendChild(optANone);
      allDivTeams.forEach(t=>{
        const o=document.createElement('option');
        o.value=t.id;o.textContent=t.teamName;
        if(String(k.awayId)===String(t.id)) o.selected=true;
        awaySel.appendChild(o);
      });
      awaySel.addEventListener('change',()=>{k.awayId=awaySel.value||null;saveStateToApi(false);});
      h2.appendChild(awaySel);

      row2.appendChild(h1);row2.appendChild(h2);

      card.appendChild(header);
      card.appendChild(row1);
      card.appendChild(row2);
      knockoutsListEl.appendChild(card);
    });
  }

  const scoreDivisionSelect = document.getElementById('scoreDivisionSelect');
  const scoreDateFilter     = document.getElementById('scoreDateFilter');
  const scoringContent      = document.getElementById('scoringContent');
  const scoreGameCountBadge = document.getElementById('scoreGameCountBadge');

  if (scoreDivisionSelect) {
    scoreDivisionSelect.addEventListener('change', renderScoringTab);
  }
  if (scoreDateFilter) {
    scoreDateFilter.addEventListener('input', renderScoringTab);
  }

  function renderScoringTab(){
    if (!scoreDivisionSelect || !scoringContent) return;

    const division = scoreDivisionSelect.value;
    const sched    = getScheduleForDivision(division);
    const dateTerm = (scoreDateFilter && scoreDateFilter.value || '').trim().toLowerCase();

    let games = (sched.games || []).filter(g => g.stage === 'pool');

    if (dateTerm){
      games = games.filter(g => (g.date || '').toLowerCase().includes(dateTerm));
    }

    const total = games.length;
    if (scoreGameCountBadge){
      scoreGameCountBadge.textContent = total
        ? `${total} Game${total !== 1 ? 's' : ''}`
        : 'No games';
    }

    scoringContent.innerHTML = '';
    if (!games.length){
      scoringContent.innerHTML = '<div class="empty-note">No pool-play games match these filters.</div>';
      return;
    }

    const poolsById = {};
    adminState.pools.forEach(p => { poolsById[p.id] = p; });

    games.forEach(g => {
      const home = getTeamByIdAll(g.homeId);
      const away = getTeamByIdAll(g.awayId);
      const poolName = poolsById[g.poolId]?.name || 'Unassigned';

      let homeInput, awayInput;

      const card   = document.createElement('div');
      card.className = 'score-game-card';

      // Header
      const header = document.createElement('div');
      header.className = 'score-game-header';

      const headerRow = document.createElement('div');
      headerRow.className = 'score-game-header-row';

      const title = document.createElement('div');
      title.className = 'score-game-title';
      title.textContent = `${home ? home.teamName : 'TBD'} vs ${away ? away.teamName : 'TBD'}`;

      const actions = document.createElement('div');
      actions.className = 'score-game-header-actions';

      const clearBtn = document.createElement('button');
      clearBtn.type = 'button';
      clearBtn.className = 'score-clear-btn';
      clearBtn.textContent = 'Ã—';
      clearBtn.addEventListener('click', () => {
        delete adminState.scores[g.id];
        if (homeInput) homeInput.value = '';
        if (awayInput) awayInput.value = '';
        saveScoresOnly();
      });

      actions.appendChild(clearBtn);
      headerRow.appendChild(title);
      headerRow.appendChild(actions);

      const meta = document.createElement('div');
      meta.className = 'score-game-meta';
      meta.textContent = `${g.date || ''} â€¢ ${g.time || ''} â€¢ ${g.field || ''} â€¢ ${poolName}`;

      header.appendChild(headerRow);
      header.appendChild(meta);

      // Body
      const body = document.createElement('div');
      body.className = 'score-game-body';

      const scoreRow = document.createElement('div');
      scoreRow.className = 'score-input-row';

      const sData = adminState.scores[g.id] || {};

      const homeGroup = document.createElement('div');
      homeGroup.className = 'score-input-group';
      const homeLabel = document.createElement('label');
      homeLabel.textContent = `Home score (${home ? home.teamName : 'Team 1'})`;
      homeInput = document.createElement('input');
      homeInput.type = 'number';
      homeInput.min = '0';
      homeInput.className = 'score-input-box';
      homeInput.value = (sData.home != null) ? sData.home : '';
      homeInput.addEventListener('input', () => {
        const val = homeInput.value === '' ? null : Number(homeInput.value);
        if (!adminState.scores[g.id]) adminState.scores[g.id] = {};
        adminState.scores[g.id].home = val;
      });
      homeGroup.appendChild(homeLabel);
      homeGroup.appendChild(homeInput);

      const awayGroup = document.createElement('div');
      awayGroup.className = 'score-input-group';
      const awayLabel = document.createElement('label');
      awayLabel.textContent = `Away score (${away ? away.teamName : 'Team 2'})`;
      awayInput = document.createElement('input');
      awayInput.type = 'number';
      awayInput.min = '0';
      awayInput.className = 'score-input-box';
      awayInput.value = (sData.away != null) ? sData.away : '';
      awayInput.addEventListener('input', () => {
        const val = awayInput.value === '' ? null : Number(awayInput.value);
        if (!adminState.scores[g.id]) adminState.scores[g.id] = {};
        adminState.scores[g.id].away = val;
      });
      awayGroup.appendChild(awayLabel);
      awayGroup.appendChild(awayInput);

      scoreRow.appendChild(homeGroup);
      scoreRow.appendChild(awayGroup);

      const saveBtn = document.createElement('button');
      saveBtn.type = 'button';
      saveBtn.className = 'score-save-btn';
      saveBtn.textContent = 'Save Score';
      saveBtn.addEventListener('click', () => {
        saveScoresOnly();
      });

      body.appendChild(scoreRow);
      body.appendChild(saveBtn);

      card.appendChild(header);
      card.appendChild(body);
      scoringContent.appendChild(card);
    });
  }

</script>
</body>
</html>

